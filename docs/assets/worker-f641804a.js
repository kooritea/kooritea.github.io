(function(){"use strict";function v(r){return Math.floor(r)===r}function d(r){var e={times:1,num:0};if(v(r))return e.num=r,e;var t=r+"",a=t.indexOf("."),s=t.substr(a+1).length,c=Math.pow(10,s),n=parseInt(r*c+.5,10);return e.times=c,e.num=n,e}function u(r,e,t){var a=d(r),s=d(e),c=a.num,n=s.num,o=a.times,f=s.times,p=o>f?o:f,i=null;switch(t){case"add":return o===f?i=c+n:o>f?i=c+n*(o/f):i=c*(f/o)+n,i/p;case"subtract":return o===f?i=c-n:o>f?i=c-n*(o/f):i=c*(f/o)-n,i/p;case"multiply":return i=c*n/(o*f),i;case"divide":return i=c/n*(f/o),i}}function y(r,e){if(typeof r!="number"||typeof e!="number")throw new Error("args error");return u(r,e,"add")}function D(r,e){if(typeof r!="number"||typeof e!="number")throw new Error("args error");return u(r,e,"subtract")}function b(r,e){if(typeof r!="number"||typeof e!="number")throw new Error("args error");return u(r,e,"multiply")}function P(r,e){if(typeof r!="number"||typeof e!="number")throw new Error("args error");return u(r,e,"divide")}var l={add:y,subtract:D,multiply:b,divide:P};let m=0;function w(r,e,t={}){let a;for(let s=Math.max(1,t.startSearchSize??1);s<=(t.maxSearchSize||r.height);s++){const c=M(r,e,s,t);if(a)a.matchPerc<c.matchPerc&&(a={...c,offset:s});else{a={...c,offset:s};continue}const n=Date.now();n>m+1e3&&(m=n,self.postMessage({code:"progress",data:Number((t._progressCompleteLine/t._progressAllLine*100).toFixed(2))}))}return a}function M(r,e,t,a={}){const s=[];for(let n=0;n<t;n++)if(a.sort==="desc"){const o=r.colorData[e.colorData.length-t+n],f=e.colorData[n];s.push(h(o,f,a))}else{const o=r.colorData[n],f=e.colorData[e.colorData.length-t+n];s.push(h(o,f,a))}const{matchPerc:c}=g(s);return{matchPerc:c}}function h(r,e,t={}){const a=r.map((c,n)=>x(r[n],e[n],t)),{matchPerc:s}=g(a);return t._progressCompleteLine++,{matchPerc:s}}function x(r,e,t={pointDiffType:"gray"}){if(t.pointDiffType==="rgb"){const a=(r[0]+e[0])/2,s=r[0]-e[0],c=r[1]-e[1],n=r[2]-e[2],o=Math.sqrt((2+a/256)*s**2+4*c**2+(2+(255-a)/256)*n**2);return{colorDistance:o,matchPerc:l.subtract(100,Number((o/764*100).toFixed(2)))}}if(t.pointDiffType==="gray")return{matchPerc:l.subtract(100,Number((Math.abs(r[4]-e[4])/255*100).toFixed()))};if(t.pointDiffType==="otsu")return{matchPerc:r[4]===e[4]?100:0}}function g(r){const e=r.reduce((t,a)=>l.add(t,a.matchPerc),0);return{matchPerc:Number((e/(100*r.length)*100).toFixed(2))}}self.addEventListener("message",function(r){const e=r.data;switch(e.cmd){case"getMaxMatchOffset":{const t=e.data.options;t._progressCompleteLine=0;const a=e.data.image1[t.direction==="vertical"?"height":"width"],s=a*(1+a)/2;t._progressAllLine=s,self.postMessage({code:"result",data:w(e.data.image1,e.data.image2,t)});break}default:self.postMessage({code:"Unknow Cmd: "+e.cmd})}},!1)})();
