import{P as M}from"./PageHeader-3693671b.js";import{I as W}from"./ImageCon-f5088329.js";import{f as O}from"./float-7d62ecbe.js";import{_ as $,a8 as F}from"./index-dc36599c.js";import{cg as h,aR as L,aS as j,bD as m,bx as A,aT as w,cY as R,cZ as U}from"./vendor-cce75f21.js";import"./element-plus-40a28a03.js";import"./highlightjs-4914df6f.js";const B=(r,e)=>r.reduce((t,o)=>(t[e.indexOf(o)]+=1,t),[...Array(e.length)].fill(0)),I=(r,e,t)=>{let o=0;for(let i=e;i<t;i+=1)o+=r[i];return o},E=r=>Array.from(new Set(r)).sort((e,t)=>e-t),x=(r,e,t,o)=>{let i=0;for(let c=e;c<t;c+=1)i+=r[c];return i/o},D=(r,e,t,o,i)=>{let c=0;for(let n=t;n<o;n+=1)c+=r[n]*e[n];return c*i},S=(r,e,t,o,i,c)=>{let n=0;for(let s=t;s<o;s+=1){const a=e[s]-i;n+=a*a*r[s]}return n*c},q=(r,e,t,o)=>r*e+t*o;function z(r){const e=r.map(n=>n.map(s=>s[4]).flat(1)).flat(1),t=E(e),o=B(e,t),{length:i}=e,c=[...Array(t.length)].map((n,s)=>{const l=s,u=s,g=o.length,f=1/I(o,0,l),d=1/I(o,u,g),_=x(o,0,l,i),b=S(o,t,0,l,D(o,t,0,l,f),f),V=x(o,u,g,i),C=S(o,t,u,g,D(o,t,u,g,d),d),k=q(_,b,V,C);return isNaN(k)?Number.POSITIVE_INFINITY:k});return t[c.indexOf(Math.min(...c))]}const y=[],v=[];function H(r){let e=y.find(t=>t.WorkerConstructor===r&&!t.running);return!e&&y.length<navigator.hardwareConcurrency-1&&(e={WorkerConstructor:r,worker:new r,running:!1},y.push(e)),e}function T(){if(v.length>0){const r=H(v[0].WorkerConstructor);if(r){const e=v.shift(),t=r.worker;r.running=!0,t.onmessage=function(i){switch(i.data.code){case"result":{e.resolve(i.data.data),r.running=!1,T();break}case"progress":{e.args.progress&&e.args.progress(i.data.data);break}default:e.reject("Unknow Result Code: "+i.data.code)}};const o={...e.args};delete o.progress,t.postMessage(o)}}}function P(r,e){return new Promise((t,o)=>{v.push({WorkerConstructor:r,resolve:t,reject:o,args:e}),T()})}const G=Object.freeze(Object.defineProperty({__proto__:null,addTask:P},Symbol.toStringTag,{value:"Module"}));function N(){return new Worker("https://kooritea.moe/assets/worker-bd16f2c8.js")}function Y(r,e,t){return r*6966+e*23436+t*2366>>15}async function Z(r,e="vertical"){return new Promise((t,o)=>{const i=document.createElement("canvas"),c=i.getContext("2d"),n=new Image;n.onload=async()=>{i.width=n.width,i.height=n.height,c.drawImage(n,0,0,n.width,n.height,0,0,n.width,n.height);const s=e==="vertical",a=c.getImageData(0,0,n.width,n.height),l=[];let u=-1,g=-1;for(let d=0;d<a.data.length;){u++,(l.length===0||l[l.length-1].length===n[s?"width":"height"])&&(l.push([]),g++,u=-1);const _=l[l.length-1],b=Y(a.data[d],a.data[d+1],a.data[d+2]);_.push([a.data[d],a.data[d+1],a.data[d+2],a.data[d+3],b,"",[u,g]]),d+=4}const f=z(l);for(const d in l)for(u in l[d])l[d][u][5]=f>l[d][u][4]?"rgba(0,0,0,255)":"rgba(255,255,255,255)";t({height:n.height,width:n.width,otsuThresholdValue:f,colorData:l})},n.src=r instanceof File?URL.createObjectURL(r):r})}function p(r,e,t,o={}){for(const i in e){const c=e[i];for(const n in c){const s=c[n];o.thresholdValue!==void 0?r.fillStyle=o.thresholdValue>s[4]?"rgba(0,0,0,255)":"rgba(255,255,255,255)":r.fillStyle=`rgba(${s[0]},${s[1]},${s[2]},${s[3]})`,r.fillRect(n,t+Number(i),1,1)}}}async function J(r,e={}){e={...e,direction:e.direction??"vertical",pointDiffType:e.pointDiffType??"gray",sort:e.sort??"desc",skipLine:e.skipLine??10};const t=await Promise.all(r.map(n=>Z(n,e.direction))),o=new Array(t.length-1).fill(0);let i=null;e.progress&&(i=setInterval(()=>{const n=o.reduce((s,a)=>O.add(s,a),0);e.progress(Number((n/o.length).toFixed(2)))},1e3));const c=(await Promise.all(t.slice(0,t.length-1).map((n,s)=>P(N,{cmd:"getMaxMatchOffset",data:{image1:t[s],image2:t[s+1],options:{direction:e.direction,pointDiffType:e.pointDiffType,sort:e.sort}},progress:a=>{o[s]=a}})))).map(n=>n.offset);if(i&&clearInterval(i),e.canvas){const n=e.canvas.getContext("2d");if(e.direction==="vertical"?(e.canvas.width=t[0].width,e.canvas.height=t.reduce((s,a)=>s+a.height,0)-c.reduce((s,a)=>s+a,0)):(e.canvas.width=t.reduce((s,a)=>s+a.width,0)-c.reduce((s,a)=>s+a,0),e.canvas.height=t[0].height),e.sort==="desc"){let s=0;for(let a=0;a<c.length;a++){const l=c[a];a===0&&(p(n,t[a].colorData,s),s=s+t[a].height),p(n,t[a+1].colorData.slice(l-e.skipLine),s-e.skipLine),s=s+t[a+1].height-l}}else{let s=e.canvas.height;for(let a=0;a<c.length;a++){const l=c[a];a===0&&(s=s-t[a].height,p(n,t[a].colorData,s)),s=s-t[a+1].height+l,p(n,t[a+1].colorData.slice(0,t[a+1].colorData.length-l+e.skipLine),s)}}}}window.WorkerManager=G;window.DiffWorker=N;const K={components:{PageHeader:M,ImageCon:W},data(){return{progress:0,progressStatus:"",formConfig:{labelPosition:"top"},formData:{},fields:[{type:"radio",prop:"pointDiffType",label:"对比方法",required:!0,defaultValue:()=>"gray",options:()=>[{label:"灰度值(推荐，兼顾速度和准确性)",value:"gray"},{label:"色差(速度较慢)",value:"rgb"}]},{type:"radio",prop:"direction",label:"截图方向",afterSlotName:"direction-example",required:!0,defaultValue:()=>"vertical-desc",options:[{label:"从上到下",value:"vertical-desc"},{label:"从下到上",value:"vertical-asc"},{label:"从左到右(开发中)",value:"horizontal-desc",disabled:!0},{label:"从右到左(开发中)",value:"horizontal-asc",disabled:!0}]},{type:"upload",prop:"images",label:"截图",required:!0,formProps:{listType:"picture-card"},defaultValue:()=>[],rules:[{required:!0,trigger:"submit",validator:(r,e,t)=>{e.length>1?t():t("最少需要两张截图")}}]}],buttons:[{type:"primary",label:"合成",handler:(r,e)=>r.formInstance.submitForm().then(t=>{const[o,i]=t.direction.split("-");return this.progress=0,this.progressStatus="",this.$refs.result.width=0,this.$refs.result.height=0,J(t.images.map(c=>c.raw),{direction:o,pointDiffType:t.pointDiffType,sort:i,canvas:this.$refs.result,progress:c=>{this.progress=c}}).then(()=>{this.progressStatus="success"}).catch(c=>{throw this.progressStatus="exception",c})})},{type:"success",label:"下载",show:()=>this.progressStatus==="success",handler:(r,e)=>new Promise(t=>{this.$refs.result.toBlob(i=>{F(i,`${this.getMergeFileName(this.formData.images.map(c=>c.raw))}.png`),t()})})}]}},methods:{getMergeFileName(r){let e="";for(let t=0;t<r[0].name.length&&!r.some(o=>o.name[t]!==r[0].name[t]);t++)e+=r[0].name[t];return`${e}${["-","_"].includes(e[e.length-1])?"":"-"}merge`}}},Q=r=>(R("data-v-421ed245"),r=r(),U(),r),X={class:"page"},ee={class:"direction-example"},te=Q(()=>w("span",null,"示例：",-1)),re={style:{"margin-top":"24px"}},se={ref:"result",style:{width:"100%","margin-top":"24px"}};function ae(r,e,t,o,i,c){const n=h("PageHeader"),s=h("ImageCon"),a=h("EasyForm"),l=h("el-progress");return L(),j("div",X,[m(n),m(a,{modelValue:i.formData,"onUpdate:modelValue":e[0]||(e[0]=u=>i.formData=u),fields:i.fields,buttons:i.buttons,"form-config":i.formConfig},{"direction-example":A(u=>[w("div",ee,[te,m(s,{src:`/assets/image-merge-${u.formData[u.field.prop]}-example.png`},null,8,["src"])])]),_:1},8,["modelValue","fields","buttons","form-config"]),w("div",re,[m(l,{percentage:i.progress,"text-inside":!0,"stroke-width":24,status:i.progressStatus},null,8,["percentage","status"]),w("canvas",se,null,512)])])}const ge=$(K,[["render",ae],["__scopeId","data-v-421ed245"]]);export{ge as default};
