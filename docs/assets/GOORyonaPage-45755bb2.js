import{P as v}from"./PageHeader-fae83d47.js";import{_ as g,L as w,Z as C,$ as V,a0 as P,M as k,a1 as D}from"./index-5f80d402.js";import{cd as s,aR as u,bz as f,bY as B,bA as p,aT as b,bG as m,bD as h,bF as y,aS as S}from"./vendor-5d98ec45.js";import"./element-plus-2fbd5573.js";import"./highlightjs-4914df6f.js";const I={components:{LoadingIcon:w},props:{modelValue:{type:[String,Array],default:void 0},checkMode:{type:String,default:()=>""}},emits:["update:modelValue"],data(){return{loading:!1,tableData:[],currentPath:"/"}},created(){this.load(this.currentPath)},methods:{onCellClick(e,o,t,a){o.property==="name"&&(e.type==="dir"?this.load(e.path):e.type==="file"&&this.$emit("update:modelValue",e.path))},onSelectionChange(){},load(e){this.loading=!0,this.loader(e).then(o=>{this.tableData=[...o].sort((t,a)=>{const r=t.type.localeCompare(a.type);return r!==0?r:t.name.localeCompare(a.name)}),e!=="/"&&this.tableData.unshift({type:"dir",name:"..",path:e.slice(0,e.slice(0,e.length-1).lastIndexOf("/"))||"/"}),this.currentPath=e}).finally(()=>{this.loading=!1})},loader(){throw new Error("loader需实现")}}};function M(e,o,t,a,r,i){const d=s("LoadingIcon"),c=s("el-table-column"),_=s("el-radio"),n=s("el-table");return u(),f(n,{border:"",data:r.tableData,style:{width:"100%"},onCellClick:i.onCellClick,onSelectionChange:i.onSelectionChange},B({default:p(()=>[t.checkMode==="multiple"?(u(),f(c,{key:0,type:"selection",selectable:l=>l.type==="file"},null,8,["selectable"])):h("",!0),t.checkMode==="single"?(u(),f(c,{key:1,width:"40px"},{default:p(l=>[l.row.path===t.modelValue?(u(),f(_,{key:0,value:l.row.path},null,8,["value"])):h("",!0)]),_:1})):h("",!0),m(c,{"class-name":"filename-cell","show-overflow-tooltip":"",prop:"name",label:"文件名"},{default:p(l=>[b("span",null,y(l.row.type==="dir"?"📁":"📄")+y(l.row.name),1)]),_:1})]),_:2},[r.loading?{name:"empty",fn:p(()=>[b("div",null,[m(d)])]),key:"0"}:void 0]),1032,["data","onCellClick","onSelectionChange"])}const x=g(I,[["render",M]]);const O={extends:x,methods:{loader(e){return C(e).then(o=>o.children.map(t=>({name:t.name,type:t.type,path:t.path})))}}},L=g(O,[["__scopeId","data-v-3d3b6252"]]);const T={components:{PageHeader:v,MediaBrowser:L},data(){return{previewStore:{},formConfig:{labelPosition:"top"},bangumiOptions:[],formData:{},fields:[{type:"select",prop:"bid",label:"Bangumi Id",formProps:{remote:!0,filterable:!0,remoteMethod:e=>{e&&V(e).then(o=>{this.bangumiOptions=o.map(t=>({label:t.nname||t.nname,subLabel:t.name,value:t.subject}))})}},options:()=>this.bangumiOptions,required:!0},{type:"number",prop:"ep",label:"集数",formProps:{min:1},defaultValue:()=>1,required:!0},{type:"slot",prop:"sourcePath",slotName:"fileBrowser",label:"文件",required:!0},{type:"time-picker",prop:"start",label:"开始时间",afterSlotName:"preview",buttons:[{type:"primary",label:"获取截图",handler:e=>{this.getScreenshots(e.formData.sourcePath,e.field.prop)}}],required:!0,defaultValue:()=>"00:00:00"},{type:"time-picker",prop:"end",label:"结束时间",afterSlotName:"preview",buttons:[{type:"primary",label:"获取截图",handler:e=>{this.getScreenshots(e.formData.sourcePath,e.field.prop)}}],required:!0,defaultValue:()=>"00:00:00"},{type:"select",prop:"tag",valueSplitChar:",",formProps:{multiple:!0,filterable:!0,allowCreate:!0},optionsBaseCode:"VIDEO_TAG",label:"标签"},{type:"time-picker",prop:"thumbnail",afterSlotName:"preview",formProps:{multiple:!0},label:"封面",rules:e=>[{validator:(o,t,a)=>{const r=this.timeStringToSeconds(t),i=this.timeStringToSeconds(e.formData.start),d=this.timeStringToSeconds(e.formData.end);r===0?a():r<i?a(`封面时间[${r}]不能小于开始时间[${i}]`):r>d?a(`封面时间[${r}]不能大于结束时间[${d}]`):a()},trigger:"submit"}],buttons:[{type:"primary",label:"获取截图",handler:e=>{this.getScreenshots(e.formData.sourcePath,e.field.prop)}}],defaultValue:()=>"00:00:00"},{type:"number",prop:"previews",formProps:{multiple:!0},label:"预览图"}],buttons:[{type:"primary",label:"提交",handler:(e,o)=>{e.formInstance.submitForm().then(t=>{const a=this.timeStringToSeconds(t.start);let r=this.timeStringToSeconds(t.thumbnail);return r&&(r=Math.max(r-a,0)),P({...t,thumbnail:r}).then(()=>{k.success("提交成功，等待渲染和批准"),e.formInstance.resetFormData(),this.previewStore={}})})}}]}},methods:{timeStringToSeconds(e){const o=e.split(":"),t=parseInt(o[0],10),a=parseInt(o[1],10),r=parseInt(o[2],10);return t*3600+a*60+r},getScreenshots(e,o){D(e,this.formData[o]).then(t=>{this.previewStore[o]&&URL.revokeObjectURL(this.previewStore[o]),this.previewStore[o]=URL.createObjectURL(t)})}}},N={class:"page"},R={class:"preview-box"},U=["src","onClick"];function q(e,o,t,a,r,i){const d=s("PageHeader"),c=s("MediaBrowser"),_=s("EasyForm");return u(),S("div",N,[m(d),m(_,{modelValue:r.formData,"onUpdate:modelValue":o[0]||(o[0]=n=>r.formData=n),fields:r.fields,buttons:r.buttons,"form-config":r.formConfig},{fileBrowser:p(n=>[m(c,{modelValue:n.formData[n.field.prop],"onUpdate:modelValue":l=>n.formData[n.field.prop]=l,checkMode:"single"},null,8,["modelValue","onUpdate:modelValue"])]),preview:p(n=>[b("div",R,[r.previewStore[n.field.prop]?(u(),S("img",{key:0,class:"image",src:r.previewStore[n.field.prop],onClick:l=>e.$imagePreview(r.previewStore[n.field.prop])},null,8,U)):h("",!0)])]),_:1},8,["modelValue","fields","buttons","form-config"])])}const A=g(T,[["render",q],["__scopeId","data-v-c22bd08f"]]);export{A as default};
