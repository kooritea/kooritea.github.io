import{P as U}from"./PageHeader-26c7d55f.js";import{I as D}from"./ImageCon-63ba86d8.js";import{M as T,P as $}from"./MediaBrowser-0f83ac17.js";import{_ as C,u as L,Z as w,M,a8 as F,a5 as y,a9 as O}from"./index-c031f2a1.js";import{cg as g,aR as B,aS as N,bD as f,bx as v,aT as b,cY as z,cZ as R}from"./vendor-a6581121.js";import"./element-plus-5d967f66.js";import"./highlightjs-4914df6f.js";const V=[],x=[];function A(e){let t=V.find(r=>r.WorkerConstructor===e&&!r.running);return!t&&V.length<navigator.hardwareConcurrency-1&&(t={WorkerConstructor:e,worker:new e,running:!1},V.push(t)),t}function S(){if(x.length>0){const e=A(x[0].WorkerConstructor);if(e){const t=x.shift(),r=e.worker;e.running=!0,r.onmessage=function(s){switch(s.data.code){case"result":{t.resolve(s.data.data),e.running=!1,S();break}case"progress":{t.args.progress&&t.args.progress(s.data.data);break}default:t.reject("Unknow Result Code: "+s.data.code)}};const m={...t.args};delete m.progress,r.postMessage(m)}}}function E(e,t){return new Promise((r,m)=>{x.push({WorkerConstructor:e,resolve:r,reject:m,args:t}),S()})}function W(){return new Worker("https://kooritea.moe/assets/worker-36f42bcb.js")}async function I(e,t){return new Promise((r,m)=>{const s=document.createElement("canvas"),u=s.getContext("2d"),o=new Image;o.onload=async()=>{try{s.width=o.width*t.zoom,s.height=o.height*t.zoom,u.drawImage(o,0,0,o.width,o.height,0,0,s.width,s.height);const l=u.getImageData(0,0,s.width,s.height).data;r({height:s.height,width:s.width,imageData:l})}catch(l){m(l)}},o.src=e instanceof File?URL.createObjectURL(e):e})}function _(e,t,r,m,s=[]){const{imageData:u,width:o,height:l}=t,[d=0,c=m==="vertical"?l:o]=s;if(m==="vertical")for(let a=d*o;a<c*o;a++){const i=a*4;e.fillStyle=`rgba(${u[i]},${u[i+1]},${u[i+2]},${u[i+3]})`,e.fillRect(a%o,r+parseInt(a/o),1,1)}}async function H(e,t={}){t={...t,direction:t.direction??"vertical",pointDiffType:t.pointDiffType??"gray",sort:t.sort??"desc",skipLine:t.skipLine??10,zoom:t.zoom??.5};const r=await Promise.all(e.map(l=>I(l,t)));if(Array.from(new Set(r.map(l=>l[t.direction==="vertical"?"width":"height"]))).length>1)throw new Error(`拼接方向为${t.direction==="vertical"?"纵向":"横向"}时所有图片的${t.direction==="vertical"?"宽度":"长度"}必须一致`);const m=r.slice(0,r.length-1).reduce((l,d,c)=>{const a=t.direction==="vertical"?"height":"width",i=Math.min(d[a],r[c+1][a]),h=i*(1+i)/2;return l+h},0);let s=0,u=0;const o=(await Promise.all(r.slice(0,r.length-1).map((l,d)=>E(W,{cmd:"getMaxMatchOffset",data:{image1:r[d],image2:r[d+1],options:{direction:t.direction,pointDiffType:t.pointDiffType,sort:t.sort}},progress:c=>{if(t.progress){s+=c;const a=Date.now();a>u+1e3&&(u=a,t.progress(Number((s/m*100).toFixed(2))))}}})))).map(l=>l.offset/t.zoom);return t.progress&&t.progress(100),{async render(l){let d=r;t.zoom!==1&&(d=await Promise.all(e.map(a=>I(a,{...t,zoom:1}))));const c=l.getContext("2d");if(t.direction==="vertical"?(l.width=d[0].width,l.height=d.reduce((a,i)=>a+i.height,0)-o.reduce((a,i)=>a+i,0)):(l.width=d.reduce((a,i)=>a+i.width,0)-o.reduce((a,i)=>a+i,0),l.height=d[0].height),t.sort==="desc"){let a=0;for(let i=0;i<o.length;i++){const h=o[i];i===0&&(_(c,d[i],a,t.direction),a=a+d[i].height),a=a-h,_(c,d[i+1],a,t.direction,[h-t.skipLine]),a=a+d[i+1].height}}else{let a=l.height;for(let i=0;i<o.length;i++){const h=o[i];i===0&&(a=a-d[i].height,_(c,d[i],a,t.direction)),a=a-d[i+1].height+h,_(c,d[i+1],a,t.direction,[0,d[i+1][t.direction==="vertical"?"height":"width"]-h+t.skipLine])}}}}}const j={components:{PageHeader:U,ImageCon:D,MediaBrowser:T,PreviewScreenshots:$},setup(){const{isGreatOldOne:e}=L();return{isGreatOldOne:e}},data(){return{progress:0,progressStatus:"",startTime:0,endTime:0,canAutoUpdateEnd:!0,formConfig:{labelPosition:"top"},formData:{},fields:[{type:"radio",prop:"pointDiffType",label:"对比方法",required:!0,defaultValue:()=>"gray",options:()=>[{label:"灰度值(推荐，兼顾速度和准确性)",value:"gray"},{label:"色差(速度较慢)",value:"rgb"}]},{type:"switch",label:"使用在线视频",prop:"isUseOnlineVideo",showInForm:()=>this.isGreatOldOne,defaultValue:()=>!1},{type:"slot",prop:"sourcePath",slotName:"fileBrowser",label:"文件",showInForm:e=>e.formData.isUseOnlineVideo===!0},{type:"slot",slotName:"tsSelector",needAutoUpdateTime:!0,prop:"start",label:"开始时间",afterSlotName:"screenshots",defaultValue:()=>"00:00:00.0",onChange:(e,t,r)=>{r&&(this.needUpdatePreviewVideoSrc=!0,this.canAutoUpdateEnd&&(e.formData.end=e.formData.start))},showInForm:e=>e.formData.isUseOnlineVideo===!0},{type:"slot",slotName:"tsSelector",prop:"end",label:"结束时间",afterSlotName:"screenshots",defaultValue:()=>"00:00:00.0",onChange:(e,t,r)=>{r&&(this.canAutoUpdateEnd=!1)},showInForm:e=>e.formData.isUseOnlineVideo===!0},{type:"number",prop:"splitCount",label:"分割数量",formProps:{type:"number",min:2},defaultValue:()=>Math.min(10,Math.max(2,navigator.hardwareConcurrency-1)),showInForm:e=>e.formData.isUseOnlineVideo===!0},{type:"upload",prop:"images",label:"截图",required:!0,formProps:{listType:"picture-card",multiple:!0},defaultValue:()=>[],rules:[{required:!0,trigger:"submit",validator:(e,t,r)=>{t.length>1?r():r("最少需要两张截图")}}],buttons:[{type:"primary",label:"从视频源生成预览图",show:e=>e.formData.isUseOnlineVideo===!0,handler:e=>this.generateScreenshots(e.formData,"jpg")},{type:"primary",label:"从视频源生成原图",show:e=>e.formData.isUseOnlineVideo===!0,handler:e=>this.generateScreenshots(e.formData,"png")}]},{type:"radio",prop:"direction",label:"截图方向",afterSlotName:"direction-example",required:!0,defaultValue:()=>"vertical-desc",options:[{label:"从上到下",value:"vertical-desc"},{label:"从下到上",value:"vertical-asc"},{label:"从左到右(开发中)",value:"horizontal-desc",disabled:!0},{label:"从右到左(开发中)",value:"horizontal-asc",disabled:!0}]},{type:"number",prop:"skipLine",label:"裁剪边缘",tips:"渲染时去除图像边缘的距离，一定程度上可以去除图像边缘颜色变化的影响。",formProps:{type:"number",min:0},defaultValue:()=>10},{type:"radio",prop:"zoom",label:"采样率",tips:"采样率越低，效率越高，采样率过低可能会导致结果不准确。",options:[{label:"10%",value:10},{label:"25%",value:25},{label:"50%",value:50},{label:"75%",value:75},{label:"100%",value:100}],defaultValue:()=>50},{type:"view",prop:"text",hiddenLabel:!0,viewer:()=>`可用线程数: ${navigator.hardwareConcurrency}`}],buttons:[{type:"primary",label:"合成",handler:(e,t)=>e.formInstance.submitForm().then(r=>{const[m,s]=r.direction.split("-");return this.startTime=Date.now(),this.endTime=0,this.progress=0,this.progressStatus="",this.$refs.result.width=0,this.$refs.result.height=0,H(r.images.map(u=>u.raw),{direction:m,pointDiffType:r.pointDiffType,sort:s,skipLine:r.skipLine,zoom:w.divide(r.zoom,100),progress:u=>{this.progress=u}}).then(({render:u})=>new Promise(o=>{this.endTime=Date.now(),setTimeout(()=>{o(u(this.$refs.result).then(()=>{this.progressStatus="success"}))},1e3)})).catch(u=>{throw this.progressStatus="exception",M.error(u==null?void 0:u.message),u})})},{type:"success",label:"下载",show:()=>this.progressStatus==="success",handler:(e,t)=>new Promise(r=>{this.$refs.result.toBlob(s=>{F(s,`${this.getMergeFileName(this.formData.images.map(u=>u.raw))}.png`),r()})})}]}},methods:{getMergeFileName(e){let t="";for(let r=0;r<e[0].name.length&&!e.some(m=>m.name[r]!==e[0].name[r]);r++)t+=e[0].name[r];return`${t}${["-","_"].includes(t[t.length-1])?"":"-"}merge`},async generateScreenshots(e,t){if(!e.sourcePath){this.$msgBox.warning("请先选择视频源");return}if(!e.start){this.$msgBox.warning("请先选择开始时间");return}if(e.end){const o=y(e.end),l=y(e.start);if(o<=l){this.$msgBox.warning(`结束时间[${o}]不能小于等于开始时间[${l}]`);return}}else{this.$msgBox.warning("请先选择结束时间");return}if(e.splitCount<2){this.$msgBox.warning("分割数量必须大于1");return}const r=y(e.start),m=y(e.end),s=w.divide(w.subtract(m,r),e.splitCount-1),u=new Array(e.splitCount-1).fill(null).map((o,l)=>Number(w.add(r,w.multiply(l,s)).toFixed(2)));u.push(m),e.images=[];for(let o=0;o<u.length;o++){const l=u[o],d=await O(e.sourcePath,l,t),c=`image-${o}.${t}`;e.images.push({name:c,raw:new File([d],c,{type:d.type}),status:"ready",percentage:0,size:d.size,url:URL.createObjectURL(d)})}},previewResult(){this.$refs.result.toBlob(e=>{const t=`${this.getMergeFileName(this.formData.images.map(r=>r.raw))}.png`;this.$imagePreview(URL.createObjectURL(e),{fileName:t})})}}},k=e=>(z("data-v-d04cc500"),e=e(),R(),e),q={class:"page"},G={class:"direction-example"},Z=k(()=>b("span",null,"示例：",-1)),Y=k(()=>b("span",null,".",-1)),J={style:{"margin-top":"24px"}};function K(e,t,r,m,s,u){const o=g("PageHeader"),l=g("ImageCon"),d=g("MediaBrowser"),c=g("el-time-picker"),a=g("el-input-number"),i=g("PreviewScreenshots"),h=g("EasyForm"),P=g("el-progress");return B(),N("div",q,[f(o),f(h,{modelValue:s.formData,"onUpdate:modelValue":t[0]||(t[0]=n=>s.formData=n),fields:s.fields,buttons:s.buttons,"form-config":s.formConfig},{"direction-example":v(n=>[b("div",G,[Z,f(l,{src:`/assets/image-merge-${n.formData[n.field.prop]}-example.png`},null,8,["src"])])]),fileBrowser:v(n=>[f(d,{modelValue:n.formData[n.field.prop],"onUpdate:modelValue":p=>n.formData[n.field.prop]=p,checkMode:"single"},null,8,["modelValue","onUpdate:modelValue"])]),tsSelector:v(n=>[f(c,{"model-value":n.formData[n.field.prop].split(".")[0],"value-format":"HH:mm:ss",format:"HH:mm:ss",style:{width:"120px"},"onUpdate:modelValue":p=>{n.formData[n.field.prop]=`${p||"00:00:00"}.${n.formData[n.field.prop].split(".")[1]}`,n.field.onChange(n,p,!0)}},null,8,["model-value","onUpdate:modelValue"]),Y,f(a,{"model-value":Number("0."+n.formData[n.field.prop].split(".")[1]),min:0,max:1,precision:3,step:.1,style:{width:"120px"},"onUpdate:modelValue":p=>{n.formData[n.field.prop]=`${n.formData[n.field.prop].split(".")[0]}.${String(p).split(".")[1]||0}`,n.field.onChange(n,p,!0)}},null,8,["model-value","step","onUpdate:modelValue"])]),screenshots:v(n=>[f(i,{modelValue:n.formData[n.field.prop],sourcePath:n.formData.sourcePath,"onUpdate:modelValue":p=>{n.formData[n.field.prop]=p,n.field.onChange(n,p,!0)}},null,8,["modelValue","sourcePath","onUpdate:modelValue"])]),_:1},8,["modelValue","fields","buttons","form-config"]),b("div",J,[f(P,{percentage:s.progress,"text-inside":!0,"stroke-width":24,status:s.progressStatus,format:n=>!s.progressStatus&&n===100?`成功，用时: ${((s.endTime-s.startTime)/1e3).toFixed(1)}s，canvas渲染结果中`:s.progressStatus==="success"?`成功，用时: ${((s.endTime-s.startTime)/1e3).toFixed(1)}s`:`${n}%`},null,8,["percentage","status","format"]),b("canvas",{ref:"result",style:{width:"100%","margin-top":"24px",cursor:"pointer"},onClick:t[1]||(t[1]=()=>{u.previewResult()})},null,512)])])}const ne=C(j,[["render",K],["__scopeId","data-v-d04cc500"]]);export{ne as default};
