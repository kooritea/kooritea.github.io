import{P as V}from"./PageHeader-d41a7d4f.js";import{I as W}from"./ImageCon-a1f4ba69.js";import{f as O}from"./float-7d62ecbe.js";import{_ as $,M as F,a8 as L}from"./index-d2c6dfce.js";import{cg as f,aR as A,aS as B,bD as d,bx as R,aT as m,cY as U,cZ as j}from"./vendor-cce75f21.js";import"./element-plus-40a28a03.js";import"./highlightjs-4914df6f.js";const w=[],p=[];function E(s){let e=w.find(t=>t.WorkerConstructor===s&&!t.running);return!e&&w.length<navigator.hardwareConcurrency-1&&(e={WorkerConstructor:s,worker:new s,running:!1},w.push(e)),e}function x(){if(p.length>0){const s=E(p[0].WorkerConstructor);if(s){const e=p.shift(),t=s.worker;s.running=!0,t.onmessage=function(a){switch(a.data.code){case"result":{e.resolve(a.data.data),s.running=!1,x();break}case"progress":{e.args.progress&&e.args.progress(a.data.data);break}default:e.reject("Unknow Result Code: "+a.data.code)}};const n={...e.args};delete n.progress,t.postMessage(n)}}}function T(s,e){return new Promise((t,n)=>{p.push({WorkerConstructor:s,resolve:t,reject:n,args:e}),x()})}const q=Object.freeze(Object.defineProperty({__proto__:null,addTask:T},Symbol.toStringTag,{value:"Module"}));function S(){return new Worker("https://kooritea.moe/assets/worker-f641804a.js")}const z=(s,e)=>s.reduce((t,n)=>(t[e.indexOf(n)]+=1,t),[...Array(e.length)].fill(0)),b=(s,e,t)=>{let n=0;for(let a=e;a<t;a+=1)n+=s[a];return n},H=s=>Array.from(new Set(s)).sort((e,t)=>e-t),D=(s,e,t,n)=>{let a=0;for(let i=e;i<t;i+=1)a+=s[i];return a/n},k=(s,e,t,n,a)=>{let i=0;for(let r=t;r<n;r+=1)i+=s[r]*e[r];return i*a},I=(s,e,t,n,a,i)=>{let r=0;for(let o=t;o<n;o+=1){const c=e[o]-a;r+=c*c*s[o]}return r*i},G=(s,e,t,n)=>s*e+t*n;function Y(s){const e=s.map(r=>r.map(o=>o[4]).flat(1)).flat(1),t=H(e),n=z(e,t),{length:a}=e,i=[...Array(t.length)].map((r,o)=>{const u=o,l=o,g=n.length,_=1/b(n,0,u),v=1/b(n,l,g),P=D(n,0,u,a),M=I(n,t,0,u,k(n,t,0,u,_),_),N=D(n,l,g,a),C=I(n,t,l,g,k(n,t,l,g,v),v),y=G(P,M,N,C);return isNaN(y)?Number.POSITIVE_INFINITY:y});return t[i.indexOf(Math.min(...i))]}async function Z(s,e){return new Promise((t,n)=>{const a=document.createElement("canvas"),i=a.getContext("2d"),r=new Image;r.onload=async()=>{try{a.width=r.width,a.height=r.height,i.drawImage(r,0,0,r.width,r.height,0,0,r.width,r.height);const o=i.getImageData(0,0,r.width,r.height).data;t({height:r.height,width:r.width,colorData:K({imageData:o,height:r.height,width:r.width},e)})}catch(o){n(o)}},r.src=s instanceof File?URL.createObjectURL(s):s})}function J(s,e,t){return s*6966+e*23436+t*2366>>15}function K(s,e){const t=e.direction==="vertical",n=[];for(let a=0;a<s.imageData.length;){(n.length===0||n[n.length-1].length===s[t?"width":"height"])&&n.push([]);const i=n[n.length-1],r=[s.imageData[a],s.imageData[a+1],s.imageData[a+2],s.imageData[a+3]];if(e.pointDiffType==="gray"){const o=J(s.imageData[a],s.imageData[a+1],s.imageData[a+2]);r.push(o)}i.push(r),a+=4}if(e.pointDiffType==="otsu"){const a=Y(n);for(const i in n)for(const r in n[i])n[i][r].push(a>n[i][r][4]?"rgba(0,0,0,255)":"rgba(255,255,255,255)")}return n}function h(s,e,t){for(const n in e){const a=e[n];for(const i in a){const r=a[i];s.fillStyle=`rgba(${r[0]},${r[1]},${r[2]},${r[3]})`,s.fillRect(i,t+Number(n),1,1)}}}async function Q(s,e={}){e={...e,direction:e.direction??"vertical",pointDiffType:e.pointDiffType??"gray",sort:e.sort??"desc",skipLine:e.skipLine??10};const t=await Promise.all(s.map(i=>Z(i,e))),n=new Array(t.length-1).fill(0),a=(await Promise.all(t.slice(0,t.length-1).map((i,r)=>T(S,{cmd:"getMaxMatchOffset",data:{image1:t[r],image2:t[r+1],options:{direction:e.direction,pointDiffType:e.pointDiffType,sort:e.sort}},progress:o=>{if(e.progress){n[r]=o;const c=n.reduce((u,l)=>O.add(u,l),0);e.progress(Number((c/n.length).toFixed(2)))}}})))).map(i=>i.offset);if(e.canvas){const i=e.canvas.getContext("2d");if(e.direction==="vertical"?(e.canvas.width=t[0].width,e.canvas.height=t.reduce((r,o)=>r+o.height,0)-a.reduce((r,o)=>r+o,0)):(e.canvas.width=t.reduce((r,o)=>r+o.width,0)-a.reduce((r,o)=>r+o,0),e.canvas.height=t[0].height),e.sort==="desc"){let r=0;for(let o=0;o<a.length;o++){const c=a[o];o===0&&(h(i,t[o].colorData,r),r=r+t[o].height),h(i,t[o+1].colorData.slice(c-e.skipLine),r-e.skipLine),r=r+t[o+1].height-c}}else{let r=e.canvas.height;for(let o=0;o<a.length;o++){const c=a[o];o===0&&(r=r-t[o].height,h(i,t[o].colorData,r)),r=r-t[o+1].height+c,h(i,t[o+1].colorData.slice(0,t[o+1].colorData.length-c+e.skipLine),r)}}}e.progress&&e.progress(100)}window.WorkerManager=q;window.DiffWorker=S;const X={components:{PageHeader:V,ImageCon:W},data(){return{progress:0,progressStatus:"",formConfig:{labelPosition:"top"},formData:{},fields:[{type:"radio",prop:"pointDiffType",label:"对比方法",required:!0,defaultValue:()=>"gray",options:()=>[{label:"灰度值(推荐，兼顾速度和准确性)",value:"gray"},{label:"色差(速度较慢)",value:"rgb"}]},{type:"radio",prop:"direction",label:"截图方向",afterSlotName:"direction-example",required:!0,defaultValue:()=>"vertical-desc",options:[{label:"从上到下",value:"vertical-desc"},{label:"从下到上",value:"vertical-asc"},{label:"从左到右(开发中)",value:"horizontal-desc",disabled:!0},{label:"从右到左(开发中)",value:"horizontal-asc",disabled:!0}]},{type:"upload",prop:"images",label:"截图",required:!0,formProps:{listType:"picture-card",multiple:!0},defaultValue:()=>[],rules:[{required:!0,trigger:"submit",validator:(s,e,t)=>{e.length>1?t():t("最少需要两张截图")}}]}],buttons:[{type:"primary",label:"合成",handler:(s,e)=>s.formInstance.submitForm().then(t=>{const[n,a]=t.direction.split("-");return this.progress=0,this.progressStatus="",this.$refs.result.width=0,this.$refs.result.height=0,Q(t.images.map(i=>i.raw),{direction:n,pointDiffType:t.pointDiffType,sort:a,canvas:this.$refs.result,progress:i=>{this.progress=i}}).then(()=>{this.progressStatus="success"}).catch(i=>{throw this.progressStatus="exception",F.error(i==null?void 0:i.message),i})})},{type:"success",label:"下载",show:()=>this.progressStatus==="success",handler:(s,e)=>new Promise(t=>{this.$refs.result.toBlob(a=>{L(a,`${this.getMergeFileName(this.formData.images.map(i=>i.raw))}.png`),t()})})}]}},methods:{getMergeFileName(s){let e="";for(let t=0;t<s[0].name.length&&!s.some(n=>n.name[t]!==s[0].name[t]);t++)e+=s[0].name[t];return`${e}${["-","_"].includes(e[e.length-1])?"":"-"}merge`}}},ee=s=>(U("data-v-25e85006"),s=s(),j(),s),te={class:"page"},re={class:"direction-example"},se=ee(()=>m("span",null,"示例：",-1)),ae={style:{"margin-top":"24px"}},ne={ref:"result",style:{width:"100%","margin-top":"24px"}};function oe(s,e,t,n,a,i){const r=f("PageHeader"),o=f("ImageCon"),c=f("EasyForm"),u=f("el-progress");return A(),B("div",te,[d(r),d(c,{modelValue:a.formData,"onUpdate:modelValue":e[0]||(e[0]=l=>a.formData=l),fields:a.fields,buttons:a.buttons,"form-config":a.formConfig},{"direction-example":R(l=>[m("div",re,[se,d(o,{src:`/assets/image-merge-${l.formData[l.field.prop]}-example.png`},null,8,["src"])])]),_:1},8,["modelValue","fields","buttons","form-config"]),m("div",ae,[d(u,{percentage:a.progress,"text-inside":!0,"stroke-width":24,status:a.progressStatus},null,8,["percentage","status"]),m("canvas",ne,null,512)])])}const he=$(X,[["render",oe],["__scopeId","data-v-25e85006"]]);export{he as default};
