import{r as _,ap as P,p as L,v as F,n as O,k as T,ai as b,o as m,e as H,f as i,$ as M,Z as x,T as A,V as W,R as N,aG as $,_ as j,W as G,U as q}from"./vendor-eddec4a0.js";import{_ as z,S as K,B as Z,a as J,M as B,l as Q,I as X}from"./index-3e281d45.js";import{M as Y}from"./MarkDown-5ceeeb93.js";import{c as ee}from"./GreatOldOne-ff416370.js";import"./highlightjs-b0208cd2.js";import"./element-plus-e4e3d2c3.js";import"./ImageCon-d6be41bb.js";const S={},te={components:{SvgIcon:K,Markdown:Y,ButtonBox:Z},props:{modelValue:{type:String,default:()=>""},title:{type:String,default:""},autoHeight:{type:Boolean,default:!0},cache:{type:[String,Boolean],default:""},onSubmit:{type:Function,default:()=>{}},showDefaultHandlers:{type:[Boolean,Array],default:()=>!0},exHandlers:{type:Array,default:()=>[]}},setup(o,{emit:r}){const f=_(!0),{computedModelValue:e}=J(o,r),v=_(!1),D=_(null);if(o.cache){const t=P();if(S[t.fullPath]&&o.cache===!0)B.error("当前页面存在两个需要缓存的编辑器,需要为编辑器传入缓存唯一标识缓存功能才会工作！");else{const n="MDEditorCache."+(o.cache===!0?t.fullPath:`${t.fullPath}.${o.cache}`);e.value=localStorage.getItem(n);let a=null;L(()=>{S[n]=!0,a=setInterval(()=>{v.value=!0,localStorage.setItem(n,e.value||"")},1e3)}),F(()=>{S[n]=!1,clearInterval(a)}),O(e,()=>{v.value=!1})}}const h=t=>{const n=D.value.selectionStart,a=e.value.slice(0,n),d=e.value.slice(n);e.value=`${a}${t}${d}`},u=_(e.value),g=()=>{const t=o.onSubmit(e.value);return t instanceof Promise?t.then(()=>{e.value="",u.value=""}):(e.value="",u.value=""),t},s=()=>Q({title:"提示",message:"确认清空内容?",type:"warning",confirmHandlerPromise:()=>{e.value=""}}),I=()=>{e.value=u.value},U=[{name:"提交",type:"primary",handler:g,show:()=>Array.isArray(o.showDefaultHandlers)?o.showDefaultHandlers.includes("submit"):o.showDefaultHandlers,sort:10},{name:"清除",type:"danger",handler:s,show:()=>Array.isArray(o.showDefaultHandlers)?o.showDefaultHandlers.includes("clean"):o.showDefaultHandlers,sort:20},{name:"重置",type:"default",handler:I,show:()=>(Array.isArray(o.showDefaultHandlers)?o.showDefaultHandlers.includes("reset"):o.showDefaultHandlers)&&!!u.value,sort:30}],V=T(()=>[...U,...o.exHandlers]),p=t=>{const n=X(URL.createObjectURL(t),{handlers:[{name:"上传",type:"primary",handler:()=>{const a=new Date().valueOf().toString();h(`![${a}](--------------------)`),ee(t,d=>{const c=Math.round(100*event.loaded/event.total)/10*2;e.value=e.value.replace(new RegExp(`\\!\\[${a}]\\((#*?)(-*?)\\)`),`![${a}](${"#".repeat(c)}${"-".repeat(20-c)})`)}).then(d=>{e.value=e.value.replace(new RegExp(`\\!\\[${a}]\\((#*?)(-*?)\\)`),`![${d.keyname}](${d.local})`)}).catch(()=>{e.value=e.value.replace(new RegExp(`\\!\\[${a}]\\((#*?)(-*?)\\)`),"")}),n.callClose()}},{name:"裁剪为16:9",type:"default",show:()=>{},handler:()=>{const a=document.createElement("canvas"),d=a.getContext("2d"),l=new Image;l.onload=async()=>{if(l.height*16===l.width*9)return;const c=l.height*16/9;if(c>l.width){const y=.5625*l.width;a.width=l.width,a.height=y,d.drawImage(l,0,(l.height-y)/2,l.width,y,0,0,l.width,y)}else a.width=c,a.height=l.height,d.drawImage(l,(l.width-c)/2,0,c,l.height,0,0,c,l.height);const E=a.toDataURL(t.type).split(","),R=E[0].match(/:(.*?);/)[1],k=atob(E[1]);let w=k.length;const C=new Uint8Array(w);for(;w--;)C[w]=k.charCodeAt(w);n.callClose(),p(new File([C],t.name,{type:R}))},l.src=URL.createObjectURL(t)}},{name:"取消",type:"default",handler:()=>{n.callClose()}}]})};return{isEditMode:f,computedModelValue:e,resetCache:u,isSave:v,handlers:V,submitHandler:g,cleanHandler:s,resetHandler:I,previewImageBeforeUpload:p,pasteHandler:t=>{if(!(t.clipboardData&&t.clipboardData.items))return;const n=Array.from(t.clipboardData.items).filter(a=>a.kind==="file");if(n.length>0){t.preventDefault();for(const a of n)if(a.type.startsWith("image/")){p(a.getAsFile());return}else B.warning(`不支持的文件类型: ${a.type}`)}},dropHandler:t=>{for(const n of t.dataTransfer.files)if(t.preventDefault(),n.type.startsWith("image/")){p(n);return}else B.warning(`不支持的文件类型: ${n.type}`)},textarea:D,insertText:h}}},ae={class:"md-editor"},ne={class:"bar"},le={class:"bar-left"},oe={class:"title"},re={class:"uploader"},se={class:"bar-right"},ie={key:0,class:"is-save info"},de={class:"fill"},ce={key:1,class:"preview"};function ue(o,r,f,e,v,D){const h=b("SvgIcon"),u=b("Markdown"),g=b("ButtonBox");return m(),H(q,null,[i("div",ae,[i("div",ne,[i("div",le,[i("div",oe,M(f.title),1),i("label",re,[x(h,{class:"button",name:"icon-14"}),i("input",{type:"file",accept:"image/*",onChange:r[0]||(r[0]=s=>{e.previewImageBeforeUpload(s.srcElement.files[0]),s.srcElement.value=""})},null,32)]),x(h,{class:"button",name:"icon-biaoqing"})]),i("div",se,[e.isSave?(m(),H("span",ie,"已保存")):A("",!0),i("span",{class:"preview-switch button",onClick:r[1]||(r[1]=s=>e.isEditMode=!e.isEditMode)},M(e.isEditMode?"预览":"返回编辑"),1)])]),e.isEditMode?(m(),H("div",{key:0,class:W(["textarea-box",{"auto-height":f.autoHeight}])},[i("pre",de,M(e.computedModelValue),1),N(i("textarea",{ref:"textarea","onUpdate:modelValue":r[2]||(r[2]=s=>e.computedModelValue=s),class:"textarea",onPaste:r[3]||(r[3]=(...s)=>e.pasteHandler&&e.pasteHandler(...s)),onDragover:r[4]||(r[4]=j(()=>{},["prevent"])),onDrop:r[5]||(r[5]=(...s)=>e.dropHandler&&e.dropHandler(...s))},null,544),[[$,e.computedModelValue]])],2)):(m(),H("div",ce,[x(u,{"model-value":e.computedModelValue},null,8,["model-value"])]))]),e.handlers.length>0?(m(),G(g,{key:0,handlers:e.handlers},null,8,["handlers"])):A("",!0)],64)}const He=z(te,[["render",ue],["__scopeId","data-v-0b3b0ca8"]]);export{He as default};
