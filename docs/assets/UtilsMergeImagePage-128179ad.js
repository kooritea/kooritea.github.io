import{P as U}from"./PageHeader-0a787d68.js";import{I as P}from"./ImageCon-aa82a040.js";import{M as D,P as $}from"./MediaBrowser-1df037dd.js";import{Z as f,_ as C,u as T,M,a8 as O,a4 as y,a9 as B}from"./index-6caba819.js";import{cg as p,aR as F,aS as N,bD as h,bx as v,aT as w,cY as L,cZ as A}from"./vendor-a6581121.js";import"./element-plus-5d967f66.js";import"./highlightjs-4914df6f.js";const x=[],b=[];function E(e){let t=x.find(r=>r.WorkerConstructor===e&&!r.running);return!t&&x.length<navigator.hardwareConcurrency-1&&(t={WorkerConstructor:e,worker:new e,running:!1},x.push(t)),t}function V(){if(b.length>0){const e=E(b[0].WorkerConstructor);if(e){const t=b.shift(),r=e.worker;e.running=!0,r.onmessage=function(n){switch(n.data.code){case"result":{t.resolve(n.data.data),e.running=!1,V();break}case"progress":{t.args.progress&&t.args.progress(n.data.data);break}default:t.reject("Unknow Result Code: "+n.data.code)}};const d={...t.args};delete d.progress,r.postMessage(d)}}}function W(e,t){return new Promise((r,d)=>{b.push({WorkerConstructor:e,resolve:r,reject:d,args:t}),V()})}function H(){return new Worker("https://kooritea.moe/assets/worker-53a51987.js")}async function R(e,t){return new Promise((r,d)=>{const n=document.createElement("canvas"),l=n.getContext("2d"),a=new Image;a.onload=async()=>{try{n.width=a.width,n.height=a.height,l.drawImage(a,0,0,a.width,a.height,0,0,a.width,a.height);const u=l.getImageData(0,0,a.width,a.height).data;r({height:a.height,width:a.width,imageData:u})}catch(u){d(u)}},a.src=e instanceof File?URL.createObjectURL(e):e})}function _(e,t,r,d,n=[]){const{imageData:l,width:a,height:u}=t,[o=0,i=d==="vertical"?u:a]=n;if(d==="vertical")for(let c=o*a;c<i*a;c++){const g=c*4;e.fillStyle=`rgba(${l[g]},${l[g+1]},${l[g+2]},${l[g+3]})`,e.fillRect(c%a,r+parseInt(c/a),1,1)}}async function j(e,t={}){t={...t,direction:t.direction??"vertical",pointDiffType:t.pointDiffType??"gray",sort:t.sort??"desc",skipLine:t.skipLine??10};const r=await Promise.all(e.map(l=>R(l)));if(Array.from(new Set(r.map(l=>l[t.direction==="vertical"?"width":"height"]))).length>1)throw new Error(`拼接方向为${t.direction==="vertical"?"纵向":"横向"}时所有图片的${t.direction==="vertical"?"宽度":"长度"}必须一致`);const d=new Array(r.length-1).fill(0),n=(await Promise.all(r.slice(0,r.length-1).map((l,a)=>W(H,{cmd:"getMaxMatchOffset",data:{image1:r[a],image2:r[a+1],options:{direction:t.direction,pointDiffType:t.pointDiffType,sort:t.sort}},progress:u=>{if(t.progress){d[a]=u;const o=d.reduce((i,c)=>f.add(i,c),0);t.progress(Number((o/d.length).toFixed(2)))}}})))).map(l=>l.offset);t.progress&&t.progress(100),t.canvas&&await new Promise((l,a)=>{setTimeout(()=>{try{const u=t.canvas.getContext("2d");if(t.direction==="vertical"?(t.canvas.width=r[0].width,t.canvas.height=r.reduce((o,i)=>o+i.height,0)-n.reduce((o,i)=>o+i,0)):(t.canvas.width=r.reduce((o,i)=>o+i.width,0)-n.reduce((o,i)=>o+i,0),t.canvas.height=r[0].height),t.sort==="desc"){let o=0;for(let i=0;i<n.length;i++){const c=n[i];i===0&&(_(u,r[i],o,t.direction),o=o+r[i].height),o=o-c,_(u,r[i+1],o,t.direction,[c-t.skipLine]),o=o+r[i+1].height}}else{let o=t.canvas.height;for(let i=0;i<n.length;i++){const c=n[i];i===0&&(o=o-r[i].height,_(u,r[i],o,t.direction)),o=o-r[i+1].height+c,_(u,r[i+1],o,t.direction,[0,r[i+1][t.direction==="vertical"?"height":"width"]-c+t.skipLine])}}l()}catch(u){a(u)}})})}const q={components:{PageHeader:U,ImageCon:P,MediaBrowser:D,PreviewScreenshots:$},setup(){const{isGreatOldOne:e}=T();return{isGreatOldOne:e}},data(){return{progress:0,progressStatus:"",startTime:0,endTime:0,canAutoUpdateEnd:!0,formConfig:{labelPosition:"top"},formData:{},fields:[{type:"radio",prop:"pointDiffType",label:"对比方法",required:!0,defaultValue:()=>"gray",options:()=>[{label:"灰度值(推荐，兼顾速度和准确性)",value:"gray"},{label:"色差(速度较慢)",value:"rgb"}]},{type:"switch",label:"使用在线视频",prop:"isUseOnlineVideo",showInForm:()=>this.isGreatOldOne,defaultValue:()=>!1},{type:"slot",prop:"sourcePath",slotName:"fileBrowser",label:"文件",showInForm:e=>e.formData.isUseOnlineVideo===!0},{type:"slot",slotName:"tsSelector",needAutoUpdateTime:!0,prop:"start",label:"开始时间",afterSlotName:"screenshots",defaultValue:()=>"00:00:00.0",onChange:(e,t,r)=>{r&&(this.needUpdatePreviewVideoSrc=!0,this.canAutoUpdateEnd&&(e.formData.end=e.formData.start))},showInForm:e=>e.formData.isUseOnlineVideo===!0},{type:"slot",slotName:"tsSelector",prop:"end",label:"结束时间",afterSlotName:"screenshots",defaultValue:()=>"00:00:00.0",onChange:(e,t,r)=>{r&&(this.canAutoUpdateEnd=!1)},showInForm:e=>e.formData.isUseOnlineVideo===!0},{type:"number",prop:"splitCount",label:"分割数量",formProps:{type:"number",min:2},defaultValue:()=>Math.min(10,Math.max(2,navigator.hardwareConcurrency-1)),showInForm:e=>e.formData.isUseOnlineVideo===!0},{type:"upload",prop:"images",label:"截图",required:!0,formProps:{listType:"picture-card",multiple:!0},defaultValue:()=>[],rules:[{required:!0,trigger:"submit",validator:(e,t,r)=>{t.length>1?r():r("最少需要两张截图")}}],buttons:[{type:"primary",label:"从视频源生成预览图",show:e=>e.formData.isUseOnlineVideo,handler:e=>this.generateScreenshots(e.formData,"jpg")},{type:"primary",label:"从视频源生成原图",show:e=>e.formData.isUseOnlineVideo,handler:e=>this.generateScreenshots(e.formData,"png")}]},{type:"radio",prop:"direction",label:"截图方向",afterSlotName:"direction-example",required:!0,defaultValue:()=>"vertical-desc",options:[{label:"从上到下",value:"vertical-desc"},{label:"从下到上",value:"vertical-asc"},{label:"从左到右(开发中)",value:"horizontal-desc",disabled:!0},{label:"从右到左(开发中)",value:"horizontal-asc",disabled:!0}]},{type:"number",prop:"skipLine",label:"裁剪边缘",tips:"渲染时去除图像边缘的距离，一定程度上可以去除图像边缘颜色变化的影响。",formProps:{type:"number",min:0},defaultValue:()=>10},{type:"view",prop:"text",hiddenLabel:!0,viewer:()=>`可用线程数: ${navigator.hardwareConcurrency}`}],buttons:[{type:"primary",label:"合成",handler:(e,t)=>e.formInstance.submitForm().then(r=>{const[d,n]=r.direction.split("-");return this.startTime=Date.now(),this.endTime=0,this.progress=0,this.progressStatus="",this.$refs.result.width=0,this.$refs.result.height=0,j(r.images.map(l=>l.raw),{direction:d,pointDiffType:r.pointDiffType,sort:n,skipLine:r.skipLine,canvas:this.$refs.result,progress:l=>{this.progress=l}}).then(()=>{this.endTime=Date.now(),this.progressStatus="success"}).catch(l=>{throw this.progressStatus="exception",M.error(l==null?void 0:l.message),l})})},{type:"success",label:"下载",show:()=>this.progressStatus==="success",handler:(e,t)=>new Promise(r=>{this.$refs.result.toBlob(n=>{O(n,`${this.getMergeFileName(this.formData.images.map(l=>l.raw))}.png`),r()})})}]}},methods:{getMergeFileName(e){let t="";for(let r=0;r<e[0].name.length&&!e.some(d=>d.name[r]!==e[0].name[r]);r++)t+=e[0].name[r];return`${t}${["-","_"].includes(t[t.length-1])?"":"-"}merge`},async generateScreenshots(e,t){if(!e.sourcePath){this.$msgBox.warning("请先选择视频源");return}if(!e.start){this.$msgBox.warning("请先选择开始时间");return}if(e.end){const a=y(e.end),u=y(e.start);if(a<=u){this.$msgBox.warning(`结束时间[${a}]不能小于等于开始时间[${u}]`);return}}else{this.$msgBox.warning("请先选择结束时间");return}if(e.splitCount<2){this.$msgBox.warning("分割数量必须大于1");return}const r=y(e.start),d=y(e.end),n=f.divide(f.subtract(d,r),e.splitCount-1),l=new Array(e.splitCount-1).fill(null).map((a,u)=>Number(f.add(r,f.multiply(u,n)).toFixed(2)));l.push(d),e.images=[];for(let a=0;a<l.length;a++){const u=l[a],o=await B(e.sourcePath,u,t),i=`image-${a}.${t}`;e.images.push({name:i,raw:new File([o],i,{type:o.type}),status:"ready",percentage:0,size:o.size,url:URL.createObjectURL(o)})}}}},S=e=>(L("data-v-6a45e7ad"),e=e(),A(),e),z={class:"page"},G={class:"direction-example"},Z=S(()=>w("span",null,"示例：",-1)),Y=S(()=>w("span",null,".",-1)),J={style:{"margin-top":"24px"}},K={ref:"result",style:{width:"100%","margin-top":"24px"}};function Q(e,t,r,d,n,l){const a=p("PageHeader"),u=p("ImageCon"),o=p("MediaBrowser"),i=p("el-time-picker"),c=p("el-input-number"),g=p("PreviewScreenshots"),k=p("EasyForm"),I=p("el-progress");return F(),N("div",z,[h(a),h(k,{modelValue:n.formData,"onUpdate:modelValue":t[0]||(t[0]=s=>n.formData=s),fields:n.fields,buttons:n.buttons,"form-config":n.formConfig},{"direction-example":v(s=>[w("div",G,[Z,h(u,{src:`/assets/image-merge-${s.formData[s.field.prop]}-example.png`},null,8,["src"])])]),fileBrowser:v(s=>[h(o,{modelValue:s.formData[s.field.prop],"onUpdate:modelValue":m=>s.formData[s.field.prop]=m,checkMode:"single"},null,8,["modelValue","onUpdate:modelValue"])]),tsSelector:v(s=>[h(i,{"model-value":s.formData[s.field.prop].split(".")[0],"value-format":"HH:mm:ss",format:"HH:mm:ss",style:{width:"120px"},"onUpdate:modelValue":m=>{s.formData[s.field.prop]=`${m||"00:00:00"}.${s.formData[s.field.prop].split(".")[1]}`,s.field.onChange(s,m,!0)}},null,8,["model-value","onUpdate:modelValue"]),Y,h(c,{"model-value":Number("0."+s.formData[s.field.prop].split(".")[1]),min:0,max:1,precision:3,step:.1,style:{width:"120px"},"onUpdate:modelValue":m=>{s.formData[s.field.prop]=`${s.formData[s.field.prop].split(".")[0]}.${String(m).split(".")[1]||0}`,s.field.onChange(s,m,!0)}},null,8,["model-value","step","onUpdate:modelValue"])]),screenshots:v(s=>[h(g,{modelValue:s.formData[s.field.prop],sourcePath:s.formData.sourcePath,"onUpdate:modelValue":m=>{s.formData[s.field.prop]=m,s.field.onChange(s,m,!0)}},null,8,["modelValue","sourcePath","onUpdate:modelValue"])]),_:1},8,["modelValue","fields","buttons","form-config"]),w("div",J,[h(I,{percentage:n.progress,"text-inside":!0,"stroke-width":24,status:n.progressStatus,format:s=>!n.progressStatus&&s===100?"canvas渲染结果中":n.progressStatus==="success"?`成功，用时: ${((n.endTime-n.startTime)/1e3).toFixed(1)}s`:`${s}%`},null,8,["percentage","status","format"]),w("canvas",K,null,512)])])}const ie=C(q,[["render",Q],["__scopeId","data-v-6a45e7ad"]]);export{ie as default};
