import{bj as L,b2 as H,ch as b,aP as h,aQ as y,aR as m,bp as R,b_ as F,bv as k,bu as P,bz as E,bl as T,ct as G,a_ as q,bh as K,aY as Q,aW as Y,bF as J,cG as X,bH as Z,bo as I,bA as O}from"./vendor-b07f99b0.js";import{_ as W,S as N,a as ee,n as te,M as A,B as ae,u as ne,j as oe,I as se}from"./index-ebcb88b8.js";import{M as re}from"./MarkDown-3806b5db.js";import{I as le}from"./ImageCon-92ce0650.js";import{t as ce,v as ie,w as de,x as ue}from"./GreatOldOne-7203e76e.js";import{a as me}from"./element-plus-20d21a73.js";import"./highlightjs-4914df6f.js";const he={components:{SvgIcon:N,ImageCon:le},props:{init:{type:Boolean,default:!0},prefix:{type:[String,Array],default:"https://cdn.jsdelivr.net/gh/kooritea/kooritea.github.io/emoji/"}},emits:["select"],setup(l,{emit:c}){const{emoteHistory:u}=ee(),e=L({name:"history",emote:u.value}),t=L([]),p=H("history"),v=s=>{if(p.value=s.name,s.emote.length===0)return ce(s.name).then(r=>{p.value=s.name,s.emote=r.emote.map(S=>({...S,scope:s.name}))})},f=()=>{t.splice(0,t.length),t.push(e),ie().then(s=>{t.push(...s.sort((r,S)=>{const D=u.value.findIndex(M=>M.scope===r.name),w=u.value.findIndex(M=>M.scope===S.name);return(D===-1?1/0:D)-(w===-1?1/0:w)})),t.push({name:"add",emote:[]})})};return f(),{onSelect:s=>{c("select",s),u.value=u.value.filter(r=>!(r.scope===s.scope&&r.name===s.name)),u.value=[s,...u.value].slice(0,30),e.emote=u.value},addEmotePackage:()=>{te({title:"导入表情包",message:"输入要添加的B站表情包ID",type:"info",confirmHandlerPromise:s=>de(s.inputValue).then(()=>{A.success("添加成功"),f()}),inputValidator:s=>/^\d+$/.test(s),showInput:!0,inputErrorMessage:"请输入数字"})},currentScope:p,emotePackages:t,selectScope:v}}},fe={class:"emote-selector"},pe={class:"emotes"},ve={class:"scopes"},ge=["onClick"];function _e(l,c,u,e,t,p){const v=b("ImageCon"),f=b("SvgIcon");return h(),y("div",fe,[m("div",pe,[(h(!0),y(R,null,F((e.emotePackages.find(a=>a.name===e.currentScope)||{}).emote||[],a=>(h(),k(v,{key:a.name,class:"emote",alt:a.name,src:`${a.scope}/${a.name}.png`,prefix:u.prefix,onClick:x=>e.onSelect(a)},{error:P(()=>[m("span",null,E(a.name),1)]),_:2},1032,["alt","src","prefix","onClick"]))),128))]),m("div",ve,[(h(!0),y(R,null,F(e.emotePackages,a=>(h(),y("div",{key:a.name,class:T(["scope",{"selected-scope":e.currentScope===a.name}]),onClick:()=>{a.name==="add"?e.addEmotePackage():e.selectScope(a)}},[a.name==="history"?(h(),k(f,{key:0,class:"emote history",name:"icon-time"})):a.name==="add"?(h(),k(f,{key:1,class:"emote history",name:"add"})):(h(),k(v,{key:2,class:"emote",src:`${a.name}/${a.name}.png`,prefix:u.prefix},{error:P(()=>[m("span",null,E(a.name),1)]),_:2},1032,["src","prefix"]))],10,ge))),128))])])}const ye=W(he,[["render",_e],["__scopeId","data-v-db974307"]]);const V={},we={components:{SvgIcon:N,Markdown:re,ButtonBox:ae,EmoteSelector:ye,ElPopover:me},props:{modelValue:{type:String,default:()=>""},title:{type:String,default:""},autoHeight:{type:Boolean,default:!0},cache:{type:[String,Boolean],default:""},onSubmit:{type:Function,default:()=>{}},showDefaultHandlers:{type:[Boolean,Array],default:()=>!0},exHandlers:{type:Array,default:()=>[]}},setup(l,{emit:c}){const{darkMode:u}=ne(),e=H(!0),{computedModelValue:t}=oe(l,c),p=H(!1),v=H(null);if(l.cache){const n=G();if(V[n.fullPath]&&l.cache===!0)A.error("当前页面存在两个需要缓存的编辑器,需要为编辑器传入缓存唯一标识缓存功能才会工作！");else{const i="MDEditorCache."+(l.cache===!0?n.fullPath:`${n.fullPath}.${l.cache}`);t.value=localStorage.getItem(i);let o=null;q(()=>{V[i]=!0,o=setInterval(()=>{p.value=!0,localStorage.setItem(i,t.value||"")},1e3)}),K(()=>{V[i]=!1,clearInterval(o)}),Q(t,()=>{p.value=!1})}}const f=n=>{const i=v.value.selectionStart,o=t.value.slice(0,i),g=t.value.slice(i);t.value=`${o}${n}${g}`},a=H(t.value),x=()=>{const n=l.onSubmit(t.value);return n instanceof Promise?n.then(()=>{t.value="",a.value=""}):(t.value="",a.value=""),n},s=()=>{t.value=""},r=()=>{t.value=a.value},S=[{name:"提交",type:"primary",handler:x,show:()=>Array.isArray(l.showDefaultHandlers)?l.showDefaultHandlers.includes("submit"):l.showDefaultHandlers,sort:10},{name:"清除",type:"danger",handler:s,confirm:{message:"确认清空内容?"},show:()=>Array.isArray(l.showDefaultHandlers)?l.showDefaultHandlers.includes("clean"):l.showDefaultHandlers,sort:20},{name:"重置",type:"default",handler:r,show:()=>(Array.isArray(l.showDefaultHandlers)?l.showDefaultHandlers.includes("reset"):l.showDefaultHandlers)&&!!a.value,sort:30}],D=Y(()=>[...S,...l.exHandlers]),w=n=>{const i=se(URL.createObjectURL(n),{handlers:[{name:"上传",type:"primary",handler:()=>{const o=new Date().valueOf().toString();f(`![${o}](--------------------)`),ue(n,g=>{const _=Math.round(100*event.loaded/event.total)/10*2;t.value=t.value.replace(new RegExp(`\\!\\[${o}]\\((#*?)(-*?)\\)`),`![${o}](${"#".repeat(_)}${"-".repeat(20-_)})`)}).then(g=>{t.value=t.value.replace(new RegExp(`\\!\\[${o}]\\((#*?)(-*?)\\)`),`![${g.keyname}](${g.local})`)}).catch(()=>{t.value=t.value.replace(new RegExp(`\\!\\[${o}]\\((#*?)(-*?)\\)`),"")}),i.callClose()}},{name:"裁剪为16:9",type:"default",show:()=>{},handler:()=>{const o=document.createElement("canvas"),g=o.getContext("2d"),d=new Image;d.onload=async()=>{if(d.height*16===d.width*9)return;const _=d.height*16/9;if(_>d.width){const C=.5625*d.width;o.width=d.width,o.height=C,g.drawImage(d,0,(d.height-C)/2,d.width,C,0,0,d.width,C)}else o.width=_,o.height=d.height,g.drawImage(d,(d.width-_)/2,0,_,d.height,0,0,_,d.height);const U=o.toDataURL(n.type).split(","),z=U[0].match(/:(.*?);/)[1],$=atob(U[1]);let B=$.length;const j=new Uint8Array(B);for(;B--;)j[B]=$.charCodeAt(B);i.callClose(),w(new File([j],n.name,{type:z}))},d.src=URL.createObjectURL(n)}},{name:"取消",type:"default",handler:()=>{i.callClose()}}]})};return{darkMode:u,isEditMode:e,computedModelValue:t,resetCache:a,isSave:p,handlers:D,submitHandler:x,cleanHandler:s,resetHandler:r,previewImageBeforeUpload:w,pasteHandler:n=>{if(!(n.clipboardData&&n.clipboardData.items))return;const i=Array.from(n.clipboardData.items).filter(o=>o.kind==="file");if(i.length>0){n.preventDefault();for(const o of i)if(o.type.startsWith("image/")){w(o.getAsFile());return}else A.warning(`不支持的文件类型: ${o.type}`)}},dropHandler:n=>{for(const i of n.dataTransfer.files)if(n.preventDefault(),i.type.startsWith("image/")){w(i);return}else A.warning(`不支持的文件类型: ${i.type}`)},textarea:v,insertText:f}}},be={class:"md-editor"},xe={class:"fill"},Se={key:1,class:"preview"},Ie={class:"bar"},He={class:"bar-left"},ke={class:"title"},Ee={class:"uploader"},De={class:"bar-right"},Me={key:0,class:"is-save info"};function Be(l,c,u,e,t,p){const v=b("Markdown"),f=b("SvgIcon"),a=b("EmoteSelector"),x=b("el-popover"),s=b("ButtonBox");return h(),y(R,null,[m("div",be,[e.isEditMode?(h(),y("div",{key:0,class:T(["textarea-box",{"auto-height":u.autoHeight}])},[m("pre",xe,E(e.computedModelValue),1),J(m("textarea",{ref:"textarea","onUpdate:modelValue":c[0]||(c[0]=r=>e.computedModelValue=r),class:"textarea",onPaste:c[1]||(c[1]=(...r)=>e.pasteHandler&&e.pasteHandler(...r)),onDragover:c[2]||(c[2]=Z(()=>{},["prevent"])),onDrop:c[3]||(c[3]=(...r)=>e.dropHandler&&e.dropHandler(...r))},null,544),[[X,e.computedModelValue]])],2)):(h(),y("div",Se,[I(v,{"model-value":e.computedModelValue},null,8,["model-value"])])),m("div",Ie,[m("div",He,[m("div",ke,E(u.title),1),m("label",Ee,[I(f,{class:"button",name:"14"}),m("input",{type:"file",accept:"image/*",onChange:c[4]||(c[4]=r=>{e.previewImageBeforeUpload(r.srcElement.files[0]),r.srcElement.value=""})},null,32)]),I(x,{width:"auto",trigger:"click",effect:e.darkMode?"dark":"light"},{reference:P(()=>[I(f,{class:"button",name:"biaoqing"})]),default:P(()=>[I(a,{onSelect:c[5]||(c[5]=r=>{e.insertText(`[emoji ${r.scope}/${r.name}]`)})})]),_:1},8,["effect"])]),m("div",De,[e.isSave?(h(),y("span",Me,"已保存")):O("",!0),m("span",{class:"preview-switch button",onClick:c[6]||(c[6]=r=>e.isEditMode=!e.isEditMode)},E(e.isEditMode?"预览":"返回编辑"),1)])])]),e.handlers.length>0?(h(),k(s,{key:0,handlers:e.handlers},null,8,["handlers"])):O("",!0)],64)}const Le=W(we,[["render",Be],["__scopeId","data-v-fa89b109"]]);export{Le as default};
