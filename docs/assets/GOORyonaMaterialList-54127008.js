import{n as V,o as v}from"./element-plus-5d967f66.js";import{P as S}from"./PageHeader-99b99408.js";import{_ as g,Z as b,$ as D,M as I,u as x,a as G,x as M,a0 as T,a1 as C,a2 as R,a3 as E}from"./index-3273d7b9.js";import{cg as n,aR as c,bw as y,bx as m,bD as d,aT as P,aS as _,b_ as F,bC as h,a_ as L,bB as k}from"./vendor-a6581121.js";import"./highlightjs-4914df6f.js";const B={data(){return{float:b,dialogVisible:!1,formConfig:{labelPosition:"top"},materials:[],formData:{},fields:[{type:"slot",slotName:"materialsInfo",prop:"materialIds",label:"包含切片",required:!0,formProps:{multiple:!0}},{type:"input",prop:"title",label:"标题",required:!0,options:()=>Array.from(new Set(this.materials.map(e=>{var t;return(t=e.bangumi)==null?void 0:t.nname})))},{type:"select",prop:"thumbnail",label:"封面",required:!0,options:()=>this.materials.map((e,t)=>{if(e.thumbnail===null)return null;const r=e.thumbnail,a=this.materials.slice(0,t).reduce((o,l)=>b.add(o,b.subtract(l.end,l.start)),0);return b.add(r,a)}).filter(e=>e!==null).map(e=>({label:e,value:String(e)}))},{type:"switch",prop:"publish",label:"立即发布",defaultValue:()=>!0}],buttons:[{label:"提交",type:"primary",handler:e=>e.formInstance.submitForm().then(t=>D(t).then(()=>{I.success("提交成功"),e.formInstance.resetFormData(),this.dialogVisible=!1}))}]}},methods:{open({materials:e}){this.materials=e,this.formData={materialIds:e.map(t=>t.id)},this.dialogVisible=!0}}},O={class:"materials-info"};function $(e,t,r,a,o,l){const i=n("EasyForm"),p=n("el-dialog");return c(),y(p,{modelValue:o.dialogVisible,"onUpdate:modelValue":t[1]||(t[1]=s=>o.dialogVisible=s),title:"创建切片集合"},{default:m(()=>[d(i,{ref:"EasyForm",modelValue:o.formData,"onUpdate:modelValue":t[0]||(t[0]=s=>o.formData=s),fields:o.fields,buttons:o.buttons,"form-config":o.formConfig},{materialsInfo:m(()=>[P("div",O,[(c(!0),_(L,null,F(o.materials,(s,u)=>(c(),_("div",{key:s.id,class:"material"},h(u+1)+"、["+h(o.float.subtract(s.end,s.start))+"s]"+h(s.filepath),1))),128))])]),_:1},8,["modelValue","fields","buttons","form-config"])]),_:1},8,["modelValue"])}const U=g(B,[["render",$],["__scopeId","data-v-b227c01c"]]);const A={data(){return{dialogVisible:!1,sourceSrc:""}},methods:{open({sourceSrc:e}){this.sourceSrc=e,this.dialogVisible=!0}}},H=["src"];function q(e,t,r,a,o,l){const i=n("el-dialog");return c(),y(i,{modelValue:o.dialogVisible,"onUpdate:modelValue":t[0]||(t[0]=p=>o.dialogVisible=p),title:"预览"},{default:m(()=>[P("video",{class:"video",controls:"",preload:"none",src:o.sourceSrc},null,8,H)]),_:1},8,["modelValue"])}const N=g(A,[["render",q],["__scopeId","data-v-d8095bef"]]);const W={components:{PageHeader:S,GPPRyonaCreateGroupDialog:U,GPPRyonaVideoPreviewDialog:N},setup(){const{mobileMode:e,onlineApiBaseURL:t}=x(),{accessKey:r}=G();return{mobileMode:e,onlineApiBaseURL:t,accessKey:r}},data(){return{isExSearch:!1,bangumiOptions:[],tableData:[],selected:[],tableProp:{tableConfig:{handlerWidth:"160px",showPagination:!0,selection:!0,tableProps:{stripe:!0,border:!0},tableHandlerProps:{fixed:void 0},publicTableProps:{showOverflowTooltip:!0}},emitLoadOnCreate:!0,buttons:[{type:"primary",buttonProps:{link:!0},label:"查看",handler:(e,t)=>{this.$refs.GPPRyonaVideoPreviewDialog.open({sourceSrc:`${this.onlineApiBaseURL}/video/source/material/preview/${t.row.id}?mass-controler-fingerprint=${this.accessKey}`})}},{type:"primary",buttonProps:{link:!0},label:"编辑",handler:(e,t)=>{this.$refs.EditTable.editReady(t.row)}},{type:"danger",buttonProps:{link:!0},label:"删除",handler:(e,t)=>{M({title:"提示",message:`确认删除${t.row.filepath}`,type:"warning",confirmHandlerPromise:r=>T(t.row.id).then(()=>{this.$refs.EditTable.search()})})}}]},searchFormProp:{formConfig:{labelWidth:"100px",labelPosition:"right",gutter:32}},formProp:{formConfig:{selectEditMode:!0,buttonPosition:"right"},buttons:[{type:"primary",label:"提交",handler:(e,t,r)=>e.formInstance.submitForm().then(a=>C(e.formData.id,a))}]},fields:[{type:"select",label:"ID",prop:"id",span:this.mobileMode?24:12,tableProps:{width:60},showInForm:!1},{type:"select",prop:"bid",label:"Bangumi",formProps:{remote:!0,filterable:!0,remoteMethod:e=>{e&&R(e).then(t=>{this.bangumiOptions=t.map(r=>({label:r.name||r.nname,subLabel:r.nname,value:r.subject}))})}},tableProps:{width:250,formatter:(e,t,r)=>{var a,o;return((a=e.bangumi)==null?void 0:a.name)||((o=e.bangumi)==null?void 0:o.nname)}},showInForm:!0,options:()=>this.bangumiOptions,span:this.mobileMode?24:12},{type:"number",prop:"ep",label:"集数",formProps:{min:0},showInForm:!1,tableProps:{width:80}},{type:"date-picker",prop:"start",label:"开始时间",showInForm:!1,tableProps:{width:120,formatter:(e,t,r)=>this.secondsToTimeString(r)}},{type:"date-picker",prop:"end",label:"结束时间",showInForm:!1,tableProps:{width:120,formatter:(e,t,r)=>this.secondsToTimeString(r)}},{type:"select",prop:"tags",valueSplitChar:",",formProps:{multiple:!0,filterable:!0},span:this.mobileMode?24:12,optionsBaseCode:"VIDEO_TAG",label:"标签"},{type:"buttons",showInTable:!1,showInForm:e=>e.meta.isSearchForm===!0,hiddenLabel:!0,label:"搜索操作",prop:"搜索操作",span:6,formItemProp:{labelWidth:"0px"},buttons:[{label:e=>this.isExSearch?"收起":"展开",leftIcon:e=>this.isExSearch?V:v,type:"primary",buttonProps:{link:!0},handler:e=>{this.isExSearch=!this.isExSearch}},{label:"查询",type:"primary",handler:e=>{const{meta:t}=e,{_editTable:r}=t,{editTableInstance:a}=r;a.search()}},{label:"重置",type:"primary",buttonProps:{plain:!0},handler:e=>{const{meta:t}=e,{_editTable:r}=t,{editTableInstance:a}=r;a.search({reset:!0})}}]}]}},methods:{onLoad(e,t){return E({size:e.size,page:e.current,andLike:{tags:t.tags||void 0},andEqual:{bid:t.bid||void 0}}).then(r=>({tableData:r.records,total:r.total}))},secondsToTimeString(e){e=Math.max(0,e);const t=Math.floor(e%1*1e3),r=Math.floor(e),a=Math.floor(r/3600),o=Math.floor(r%3600/60),l=r%60,i=String(a).padStart(2,"0"),p=String(o).padStart(2,"0"),s=String(l).padStart(2,"0"),u=t>0?"."+String(t).padStart(3,"0"):"";return`${i}:${p}:${s}${u}`}}},z={class:"page"},K={class:"table-top"};function j(e,t,r,a,o,l){const i=n("PageHeader"),p=n("el-button"),s=n("edit-table"),u=n("GPPRyonaCreateGroupDialog"),w=n("GPPRyonaVideoPreviewDialog");return c(),_("div",z,[d(i),d(s,{ref:"EditTable",modelValue:o.tableData,"onUpdate:modelValue":t[1]||(t[1]=f=>o.tableData=f),selected:o.selected,"onUpdate:selected":t[2]||(t[2]=f=>o.selected=f),"show-search-form":!0,fields:o.fields,"table-prop":o.tableProp,"search-form-prop":o.searchFormProp,"form-prop":o.formProp,"search-loader":l.onLoad},{"table-top":m(()=>[P("div",K,[d(p,{disabled:o.selected.length<2,type:"primary",onClick:t[0]||(t[0]=()=>{e.$refs.GPPRyonaCreateGroupDialog.open({materials:o.selected})})},{default:m(()=>[k(" 生成集合 ")]),_:1},8,["disabled"])])]),_:1},8,["modelValue","selected","fields","table-prop","search-form-prop","form-prop","search-loader"]),d(u,{ref:"GPPRyonaCreateGroupDialog"},null,512),d(w,{ref:"GPPRyonaVideoPreviewDialog"},null,512)])}const ee=g(W,[["render",j],["__scopeId","data-v-7a506d3c"]]);export{ee as default};
