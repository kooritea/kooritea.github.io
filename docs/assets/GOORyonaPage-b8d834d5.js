import{P}from"./PageHeader-91feca81.js";import{_ as C,L as U,Z as L,A as T,$ as x,a0 as I,M,a1 as F,a2 as B}from"./index-f279b7cc.js";import{cd as f,aR as p,bz as b,bY as O,bA as c,aT as _,bG as m,bD as S,bE as g,bF as D,aS as y,cS as N,cT as A}from"./vendor-5d98ec45.js";import"./element-plus-2fbd5573.js";import"./highlightjs-4914df6f.js";const E={components:{LoadingIcon:U},props:{modelValue:{type:[String,Array],default:void 0},checkMode:{type:String,default:()=>""}},emits:["update:modelValue"],data(){return{loading:!1,useFileFilter:!0,tableData:[],currentPath:"/"}},computed:{filterTableData(){return this.tableData.filter(e=>this.fileFilter&&this.useFileFilter&&e.type==="file"?this.fileFilter(e):!0)}},watch:{modelValue:{immediate:!0,handler(e){if(e){const t=e.slice(0,e.lastIndexOf("/"));this.currentPath!==t&&this.load(t)}}}},created(){this.load(this.currentPath)},methods:{onCellClick(e,t,r,i){t.property==="name"&&(e.type==="dir"?this.load(e.path):e.type==="file"&&this.$emit("update:modelValue",e.path))},onSelectionChange(){},load(e){this.loading=!0,this.loader(e).then(t=>{this.tableData=[...t].sort((r,i)=>{const o=r.type.localeCompare(i.type);return o!==0?o:r.name.localeCompare(i.name)}),e!=="/"&&this.tableData.unshift({type:"dir",name:"..",path:e.slice(0,e.slice(0,e.length-1).lastIndexOf("/"))||"/"}),this.currentPath=e}).finally(()=>{this.loading=!1})},loader(){throw new Error("loader需实现")}}};function R(e,t,r,i,o,n){const l=f("LoadingIcon"),d=f("el-table-column"),u=f("el-radio"),h=f("el-radio-group"),s=f("el-switch"),w=f("el-table");return p(),b(w,{border:"",data:n.filterTableData,style:{width:"100%"},onCellClick:n.onCellClick,onSelectionChange:n.onSelectionChange},O({default:c(()=>[r.checkMode==="multiple"?(p(),b(d,{key:0,type:"selection",selectable:a=>a.type==="file"},null,8,["selectable"])):S("",!0),r.checkMode==="single"?(p(),b(d,{key:1,width:"40px"},{default:c(a=>[a.row.path===r.modelValue?(p(),b(h,{key:0,"model-value":a.row.path},{default:c(()=>[m(u,{value:a.row.path},null,8,["value"])]),_:2},1032,["model-value"])):S("",!0)]),_:1})):S("",!0),m(d,{"class-name":"filename-cell","show-overflow-tooltip":"",prop:"name",label:"文件名"},{header:c(()=>[g(" 文件名 "),m(s,{modelValue:o.useFileFilter,"onUpdate:modelValue":t[0]||(t[0]=a=>o.useFileFilter=a),"active-text":"打开文件过滤"},null,8,["modelValue"])]),default:c(a=>[_("span",null,D(a.row.type==="dir"?"📁":"📄")+D(a.row.name),1)]),_:1})]),_:2},[o.loading?{name:"empty",fn:c(()=>[_("div",null,[m(l)])]),key:"0"}:void 0]),1032,["data","onCellClick","onSelectionChange"])}const H=C(E,[["render",R]]);const z={extends:H,methods:{loader(e){return L(e).then(t=>t.children)},fileFilter(e){return["mkv","mp4","mov"].includes(e.extname)}}},q=C(z,[["__scopeId","data-v-fbd94c47"]]);function $(e){return Math.floor(e)===e}function k(e){var t={times:1,num:0};if($(e))return t.num=e,t;var r=e+"",i=r.indexOf("."),o=r.substr(i+1).length,n=Math.pow(10,o),l=parseInt(e*n+.5,10);return t.times=n,t.num=l,t}function V(e,t,r){var i=k(e),o=k(t),n=i.num,l=o.num,d=i.times,u=o.times,h=d>u?d:u,s=null;switch(r){case"add":return d===u?s=n+l:d>u?s=n+l*(d/u):s=n*(u/d)+l,s/h;case"subtract":return d===u?s=n-l:d>u?s=n-l*(d/u):s=n*(u/d)-l,s/h;case"multiply":return s=n*l/(d*u),s;case"divide":return s=n/l*(u/d),s}}function j(e,t){return V(e,t,"add")}function G(e,t){return V(e,t,"subtract")}function J(e,t){return V(e,t,"multiply")}function W(e,t){return V(e,t,"divide")}const Y={add:j,subtract:G,multiply:J,divide:W};const Z={components:{PageHeader:P,AsyncButtom:T,MediaBrowser:q},data(){return{isInit:!0,screenshotsStore:{},previewVideoSrc:"",needUpdatePreviewVideoSrc:!1,canAutoUpdateEnd:!0,formConfig:{labelPosition:"top"},bangumiOptions:[],formData:{},fields:[{type:"select",prop:"bid",label:"Bangumi Id",formProps:{remote:!0,filterable:!0,remoteMethod:e=>{e&&x(e).then(t=>{this.bangumiOptions=t.map(r=>({label:r.name||r.nname,subLabel:r.nname,value:r.subject}))})}},options:()=>this.bangumiOptions,required:!0},{type:"number",prop:"ep",label:"集数",formProps:{min:0},required:!0},{type:"slot",prop:"sourcePath",slotName:"fileBrowser",label:"文件",required:!0,onChange:(e,t,r)=>{this.needUpdatePreviewVideoSrc=!0}},{type:"slot",slotName:"tsSelector",prop:"start",label:"开始时间",afterSlotName:"screenshots",buttons:[{type:"primary",label:"获取截图",handler:e=>this.getScreenshots(e.formData.sourcePath,e.field.prop)}],required:!0,defaultValue:()=>"00:00:00.0",onChange:(e,t,r)=>{this.needUpdatePreviewVideoSrc=!0,this.canAutoUpdateEnd&&(e.formData.end=e.formData.start),e.formData.thumbnail=e.formData.start}},{type:"slot",slotName:"tsSelector",prop:"end",label:"结束时间",afterSlotName:"screenshots",buttons:[{type:"primary",label:"获取截图",handler:e=>this.getScreenshots(e.formData.sourcePath,e.field.prop)}],required:!0,defaultValue:()=>"00:00:00.0",onChange:(e,t,r)=>{this.needUpdatePreviewVideoSrc=!0,r&&(this.canAutoUpdateEnd=!1)},rules:e=>[{validator:(t,r,i)=>{const o=this.timeStringToSeconds(r),n=this.timeStringToSeconds(e.formData.start);o<n?i(`结束时间[${o}]不能小于开始时间[${n}]`):i()},trigger:"blur"}]},{type:"slot",slotName:"previewVideo",hiddenLabel:!0,showInForm:e=>!!e.formData.sourcePath&&!!e.formData.start&&!!e.formData.end},{type:"select",prop:"tag",valueSplitChar:",",formProps:{multiple:!0,filterable:!0,allowCreate:!0},createOptionValidator:(e,t)=>{var r;return(r=t==null?void 0:t.startsWith)!=null&&r.call(t,"#")?!0:(this.$message({type:"warning",message:"tag必须为#开头",duration:5e3}),!1)},optionsBaseCode:"VIDEO_TAG",label:"标签"},{type:"slot",slotName:"tsSelector",prop:"thumbnail",afterSlotName:"screenshots",formProps:{multiple:!0},label:"封面",rules:e=>[{validator:(t,r,i)=>{const o=this.timeStringToSeconds(r),n=this.timeStringToSeconds(e.formData.start),l=this.timeStringToSeconds(e.formData.end);o===0?i():o<n?i(`封面时间[${o}]不能小于开始时间[${n}]`):o>l?i(`封面时间[${o}]不能大于结束时间[${l}]`):i()},trigger:"submit"}],buttons:[{type:"primary",label:"获取截图",handler:e=>this.getScreenshots(e.formData.sourcePath,e.field.prop)}],defaultValue:()=>"00:00:00.0"},{type:"number",prop:"previews",formProps:{multiple:!0},label:"预览图"}],buttons:[{type:"primary",label:"提交",handler:(e,t)=>e.formInstance.submitForm().then(r=>{localStorage.setItem("ryona-last",JSON.stringify(r));const i=this.timeStringToSeconds(r.start);let o=this.timeStringToSeconds(r.thumbnail);o&&(o=Math.max(Y.subtract(o,i),0));const n={...r,thumbnail:o};return n.tag||delete n.tag,I(n).then(()=>{M.success("提交成功，等待渲染和批准"),e.formInstance.resetFormData(),this.screenshotsStore={},this.previewVideoSrc="",this.needUpdatePreviewVideoSrc=!1,this.canAutoUpdateEnd=!0})})},{label:"恢复上次数据",handler:(e,t)=>{const r=localStorage.getItem("ryona-last");r&&(this.isInit=!1,e.formInstance.resetFormData(JSON.parse(r)),this.$nextTick(()=>{this.isInit=!0}))}}]}},methods:{timeStringToSeconds(e){const[t,r="0"]=e.split("."),[i,o,n]=t.split(":").map(Number),l=r.padEnd(3,"0");return i*3600+o*60+n+Number(l)/1e3},secondsToTimeString(e){e=Math.max(0,e);const t=Math.floor(e%1*1e3),r=Math.floor(e),i=Math.floor(r/3600),o=Math.floor(r%3600/60),n=r%60,l=String(i).padStart(2,"0"),d=String(o).padStart(2,"0"),u=String(n).padStart(2,"0"),h=t>0?"."+String(t).padStart(3,"0"):"";return`${l}:${d}:${u}${h}`},setTimestring(e,t){this.formData[e]=`${this.secondsToTimeString(this.timeStringToSeconds(this.formData[e].split(".")[0])+t)}.${this.formData[e].split(".")[1]}`},getScreenshots(e,t){return F(e,this.formData[t]).then(r=>{this.screenshotsStore[t]&&URL.revokeObjectURL(this.screenshotsStore[t]),this.screenshotsStore[t]=URL.createObjectURL(r)})},previewVideo(){return this.needUpdatePreviewVideoSrc=!1,B({sourcePath:this.formData.sourcePath,start:this.formData.start,end:this.formData.end}).then(e=>{this.previewVideoSrc&&URL.revokeObjectURL(this.previewVideoSrc),this.previewVideoSrc=URL.createObjectURL(e)})}}},K=e=>(N("data-v-0d5f0ed7"),e=e(),A(),e),Q={class:"page"},X=K(()=>_("span",null,".",-1)),ee={class:"screenshots-box"},te={class:"btn-box"},re=["src","onClick"],oe={class:"screenshots-video-box"},ae={class:"controls"},ne={key:0,class:"tips"},ie=["src"];function se(e,t,r,i,o,n){const l=f("PageHeader"),d=f("MediaBrowser"),u=f("el-time-picker"),h=f("el-input-number"),s=f("AsyncButtom"),w=f("EasyForm");return p(),y("div",Q,[m(l),o.isInit?(p(),b(w,{key:0,modelValue:o.formData,"onUpdate:modelValue":t[0]||(t[0]=a=>o.formData=a),fields:o.fields,buttons:o.buttons,"form-config":o.formConfig},{fileBrowser:c(a=>[m(d,{modelValue:a.formData[a.field.prop],"onUpdate:modelValue":v=>a.formData[a.field.prop]=v,checkMode:"single"},null,8,["modelValue","onUpdate:modelValue"])]),tsSelector:c(a=>[m(u,{"model-value":a.formData[a.field.prop].split(".")[0],"value-format":"HH:mm:ss",format:"HH:mm:ss",style:{width:"120px"},"onUpdate:modelValue":v=>{a.formData[a.field.prop]=`${v||"00:00:00"}.${a.formData[a.field.prop].split(".")[1]}`}},null,8,["model-value","onUpdate:modelValue"]),X,m(h,{"model-value":Number("0."+a.formData[a.field.prop].split(".")[1]),min:0,max:1,precision:3,step:.1,style:{width:"120px"},"onUpdate:modelValue":v=>{a.formData[a.field.prop]=`${a.formData[a.field.prop].split(".")[0]}.${String(v).split(".")[1]||0}`}},null,8,["model-value","step","onUpdate:modelValue"])]),screenshots:c(a=>[_("div",ee,[_("div",te,[m(s,{size:"mini",onLoadingClick:()=>n.setTimestring(a.field.prop,-60)},{default:c(()=>[g(" -1m ")]),_:2},1032,["onLoadingClick"]),m(s,{size:"mini",onLoadingClick:()=>n.setTimestring(a.field.prop,-10)},{default:c(()=>[g(" -10s ")]),_:2},1032,["onLoadingClick"]),m(s,{size:"mini",onLoadingClick:()=>n.setTimestring(a.field.prop,-1)},{default:c(()=>[g(" -1s ")]),_:2},1032,["onLoadingClick"]),m(s,{size:"mini",onLoadingClick:()=>n.setTimestring(a.field.prop,1)},{default:c(()=>[g(" +1s ")]),_:2},1032,["onLoadingClick"]),m(s,{size:"mini",onLoadingClick:()=>n.setTimestring(a.field.prop,10)},{default:c(()=>[g(" +10s ")]),_:2},1032,["onLoadingClick"]),m(s,{size:"mini",onLoadingClick:()=>n.setTimestring(a.field.prop,60)},{default:c(()=>[g(" +1m ")]),_:2},1032,["onLoadingClick"])]),o.screenshotsStore[a.field.prop]?(p(),y("img",{key:0,class:"image",src:o.screenshotsStore[a.field.prop],onClick:v=>e.$imagePreview(o.screenshotsStore[a.field.prop])},null,8,re)):S("",!0)])]),previewVideo:c(()=>[_("div",oe,[_("div",ae,[m(s,{type:"primary",onLoadingClick:()=>n.previewVideo()},{default:c(()=>[g(" 预览切片 ")]),_:1},8,["onLoadingClick"]),o.needUpdatePreviewVideoSrc?(p(),y("div",ne," 需要更新预览 ")):S("",!0)]),o.previewVideoSrc?(p(),y("video",{key:0,class:"video",controls:"",preload:"none",src:o.previewVideoSrc},null,8,ie)):S("",!0)])]),_:1},8,["modelValue","fields","buttons","form-config"])):S("",!0)])}const fe=C(Z,[["render",se],["__scopeId","data-v-0d5f0ed7"]]);export{fe as default};
