import{P as v}from"./PageHeader-8041b2bb.js";import{I as y}from"./ImageCon-9b57cd21.js";import{f as k}from"./float-7d62ecbe.js";import{_ as D,M as x,a8 as I}from"./index-f38ce9bb.js";import{cg as u,aR as S,aS as P,bD as d,bx as T,aT as f,cY as M,cZ as C}from"./vendor-cce75f21.js";import"./element-plus-40a28a03.js";import"./highlightjs-4914df6f.js";const p=[],h=[];function W(a){let e=p.find(t=>t.WorkerConstructor===a&&!t.running);return!e&&p.length<navigator.hardwareConcurrency-1&&(e={WorkerConstructor:a,worker:new a,running:!1},p.push(e)),e}function b(){if(h.length>0){const a=W(h[0].WorkerConstructor);if(a){const e=h.shift(),t=a.worker;a.running=!0,t.onmessage=function(o){switch(o.data.code){case"result":{e.resolve(o.data.data),a.running=!1,b();break}case"progress":{e.args.progress&&e.args.progress(o.data.data);break}default:e.reject("Unknow Result Code: "+o.data.code)}};const i={...e.args};delete i.progress,t.postMessage(i)}}}function _(a,e){return new Promise((t,i)=>{h.push({WorkerConstructor:a,resolve:t,reject:i,args:e}),b()})}const V=Object.freeze(Object.defineProperty({__proto__:null,addTask:_},Symbol.toStringTag,{value:"Module"}));function w(){return new Worker("https://kooritea.moe/assets/worker-7042d798.js")}async function $(a,e="vertical"){return new Promise((t,i)=>{const o=document.createElement("canvas"),n=o.getContext("2d"),r=new Image;r.onload=async()=>{o.width=r.width,o.height=r.height,n.drawImage(r,0,0,r.width,r.height,0,0,r.width,r.height),t({height:r.height,width:r.width,imageData:n.getImageData(0,0,r.width,r.height).data})},r.src=a instanceof File?URL.createObjectURL(a):a})}function g(a,e,t,i={}){for(const o in e){const n=e[o];for(const r in n){const s=n[r];i.thresholdValue!==void 0?a.fillStyle=i.thresholdValue>s[4]?"rgba(0,0,0,255)":"rgba(255,255,255,255)":a.fillStyle=`rgba(${s[0]},${s[1]},${s[2]},${s[3]})`,a.fillRect(r,t+Number(o),1,1)}}}async function N(a,e={}){e={...e,direction:e.direction??"vertical",pointDiffType:e.pointDiffType??"gray",sort:e.sort??"desc",skipLine:e.skipLine??10};const t=await Promise.all(a.map(n=>$(n,e.direction))),i=new Array(t.length-1).fill(0),o=(await Promise.all(t.slice(0,t.length-1).map((n,r)=>_(w,{cmd:"getMaxMatchOffset",data:{image1:t[r],image2:t[r+1],options:{direction:e.direction,pointDiffType:e.pointDiffType,sort:e.sort}},progress:s=>{i[r]=s;const l=i.reduce((m,c)=>k.add(m,c),0);e.progress(Number((l/i.length).toFixed(2)))}})))).map(n=>n.offset);if(e.canvas){const n=e.canvas.getContext("2d");if(e.direction==="vertical"?(e.canvas.width=t[0].width,e.canvas.height=t.reduce((r,s)=>r+s.height,0)-o.reduce((r,s)=>r+s,0)):(e.canvas.width=t.reduce((r,s)=>r+s.width,0)-o.reduce((r,s)=>r+s,0),e.canvas.height=t[0].height),e.sort==="desc"){let r=0;for(let s=0;s<o.length;s++){const l=o[s];s===0&&(g(n,t[s].colorData,r),r=r+t[s].height),g(n,t[s+1].colorData.slice(l-e.skipLine),r-e.skipLine),r=r+t[s+1].height-l}}else{let r=e.canvas.height;for(let s=0;s<o.length;s++){const l=o[s];s===0&&(r=r-t[s].height,g(n,t[s].colorData,r)),r=r-t[s+1].height+l,g(n,t[s+1].colorData.slice(0,t[s+1].colorData.length-l+e.skipLine),r)}}}}window.WorkerManager=V;window.DiffWorker=w;const F={components:{PageHeader:v,ImageCon:y},data(){return{progress:0,progressStatus:"",formConfig:{labelPosition:"top"},formData:{},fields:[{type:"radio",prop:"pointDiffType",label:"对比方法",required:!0,defaultValue:()=>"gray",options:()=>[{label:"灰度值(推荐，兼顾速度和准确性)",value:"gray"},{label:"色差(速度较慢)",value:"rgb"}]},{type:"radio",prop:"direction",label:"截图方向",afterSlotName:"direction-example",required:!0,defaultValue:()=>"vertical-desc",options:[{label:"从上到下",value:"vertical-desc"},{label:"从下到上",value:"vertical-asc"},{label:"从左到右(开发中)",value:"horizontal-desc",disabled:!0},{label:"从右到左(开发中)",value:"horizontal-asc",disabled:!0}]},{type:"upload",prop:"images",label:"截图",required:!0,formProps:{listType:"picture-card",multiple:!0},defaultValue:()=>[],rules:[{required:!0,trigger:"submit",validator:(a,e,t)=>{e.length>1?t():t("最少需要两张截图")}}]}],buttons:[{type:"primary",label:"合成",handler:(a,e)=>a.formInstance.submitForm().then(t=>{const[i,o]=t.direction.split("-");return this.progress=0,this.progressStatus="",this.$refs.result.width=0,this.$refs.result.height=0,N(t.images.map(n=>n.raw),{direction:i,pointDiffType:t.pointDiffType,sort:o,canvas:this.$refs.result,progress:n=>{this.progress=n}}).then(()=>{this.progressStatus="success"}).catch(n=>{throw this.progressStatus="exception",x.error(n),n})})},{type:"success",label:"下载",show:()=>this.progressStatus==="success",handler:(a,e)=>new Promise(t=>{this.$refs.result.toBlob(o=>{I(o,`${this.getMergeFileName(this.formData.images.map(n=>n.raw))}.png`),t()})})}]}},methods:{getMergeFileName(a){let e="";for(let t=0;t<a[0].name.length&&!a.some(i=>i.name[t]!==a[0].name[t]);t++)e+=a[0].name[t];return`${e}${["-","_"].includes(e[e.length-1])?"":"-"}merge`}}},L=a=>(M("data-v-37b6bb33"),a=a(),C(),a),j={class:"page"},O={class:"direction-example"},U=L(()=>f("span",null,"示例：",-1)),B={style:{"margin-top":"24px"}},R={ref:"result",style:{width:"100%","margin-top":"24px"}};function q(a,e,t,i,o,n){const r=u("PageHeader"),s=u("ImageCon"),l=u("EasyForm"),m=u("el-progress");return S(),P("div",j,[d(r),d(l,{modelValue:o.formData,"onUpdate:modelValue":e[0]||(e[0]=c=>o.formData=c),fields:o.fields,buttons:o.buttons,"form-config":o.formConfig},{"direction-example":T(c=>[f("div",O,[U,d(s,{src:`/assets/image-merge-${c.formData[c.field.prop]}-example.png`},null,8,["src"])])]),_:1},8,["modelValue","fields","buttons","form-config"]),f("div",B,[d(m,{percentage:o.progress,"text-inside":!0,"stroke-width":24,status:o.progressStatus},null,8,["percentage","status"]),f("canvas",R,null,512)])])}const J=D(F,[["render",q],["__scopeId","data-v-37b6bb33"]]);export{J as default};
