import{P as C}from"./PageHeader-49c40fcb.js";import{I as F}from"./ImageCon-29c2ddba.js";import{f as y}from"./float-54846448.js";import{_ as M}from"./index-886980f1.js";import{cg as d,aR as R,aS as L,bD as m,bx as O,aT as _,cY as A,cZ as q}from"./vendor-cce75f21.js";import"./element-plus-40a28a03.js";import"./highlightjs-4914df6f.js";const B=(n,r)=>n.reduce((e,t)=>(e[r.indexOf(t)]+=1,e),[...Array(r.length)].fill(0)),x=(n,r,e)=>{let t=0;for(let a=r;a<e;a+=1)t+=n[a];return t},E=n=>Array.from(new Set(n)).sort((r,e)=>r-e),D=(n,r,e,t)=>{let a=0;for(let o=r;o<e;o+=1)a+=n[o];return a/t},P=(n,r,e,t,a)=>{let o=0;for(let s=e;s<t;s+=1)o+=n[s]*r[s];return o*a},I=(n,r,e,t,a,o)=>{let s=0;for(let c=e;c<t;c+=1){const i=r[c]-a;s+=i*i*n[c]}return s*o},U=(n,r,e,t)=>n*r+e*t;function z(n){const r=n.map(s=>s.map(c=>c[4]).flat(1)).flat(1),e=E(r),t=B(r,e),{length:a}=r,o=[...Array(e.length)].map((s,c)=>{const l=c,u=c,h=t.length,g=1/x(t,0,l),f=1/x(t,u,h),b=D(t,0,l,a),v=I(t,e,0,l,P(t,e,0,l,g),g),N=D(t,u,h,a),V=I(t,e,u,h,P(t,e,u,h,f),f),w=U(b,v,N,V);return isNaN(w)?Number.POSITIVE_INFINITY:w});return e[o.indexOf(Math.min(...o))]}function G(n,r,e){return n*6966+r*23436+e*2366>>15}async function H(n,r="vertical"){return new Promise((e,t)=>{const a=document.createElement("canvas"),o=a.getContext("2d"),s=new Image;s.onload=async()=>{a.width=s.width,a.height=s.height,o.drawImage(s,0,0,s.width,s.height,0,0,s.width,s.height);const c=r==="vertical",i=o.getImageData(0,0,s.width,s.height),l=[];let u=-1,h=-1;for(let f=0;f<i.data.length;){u++,(l.length===0||l[l.length-1].length===s[c?"width":"height"])&&(l.push([]),h++,u=-1);const b=l[l.length-1],v=G(i.data[f],i.data[f+1],i.data[f+2]);b.push([i.data[f],i.data[f+1],i.data[f+2],i.data[f+3],v,"",[u,h]]),f+=4}const g=z(l);for(const f in l)for(u in l[f])l[f][u][5]=g>l[f][u][4]?"rgba(0,0,0,255)":"rgba(255,255,255,255)";e({height:s.height,width:s.width,otsuThresholdValue:g,colorData:l})},s.src=n instanceof File?URL.createObjectURL(n):n})}function T(n){const r=n.filter(t=>t.result).length,e=n.reduce((t,a)=>y.add(t,a.matchPerc),0);return{resultPerc:Number((r/n.length*100).toFixed(2)),matchPerc:Number((e/(100*n.length)*100).toFixed(2))}}function $(n,r,e={pointDiffType:"gray"}){if(e.pointDiffType==="rgb"){const t=(n[0]+r[0])/2,a=n[0]-r[0],o=n[1]-r[1],s=n[2]-r[2],c=Math.sqrt((2+t/256)*a**2+4*o**2+(2+(255-t)/256)*s**2);return{colorDistance:c,matchPerc:y.subtract(100,Number((c/764*100).toFixed(2))),result:c<5}}if(e.pointDiffType==="gray"){const t=y.subtract(100,Number((Math.abs(n[4]-r[4])/255*100).toFixed()));return{matchPerc:t,result:t>95}}if(e.pointDiffType==="otsu"){const t=n[5]===r[5];return{point1:n,point2:r,matchPerc:t?100:0,result:t}}}function S(n,r,e={}){const t=n.map((s,c)=>$(n[c],r[c],e)),{matchPerc:a,resultPerc:o}=T(t);return e._progressCompleteLine++,{lineDiffResult:t,matchPerc:a,resultPerc:o,result:a>95}}async function j(n,r,e,t={}){return new Promise(a=>{setTimeout(()=>{const o=[];for(let i=0;i<e;i++)if(t.sort==="desc"){const l=n.colorData[r.colorData.length-e+i],u=r.colorData[i];o.push(S(l,u,t))}else{const l=n.colorData[i],u=r.colorData[r.colorData.length-e+i];o.push(S(l,u,t))}const{matchPerc:s,resultPerc:c}=T(o);t.progress&&t.progress(t._progressCompleteLine,t._progressAllLine),a({areaDiffResult:o,matchPerc:s,resultPerc:c,result:s>95})})})}async function k(n,r,e={}){let t;for(let a=Math.max(1,e.startSearchSize??1);a<=(e.maxSearchSize||n.height);a++){const o=await j(n,r,a,e);if(t)t.matchPerc<o.matchPerc&&(t={...o,offset:a});else{t={...o,offset:a};continue}}return t}function p(n,r,e,t={}){for(const a in r){const o=r[a];for(const s in o){const c=o[s];t.thresholdValue!==void 0?n.fillStyle=t.thresholdValue>c[4]?"rgba(0,0,0,255)":"rgba(255,255,255,255)":n.fillStyle=`rgba(${c[0]},${c[1]},${c[2]},${c[3]})`,n.fillRect(s,e+Number(a),1,1)}}}async function Y(n,r={}){const e=await Promise.all(n.map(a=>H(a,r.direction)));r._progressCompleteLine=0,r._progressAllLine=(()=>{const a=e[0][r.direction==="vertical"?"height":"width"];return a*(1+a)/2*(e.length-1)})();const t=(await Promise.all(e.slice(0,e.length-1).map((a,o)=>k(e[o],e[o+1],r)))).map(a=>a.offset);if(r.canvas){const a=r.canvas.getContext("2d");if(r.canvas.width=1920,r.canvas.height=e.reduce((o,s)=>o+s[r.direction==="vertical"?"height":"width"],0)-t.reduce((o,s)=>o+s,0),r.sort==="desc"){let o=0;for(let s=0;s<t.length;s++){const c=t[s];s===0&&(p(a,e[s].colorData,o),o=o+e[s].height),p(a,e[s+1].colorData.slice(c-10),o-10),o=o+e[s+1].height-c}}else{let o=r.canvas.height;for(let s=0;s<t.length;s++){const c=t[s];s===0&&(o=o-e[s].height,p(a,e[s].colorData,o)),o=o-e[s+1].height+c,p(a,e[s+1].colorData.slice(0,e[s+1].colorData.length-c+10),o)}}}}const Z={components:{PageHeader:C,ImageCon:F},data(){return{progress:0,progressStatus:"",formConfig:{labelPosition:"top"},formData:{},fields:[{type:"radio",prop:"pointDiffType",label:"对比方法",required:!0,defaultValue:()=>"gray",options:()=>[{label:"灰度值(推荐，兼顾速度和准确性)",value:"gray"},{label:"色差(速度较慢)",value:"rgb"}]},{type:"radio",prop:"direction",label:"截图方向",afterSlotName:"direction-example",required:!0,defaultValue:()=>"vertical-desc",options:[{label:"从上到下",value:"vertical-desc"},{label:"从下到上",value:"vertical-asc"},{label:"从左到右(开发中)",value:"horizontal-desc",disabled:!0},{label:"从右到左(开发中)",value:"horizontal-asc",disabled:!0}]},{type:"upload",prop:"images",label:"截图",required:!0,formProps:{listType:"picture-card"},defaultValue:()=>[],rules:[{required:!0,trigger:"submit",validator:(n,r,e)=>{r.length>1?e():e("最少需要两张截图")}}]}],buttons:[{type:"primary",label:"合成",handler:(n,r)=>n.formInstance.submitForm().then(e=>{const[t,a]=e.direction.split("-");return this.progress=0,this.progressStatus="",Y(e.images.map(o=>o.raw),{direction:t,pointDiffType:e.pointDiffType,sort:a,canvas:this.$refs.result,progress:(o,s)=>{this.progress=Number((o/s*100).toFixed(2))}}).then(()=>{this.progressStatus}).catch(()=>{this.progressStatus})})}]}}},J=n=>(A("data-v-057a78c6"),n=n(),q(),n),K={class:"page"},Q={class:"direction-example"},W=J(()=>_("span",null,"示例：",-1)),X={style:{"margin-top":"24px"}},ee={ref:"result",style:{width:"100%","margin-top":"24px"}};function te(n,r,e,t,a,o){const s=d("PageHeader"),c=d("ImageCon"),i=d("EasyForm"),l=d("el-progress");return R(),L("div",K,[m(s),m(i,{modelValue:a.formData,"onUpdate:modelValue":r[0]||(r[0]=u=>a.formData=u),fields:a.fields,buttons:a.buttons,"form-config":a.formConfig},{"direction-example":O(u=>[_("div",Q,[W,m(c,{src:`/assets/image-merge-${u.formData[u.field.prop]}-example.png`},null,8,["src"])])]),_:1},8,["modelValue","fields","buttons","form-config"]),_("div",X,[m(l,{percentage:a.progress,"text-inside":!0,"stroke-width":24,status:a.progressStatus},null,8,["percentage","status"]),_("canvas",ee,null,512)])])}const ie=M(Z,[["render",te],["__scopeId","data-v-057a78c6"]]);export{ie as default};
