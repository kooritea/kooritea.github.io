import{P as D}from"./PageHeader-7caa23ad.js";import{_ as V,L as k,Z as P,A as L,$ as T,a0 as U,M as x,a1 as I,a2 as M}from"./index-ad83eafb.js";import{cd as c,aR as u,bz as y,bY as B,bA as l,aT as h,bG as d,bD as g,bF as C,aS as v,bE as f,cS as O,cT as N}from"./vendor-5d98ec45.js";import"./element-plus-2fbd5573.js";import"./highlightjs-4914df6f.js";const F={components:{LoadingIcon:k},props:{modelValue:{type:[String,Array],default:void 0},checkMode:{type:String,default:()=>""}},emits:["update:modelValue"],data(){return{loading:!1,tableData:[],currentPath:"/"}},watch:{modelValue:{immediate:!0,handler(e){if(e){const r=e.slice(0,e.lastIndexOf("/"));this.currentPath!==r&&this.load(r)}}}},created(){this.load(this.currentPath)},methods:{onCellClick(e,r,t,n){r.property==="name"&&(e.type==="dir"?this.load(e.path):e.type==="file"&&this.$emit("update:modelValue",e.path))},onSelectionChange(){},load(e){this.loading=!0,this.loader(e).then(r=>{this.tableData=[...r].sort((t,n)=>{const o=t.type.localeCompare(n.type);return o!==0?o:t.name.localeCompare(n.name)}),e!=="/"&&this.tableData.unshift({type:"dir",name:"..",path:e.slice(0,e.slice(0,e.length-1).lastIndexOf("/"))||"/"}),this.currentPath=e}).finally(()=>{this.loading=!1})},loader(){throw new Error("loader需实现")}}};function R(e,r,t,n,o,s){const m=c("LoadingIcon"),p=c("el-table-column"),S=c("el-radio"),b=c("el-table");return u(),y(b,{border:"",data:o.tableData,style:{width:"100%"},onCellClick:s.onCellClick,onSelectionChange:s.onSelectionChange},B({default:l(()=>[t.checkMode==="multiple"?(u(),y(p,{key:0,type:"selection",selectable:i=>i.type==="file"},null,8,["selectable"])):g("",!0),t.checkMode==="single"?(u(),y(p,{key:1,width:"40px"},{default:l(i=>[i.row.path===t.modelValue?(u(),y(S,{key:0,value:i.row.path},null,8,["value"])):g("",!0)]),_:1})):g("",!0),d(p,{"class-name":"filename-cell","show-overflow-tooltip":"",prop:"name",label:"文件名"},{default:l(i=>[h("span",null,C(i.row.type==="dir"?"📁":"📄")+C(i.row.name),1)]),_:1})]),_:2},[o.loading?{name:"empty",fn:l(()=>[h("div",null,[d(m)])]),key:"0"}:void 0]),1032,["data","onCellClick","onSelectionChange"])}const A=V(F,[["render",R]]);const H={extends:A,props:{showAllFile:{type:Boolean,default(){return!1}}},methods:{loader(e){return P(e).then(r=>r.children.filter(t=>this.showAllFile||t.type==="dir"?!0:["mkv","mp4"].includes(t.extname)).map(t=>({name:t.name,type:t.type,path:t.path})))}}},z=V(H,[["__scopeId","data-v-ad7fef14"]]);const E={components:{PageHeader:D,AsyncButtom:L,MediaBrowser:z},data(){return{screenshotsStore:{},previewVideoSrc:"",needUpdatePreviewVideoSrc:!1,formConfig:{labelPosition:"top"},bangumiOptions:[],formData:{},fields:[{type:"select",prop:"bid",label:"Bangumi Id",formProps:{remote:!0,filterable:!0,remoteMethod:e=>{e&&T(e).then(r=>{this.bangumiOptions=r.map(t=>({label:t.name||t.nname,subLabel:t.nname,value:t.subject}))})}},options:()=>this.bangumiOptions,required:!0},{type:"number",prop:"ep",label:"集数",formProps:{min:1},defaultValue:()=>1,required:!0},{type:"slot",prop:"sourcePath",slotName:"fileBrowser",label:"文件",required:!0,onChange:(e,r,t)=>{this.needUpdatePreviewVideoSrc=!0}},{type:"slot",slotName:"tsSelector",prop:"start",label:"开始时间",afterSlotName:"screenshots",buttons:[{type:"primary",label:"获取截图",handler:e=>this.getScreenshots(e.formData.sourcePath,e.field.prop)}],required:!0,defaultValue:()=>"00:00:00.0",onChange:(e,r,t)=>{this.needUpdatePreviewVideoSrc=!0,e.formData.end==="00:00:00.0"&&(e.formData.end=e.formData.start)}},{type:"slot",slotName:"tsSelector",prop:"end",label:"结束时间",afterSlotName:"screenshots",buttons:[{type:"primary",label:"获取截图",handler:e=>this.getScreenshots(e.formData.sourcePath,e.field.prop)}],required:!0,defaultValue:()=>"00:00:00.0",onChange:(e,r,t)=>{this.needUpdatePreviewVideoSrc=!0},rules:e=>[{validator:(r,t,n)=>{const o=this.timeStringToSeconds(t),s=this.timeStringToSeconds(e.formData.start);o<s?n(`结束时间[${o}]不能小于开始时间[${s}]`):n()},trigger:"blur"}]},{type:"slot",slotName:"previewVideo",hiddenLabel:!0,showInForm:e=>!!e.formData.sourcePath&&!!e.formData.start&&!!e.formData.end},{type:"select",prop:"tag",valueSplitChar:",",formProps:{multiple:!0,filterable:!0,allowCreate:!0},optionsBaseCode:"VIDEO_TAG",label:"标签"},{type:"slot",slotName:"tsSelector",prop:"thumbnail",afterSlotName:"screenshots",formProps:{multiple:!0},label:"封面",rules:e=>[{validator:(r,t,n)=>{const o=this.timeStringToSeconds(t),s=this.timeStringToSeconds(e.formData.start),m=this.timeStringToSeconds(e.formData.end);o===0?n():o<s?n(`封面时间[${o}]不能小于开始时间[${s}]`):o>m?n(`封面时间[${o}]不能大于结束时间[${m}]`):n()},trigger:"submit"}],buttons:[{type:"primary",label:"获取截图",handler:e=>this.getScreenshots(e.formData.sourcePath,e.field.prop)}],defaultValue:()=>"00:00:00.0"},{type:"number",prop:"previews",formProps:{multiple:!0},label:"预览图"}],buttons:[{type:"primary",label:"提交",handler:(e,r)=>e.formInstance.submitForm().then(t=>{localStorage.setItem("ryona-last",JSON.stringify(t));const n=this.timeStringToSeconds(t.start);let o=this.timeStringToSeconds(t.thumbnail);return o&&(o=Math.max(o-n,0)),U({...t,thumbnail:o}).then(()=>{x.success("提交成功，等待渲染和批准"),e.formInstance.resetFormData(),this.screenshotsStore={}})})},{label:"恢复上次数据",handler:(e,r)=>{const t=localStorage.getItem("ryona-last");t&&e.formInstance.resetFormData(JSON.parse(t))}}]}},methods:{timeStringToSeconds(e){const r=e.split(":"),t=parseInt(r[0],10),n=parseInt(r[1],10),o=parseInt(r[2],10);return t*3600+n*60+o},secondsToTimeString(e){e=Math.max(0,e);const r=Math.floor(e%1*1e3),t=Math.floor(e),n=Math.floor(t/3600),o=Math.floor(t%3600/60),s=t%60,m=String(n).padStart(2,"0"),p=String(o).padStart(2,"0"),S=String(s).padStart(2,"0"),b=r>0?"."+String(r).padStart(3,"0"):"";return`${m}:${p}:${S}${b}`},setTimestring(e,r){this.formData[e]=`${this.secondsToTimeString(this.timeStringToSeconds(this.formData[e].split(".")[0])+r)}.${this.formData[e].split(".")[1]}`},getScreenshots(e,r){return this.screenshotsStore[r]&&URL.revokeObjectURL(this.screenshotsStore[r]),I(e,this.formData[r]).then(t=>{this.screenshotsStore[r]=URL.createObjectURL(t)})},previewVideo(){return this.previewVideoSrc&&URL.revokeObjectURL(this.previewVideoSrc),this.needUpdatePreviewVideoSrc=!1,M({sourcePath:this.formData.sourcePath,start:this.formData.start,end:this.formData.end}).then(e=>{this.previewVideoSrc=URL.createObjectURL(e)})}}},$=e=>(O("data-v-4efe33e9"),e=e(),N(),e),j={class:"page"},q=$(()=>h("span",null,".",-1)),G={class:"screenshots-box"},J={class:"btn-box"},Y=["src","onClick"],Z={class:"screenshots-video-box"},K={class:"controls"},Q={key:0,class:"tips"},W=["src"];function X(e,r,t,n,o,s){const m=c("PageHeader"),p=c("MediaBrowser"),S=c("el-time-picker"),b=c("el-input-number"),i=c("AsyncButtom"),w=c("EasyForm");return u(),v("div",j,[d(m),d(w,{modelValue:o.formData,"onUpdate:modelValue":r[0]||(r[0]=a=>o.formData=a),fields:o.fields,buttons:o.buttons,"form-config":o.formConfig},{fileBrowser:l(a=>[d(p,{modelValue:a.formData[a.field.prop],"onUpdate:modelValue":_=>a.formData[a.field.prop]=_,checkMode:"single"},null,8,["modelValue","onUpdate:modelValue"])]),tsSelector:l(a=>[d(S,{"model-value":a.formData[a.field.prop].split(".")[0],"value-format":"HH:mm:ss",format:"HH:mm:ss",style:{width:"120px"},"onUpdate:modelValue":_=>{a.formData[a.field.prop]=`${_}.${a.formData[a.field.prop].split(".")[1]}`}},null,8,["model-value","onUpdate:modelValue"]),q,d(b,{"model-value":Number("0."+a.formData[a.field.prop].split(".")[1]),min:0,max:1,precision:3,step:.1,style:{width:"120px"},"onUpdate:modelValue":_=>{a.formData[a.field.prop]=`${a.formData[a.field.prop].split(".")[0]}.${String(_).split(".")[1]||0}`}},null,8,["model-value","step","onUpdate:modelValue"])]),screenshots:l(a=>[h("div",G,[h("div",J,[d(i,{size:"mini",onLoadingClick:()=>s.setTimestring(a.field.prop,-60)},{default:l(()=>[f(" -1m ")]),_:2},1032,["onLoadingClick"]),d(i,{size:"mini",onLoadingClick:()=>s.setTimestring(a.field.prop,-10)},{default:l(()=>[f(" -10s ")]),_:2},1032,["onLoadingClick"]),d(i,{size:"mini",onLoadingClick:()=>s.setTimestring(a.field.prop,-1)},{default:l(()=>[f(" -1s ")]),_:2},1032,["onLoadingClick"]),d(i,{size:"mini",onLoadingClick:()=>s.setTimestring(a.field.prop,1)},{default:l(()=>[f(" +1s ")]),_:2},1032,["onLoadingClick"]),d(i,{size:"mini",onLoadingClick:()=>s.setTimestring(a.field.prop,10)},{default:l(()=>[f(" +10s ")]),_:2},1032,["onLoadingClick"]),d(i,{size:"mini",onLoadingClick:()=>s.setTimestring(a.field.prop,60)},{default:l(()=>[f(" +1m ")]),_:2},1032,["onLoadingClick"])]),o.screenshotsStore[a.field.prop]?(u(),v("img",{key:0,class:"image",src:o.screenshotsStore[a.field.prop],onClick:_=>e.$imagePreview(o.screenshotsStore[a.field.prop])},null,8,Y)):g("",!0)])]),previewVideo:l(()=>[h("div",Z,[h("div",K,[d(i,{type:"primary",onLoadingClick:()=>s.previewVideo()},{default:l(()=>[f(" 预览切片 ")]),_:1},8,["onLoadingClick"]),o.needUpdatePreviewVideoSrc?(u(),v("div",Q," 需要更新预览 ")):g("",!0)]),o.previewVideoSrc?(u(),v("video",{key:0,class:"video",controls:"",preload:"none",src:o.previewVideoSrc},null,8,W)):g("",!0)])]),_:1},8,["modelValue","fields","buttons","form-config"])])}const ne=V(E,[["render",X],["__scopeId","data-v-4efe33e9"]]);export{ne as default};
