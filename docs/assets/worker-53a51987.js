(function(){"use strict";function y(e){return Math.floor(e)===e}function m(e){var t={times:1,num:0};if(y(e))return t.num=e,t;var r=e+"",a=r.indexOf("."),c=r.substr(a+1).length,i=Math.pow(10,c),n=parseInt(e*i+.5,10);return t.times=i,t.num=n,t}function d(e,t,r){var a=m(e),c=m(t),i=a.num,n=c.num,s=a.times,o=c.times,l=s>o?s:o,f=null;switch(r){case"add":return s===o?f=i+n:s>o?f=i+n*(s/o):f=i*(o/s)+n,f/l;case"subtract":return s===o?f=i-n:s>o?f=i-n*(s/o):f=i*(o/s)-n,f/l;case"multiply":return f=i*n/(s*o),f;case"divide":return f=i/n*(o/s),f}}function w(e,t){if(typeof e!="number"||typeof t!="number")throw new Error("args error");return d(e,t,"add")}function D(e,t){if(typeof e!="number"||typeof t!="number")throw new Error("args error");return d(e,t,"subtract")}function P(e,t){if(typeof e!="number"||typeof t!="number")throw new Error("args error");return d(e,t,"multiply")}function b(e,t){if(typeof e!="number"||typeof t!="number")throw new Error("args error");return d(e,t,"divide")}var h={add:w,subtract:D,multiply:P,divide:b};let g=0;function M(e,t,r={}){let a;for(let c=Math.max(1,r.startSearchSize??1);c<=(r.maxSearchSize||e.height);c++){const i=x(e,t,c,r);if(a)a.matchPerc<i.matchPerc&&(a={...i,offset:c});else{a={...i,offset:c};continue}const n=Date.now();n>g+1e3&&(g=n,self.postMessage({code:"progress",data:Number((r._progressCompleteLine/r._progressAllLine*100).toFixed(2))}))}return a}function x(e,t,r,a={}){const c=[];for(let n=0;n<r;n++)if(a.direction==="vertical"){let s=0,o=0;a.sort==="desc"?(s=e.width*(e.height-r+n),o=t.width*n):(s=e.width*n,o=t.width*(t.height-r+n));const l=[],f=[];for(let u=0;u<e.width;u++)l.push([e.imageData[(s+u)*4],e.imageData[(s+u)*4+1],e.imageData[(s+u)*4+2],e.imageData[(s+u)*4+3]]),f.push([t.imageData[(o+u)*4],t.imageData[(o+u)*4+1],t.imageData[(o+u)*4+2],t.imageData[(o+u)*4+3]]);c.push(S(l,f,a))}const{matchPerc:i}=v(c);return{matchPerc:i}}function S(e,t,r={}){const a=e.map((i,n)=>L(e[n],t[n],r)),{matchPerc:c}=v(a);return r._progressCompleteLine++,{matchPerc:c}}function p(e,t,r){return e*6966+t*23436+r*2366>>15}function L(e,t,r={pointDiffType:"gray"}){if(r.pointDiffType==="rgb"){const a=(e[0]+t[0])/2,c=e[0]-t[0],i=e[1]-t[1],n=e[2]-t[2],s=Math.sqrt((2+a/256)*c**2+4*i**2+(2+(255-a)/256)*n**2);return{colorDistance:s,matchPerc:h.subtract(100,Number((s/764*100).toFixed(2)))}}if(r.pointDiffType==="gray"){const a=p(...e),c=p(...t);return{matchPerc:h.subtract(100,Number((Math.abs(a-c)/255*100).toFixed()))}}if(r.pointDiffType==="otsu")return{matchPerc:e[4]===t[4]?100:0}}function v(e){const t=e.reduce((r,a)=>h.add(r,a.matchPerc),0);return{matchPerc:Number((t/(100*e.length)*100).toFixed(2))}}self.addEventListener("message",function(e){const t=e.data;switch(t.cmd){case"getMaxMatchOffset":{const r=t.data.options;r._progressCompleteLine=0;const a=t.data.image1[r.direction==="vertical"?"height":"width"],c=a*(1+a)/2;r._progressAllLine=c,self.postMessage({code:"result",data:M(t.data.image1,t.data.image2,r)});break}default:self.postMessage({code:"Unknow Cmd: "+t.cmd})}},!1)})();
