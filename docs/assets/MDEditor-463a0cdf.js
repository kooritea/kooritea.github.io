import{bB as L,aY as I,ch as x,aP as h,aQ as w,aR as u,bq as R,bT as j,bs as E,bt as B,bx as H,br as T,cs as q,b0 as z,b4 as G,a$ as K,aW as Q,bn as Y,cF as J,bw as X,bv as S,bp as F}from"./vendor-3ff22302.js";import{_ as O,S as W,a as Z,B as ee,u as te,j as ae,M as A,I as ne}from"./index-73f3ebbe.js";import{M as oe}from"./MarkDown-f6714ebf.js";import{I as se}from"./ImageCon-4444eb59.js";import{t as re,v as le,w as ce}from"./GreatOldOne-9695ecf4.js";import{a as ie}from"./element-plus-c96ac38f.js";import"./highlightjs-4914df6f.js";const de={components:{SvgIcon:W,ImageCon:se},props:{init:{type:Boolean,default:!0},prefix:{type:[String,Array],default:"https://cdn.jsdelivr.net/gh/kooritea/kooritea.github.io/emoji/"}},emits:["select"],setup(s,{emit:r}){const{emoteHistory:d}=Z(),t=L({name:"history",emote:d.value}),a=L([]);a.push(t);const f=I("history"),p=e=>{if(f.value=e.name,e.emote.length===0)return le(e.name).then(m=>{f.value=e.name,e.emote=m.emote.map(g=>({...g,scope:e.name}))})};return re().then(e=>{a.push(...e.sort((m,g)=>{const l=d.value.findIndex(b=>b.scope===m.name),k=d.value.findIndex(b=>b.scope===g.name);return(l===-1?1/0:l)-(k===-1?1/0:k)}))}),{onSelect:e=>{r("select",e),d.value=d.value.filter(m=>!(m.scope===e.scope&&m.name===e.name)),d.value=[e,...d.value].slice(0,30),t.emote=d.value},currentScope:f,emotePackages:a,selectScope:p}}},ue={class:"emote-selector"},me={class:"emotes"},he={class:"scopes"},fe=["onClick"];function pe(s,r,d,t,a,f){const p=x("ImageCon"),v=x("SvgIcon");return h(),w("div",ue,[u("div",me,[(h(!0),w(R,null,j((t.emotePackages.find(e=>e.name===t.currentScope)||{}).emote||[],e=>(h(),E(p,{key:e.name,class:"emote",alt:e.name,src:`${e.scope}/${e.name}.png`,prefix:d.prefix,onClick:m=>t.onSelect(e)},{error:B(()=>[u("span",null,H(e.name),1)]),_:2},1032,["alt","src","prefix","onClick"]))),128))]),u("div",he,[(h(!0),w(R,null,j(t.emotePackages,e=>(h(),w("div",{key:e.name,class:T(["scope",{"selected-scope":t.currentScope===e.name}]),onClick:m=>t.selectScope(e)},[e.name==="history"?(h(),E(v,{key:0,class:"emote history",name:"icon-icon-time"})):(h(),E(p,{key:1,class:"emote",src:`${e.name}/${e.name}.png`,prefix:d.prefix},{error:B(()=>[u("span",null,H(e.name),1)]),_:2},1032,["src","prefix"]))],10,fe))),128))])])}const ve=O(de,[["render",pe],["__scopeId","data-v-6d685589"]]);const $={},ge={components:{SvgIcon:W,Markdown:oe,ButtonBox:ee,EmoteSelector:ve,ElPopover:ie},props:{modelValue:{type:String,default:()=>""},title:{type:String,default:""},autoHeight:{type:Boolean,default:!0},cache:{type:[String,Boolean],default:""},onSubmit:{type:Function,default:()=>{}},showDefaultHandlers:{type:[Boolean,Array],default:()=>!0},exHandlers:{type:Array,default:()=>[]}},setup(s,{emit:r}){const{darkMode:d}=te(),t=I(!0),{computedModelValue:a}=ae(s,r),f=I(!1),p=I(null);if(s.cache){const n=q();if($[n.fullPath]&&s.cache===!0)A.error("当前页面存在两个需要缓存的编辑器,需要为编辑器传入缓存唯一标识缓存功能才会工作！");else{const c="MDEditorCache."+(s.cache===!0?n.fullPath:`${n.fullPath}.${s.cache}`);a.value=localStorage.getItem(c);let o=null;z(()=>{$[c]=!0,o=setInterval(()=>{f.value=!0,localStorage.setItem(c,a.value||"")},1e3)}),G(()=>{$[c]=!1,clearInterval(o)}),K(a,()=>{f.value=!1})}}const v=n=>{const c=p.value.selectionStart,o=a.value.slice(0,c),_=a.value.slice(c);a.value=`${o}${n}${_}`},e=I(a.value),m=()=>{const n=s.onSubmit(a.value);return n instanceof Promise?n.then(()=>{a.value="",e.value=""}):(a.value="",e.value=""),n},g=()=>{a.value=""},l=()=>{a.value=e.value},k=[{name:"提交",type:"primary",handler:m,show:()=>Array.isArray(s.showDefaultHandlers)?s.showDefaultHandlers.includes("submit"):s.showDefaultHandlers,sort:10},{name:"清除",type:"danger",handler:g,confirm:{message:"确认清空内容?"},show:()=>Array.isArray(s.showDefaultHandlers)?s.showDefaultHandlers.includes("clean"):s.showDefaultHandlers,sort:20},{name:"重置",type:"default",handler:l,show:()=>(Array.isArray(s.showDefaultHandlers)?s.showDefaultHandlers.includes("reset"):s.showDefaultHandlers)&&!!e.value,sort:30}],b=Q(()=>[...k,...s.exHandlers]),D=n=>{const c=ne(URL.createObjectURL(n),{handlers:[{name:"上传",type:"primary",handler:()=>{const o=new Date().valueOf().toString();v(`![${o}](--------------------)`),ce(n,_=>{const y=Math.round(100*event.loaded/event.total)/10*2;a.value=a.value.replace(new RegExp(`\\!\\[${o}]\\((#*?)(-*?)\\)`),`![${o}](${"#".repeat(y)}${"-".repeat(20-y)})`)}).then(_=>{a.value=a.value.replace(new RegExp(`\\!\\[${o}]\\((#*?)(-*?)\\)`),`![${_.keyname}](${_.local})`)}).catch(()=>{a.value=a.value.replace(new RegExp(`\\!\\[${o}]\\((#*?)(-*?)\\)`),"")}),c.callClose()}},{name:"裁剪为16:9",type:"default",show:()=>{},handler:()=>{const o=document.createElement("canvas"),_=o.getContext("2d"),i=new Image;i.onload=async()=>{if(i.height*16===i.width*9)return;const y=i.height*16/9;if(y>i.width){const C=.5625*i.width;o.width=i.width,o.height=C,_.drawImage(i,0,(i.height-C)/2,i.width,C,0,0,i.width,C)}else o.width=y,o.height=i.height,_.drawImage(i,(i.width-y)/2,0,y,i.height,0,0,y,i.height);const U=o.toDataURL(n.type).split(","),N=U[0].match(/:(.*?);/)[1],V=atob(U[1]);let M=V.length;const P=new Uint8Array(M);for(;M--;)P[M]=V.charCodeAt(M);c.callClose(),D(new File([P],n.name,{type:N}))},i.src=URL.createObjectURL(n)}},{name:"取消",type:"default",handler:()=>{c.callClose()}}]})};return{darkMode:d,isEditMode:t,computedModelValue:a,resetCache:e,isSave:f,handlers:b,submitHandler:m,cleanHandler:g,resetHandler:l,previewImageBeforeUpload:D,pasteHandler:n=>{if(!(n.clipboardData&&n.clipboardData.items))return;const c=Array.from(n.clipboardData.items).filter(o=>o.kind==="file");if(c.length>0){n.preventDefault();for(const o of c)if(o.type.startsWith("image/")){D(o.getAsFile());return}else A.warning(`不支持的文件类型: ${o.type}`)}},dropHandler:n=>{for(const c of n.dataTransfer.files)if(n.preventDefault(),c.type.startsWith("image/")){D(c);return}else A.warning(`不支持的文件类型: ${c.type}`)},textarea:p,insertText:v}}},_e={class:"md-editor"},ye={class:"fill"},we={key:1,class:"preview"},xe={class:"bar"},be={class:"bar-left"},Se={class:"title"},Ie={class:"uploader"},He={class:"bar-right"},ke={key:0,class:"is-save info"};function De(s,r,d,t,a,f){const p=x("Markdown"),v=x("SvgIcon"),e=x("EmoteSelector"),m=x("el-popover"),g=x("ButtonBox");return h(),w(R,null,[u("div",_e,[t.isEditMode?(h(),w("div",{key:0,class:T(["textarea-box",{"auto-height":d.autoHeight}])},[u("pre",ye,H(t.computedModelValue),1),Y(u("textarea",{ref:"textarea","onUpdate:modelValue":r[0]||(r[0]=l=>t.computedModelValue=l),class:"textarea",onPaste:r[1]||(r[1]=(...l)=>t.pasteHandler&&t.pasteHandler(...l)),onDragover:r[2]||(r[2]=X(()=>{},["prevent"])),onDrop:r[3]||(r[3]=(...l)=>t.dropHandler&&t.dropHandler(...l))},null,544),[[J,t.computedModelValue]])],2)):(h(),w("div",we,[S(p,{"model-value":t.computedModelValue},null,8,["model-value"])])),u("div",xe,[u("div",be,[u("div",Se,H(d.title),1),u("label",Ie,[S(v,{class:"button",name:"icon-14"}),u("input",{type:"file",accept:"image/*",onChange:r[4]||(r[4]=l=>{t.previewImageBeforeUpload(l.srcElement.files[0]),l.srcElement.value=""})},null,32)]),S(m,{width:"auto",trigger:"click",effect:t.darkMode?"dark":"light"},{reference:B(()=>[S(v,{class:"button",name:"icon-biaoqing"})]),default:B(()=>[S(e,{onSelect:r[5]||(r[5]=l=>{t.insertText(`[emoji ${l.scope}/${l.name}]`)})})]),_:1},8,["effect"])]),u("div",He,[t.isSave?(h(),w("span",ke,"已保存")):F("",!0),u("span",{class:"preview-switch button",onClick:r[6]||(r[6]=l=>t.isEditMode=!t.isEditMode)},H(t.isEditMode?"预览":"返回编辑"),1)])])]),t.handlers.length>0?(h(),E(g,{key:0,handlers:t.handlers},null,8,["handlers"])):F("",!0)],64)}const Pe=O(ge,[["render",De],["__scopeId","data-v-07e209c0"]]);export{Pe as default};
