import{P as _}from"./PageHeader-45dfc559.js";import{I as y}from"./ImageCon-d1147a92.js";import{f as b}from"./float-7d62ecbe.js";import{_ as k,M as x,a8 as I}from"./index-d7a806f1.js";import{cg as g,aR as T,aS as D,bD as m,bx as S,aT as f,cY as P,cZ as C}from"./vendor-a6581121.js";import"./element-plus-a0aead36.js";import"./highlightjs-4914df6f.js";const w=[],p=[];function $(r){let e=w.find(t=>t.WorkerConstructor===r&&!t.running);return!e&&w.length<navigator.hardwareConcurrency-1&&(e={WorkerConstructor:r,worker:new r,running:!1},w.push(e)),e}function v(){if(p.length>0){const r=$(p[0].WorkerConstructor);if(r){const e=p.shift(),t=r.worker;r.running=!0,t.onmessage=function(s){switch(s.data.code){case"result":{e.resolve(s.data.data),r.running=!1,v();break}case"progress":{e.args.progress&&e.args.progress(s.data.data);break}default:e.reject("Unknow Result Code: "+s.data.code)}};const l={...e.args};delete l.progress,t.postMessage(l)}}}function M(r,e){return new Promise((t,l)=>{p.push({WorkerConstructor:r,resolve:t,reject:l,args:e}),v()})}function F(){return new Worker("https://kooritea.moe/assets/worker-53a51987.js")}async function V(r,e){return new Promise((t,l)=>{const s=document.createElement("canvas"),n=s.getContext("2d"),o=new Image;o.onload=async()=>{try{s.width=o.width,s.height=o.height,n.drawImage(o,0,0,o.width,o.height,0,0,o.width,o.height);const u=n.getImageData(0,0,o.width,o.height).data;t({height:o.height,width:o.width,imageData:u})}catch(u){l(u)}},o.src=r instanceof File?URL.createObjectURL(r):r})}function h(r,e,t,l,s=[]){const{imageData:n,width:o,height:u}=e,[i=0,a=l==="vertical"?u:o]=s;if(l==="vertical")for(let c=i*o;c<a*o;c++){const d=c*4;r.fillStyle=`rgba(${n[d]},${n[d+1]},${n[d+2]},${n[d+3]})`,r.fillRect(c%o,t+parseInt(c/o),1,1)}}async function W(r,e={}){e={...e,direction:e.direction??"vertical",pointDiffType:e.pointDiffType??"gray",sort:e.sort??"desc",skipLine:e.skipLine??10};const t=await Promise.all(r.map(n=>V(n)));if(Array.from(new Set(t.map(n=>n[e.direction==="vertical"?"width":"height"]))).length>1)throw new Error(`拼接方向为${e.direction==="vertical"?"纵向":"横向"}时所有图片的${e.direction==="vertical"?"宽度":"长度"}必须一致`);const l=new Array(t.length-1).fill(0),s=(await Promise.all(t.slice(0,t.length-1).map((n,o)=>M(F,{cmd:"getMaxMatchOffset",data:{image1:t[o],image2:t[o+1],options:{direction:e.direction,pointDiffType:e.pointDiffType,sort:e.sort}},progress:u=>{if(e.progress){l[o]=u;const i=l.reduce((a,c)=>b.add(a,c),0);e.progress(Number((i/l.length).toFixed(2)))}}})))).map(n=>n.offset);e.progress&&e.progress(100),e.canvas&&await new Promise((n,o)=>{setTimeout(()=>{try{const u=e.canvas.getContext("2d");if(e.direction==="vertical"?(e.canvas.width=t[0].width,e.canvas.height=t.reduce((i,a)=>i+a.height,0)-s.reduce((i,a)=>i+a,0)):(e.canvas.width=t.reduce((i,a)=>i+a.width,0)-s.reduce((i,a)=>i+a,0),e.canvas.height=t[0].height),e.sort==="desc"){let i=0;for(let a=0;a<s.length;a++){const c=s[a];a===0&&(h(u,t[a],i,e.direction),i=i+t[a].height),i=i-c,h(u,t[a+1],i,e.direction,[c-e.skipLine]),i=i+t[a+1].height}}else{let i=e.canvas.height;for(let a=0;a<s.length;a++){const c=s[a];a===0&&(i=i-t[a].height,h(u,t[a],i,e.direction)),i=i-t[a+1].height+c,h(u,t[a+1],i,e.direction,[0,t[a+1][e.direction==="vertical"?"height":"width"]-c+e.skipLine])}}n()}catch(u){o(u)}})})}const L={components:{PageHeader:_,ImageCon:y},data(){return{progress:0,progressStatus:"",startTime:0,endTime:0,formConfig:{labelPosition:"top"},formData:{},fields:[{type:"radio",prop:"pointDiffType",label:"对比方法",required:!0,defaultValue:()=>"gray",options:()=>[{label:"灰度值(推荐，兼顾速度和准确性)",value:"gray"},{label:"色差(速度较慢)",value:"rgb"}]},{type:"radio",prop:"direction",label:"截图方向",afterSlotName:"direction-example",required:!0,defaultValue:()=>"vertical-desc",options:[{label:"从上到下",value:"vertical-desc"},{label:"从下到上",value:"vertical-asc"},{label:"从左到右(开发中)",value:"horizontal-desc",disabled:!0},{label:"从右到左(开发中)",value:"horizontal-asc",disabled:!0}]},{type:"upload",prop:"images",label:"截图",required:!0,formProps:{listType:"picture-card",multiple:!0},defaultValue:()=>[],rules:[{required:!0,trigger:"submit",validator:(r,e,t)=>{e.length>1?t():t("最少需要两张截图")}}]},{type:"view",prop:"text",hiddenLabel:!0,viewer:()=>`可用线程数: ${navigator.hardwareConcurrency}`}],buttons:[{type:"primary",label:"合成",handler:(r,e)=>r.formInstance.submitForm().then(t=>{const[l,s]=t.direction.split("-");return this.startTime=Date.now(),this.endTime=0,this.progress=0,this.progressStatus="",this.$refs.result.width=0,this.$refs.result.height=0,W(t.images.map(n=>n.raw),{direction:l,pointDiffType:t.pointDiffType,sort:s,canvas:this.$refs.result,progress:n=>{this.progress=n}}).then(()=>{this.endTime=Date.now(),this.progressStatus="success"}).catch(n=>{throw this.progressStatus="exception",x.error(n==null?void 0:n.message),n})})},{type:"success",label:"下载",show:()=>this.progressStatus==="success",handler:(r,e)=>new Promise(t=>{this.$refs.result.toBlob(s=>{I(s,`${this.getMergeFileName(this.formData.images.map(n=>n.raw))}.png`),t()})})}]}},methods:{getMergeFileName(r){let e="";for(let t=0;t<r[0].name.length&&!r.some(l=>l.name[t]!==r[0].name[t]);t++)e+=r[0].name[t];return`${e}${["-","_"].includes(e[e.length-1])?"":"-"}merge`}}},N=r=>(P("data-v-4964eaf9"),r=r(),C(),r),E={class:"page"},U={class:"direction-example"},B=N(()=>f("span",null,"示例：",-1)),R={style:{"margin-top":"24px"}},q={ref:"result",style:{width:"100%","margin-top":"24px"}};function A(r,e,t,l,s,n){const o=g("PageHeader"),u=g("ImageCon"),i=g("EasyForm"),a=g("el-progress");return T(),D("div",E,[m(o),m(i,{modelValue:s.formData,"onUpdate:modelValue":e[0]||(e[0]=c=>s.formData=c),fields:s.fields,buttons:s.buttons,"form-config":s.formConfig},{"direction-example":S(c=>[f("div",U,[B,m(u,{src:`/assets/image-merge-${c.formData[c.field.prop]}-example.png`},null,8,["src"])])]),_:1},8,["modelValue","fields","buttons","form-config"]),f("div",R,[m(a,{percentage:s.progress,"text-inside":!0,"stroke-width":24,status:s.progressStatus,format:c=>!s.progressStatus&&c===100?"canvas渲染结果中":s.progressStatus==="success"?`成功，用时: ${((s.endTime-s.startTime)/1e3).toFixed(1)}s`:`${c}%`},null,8,["percentage","status","format"]),f("canvas",q,null,512)])])}const J=k(L,[["render",A],["__scopeId","data-v-4964eaf9"]]);export{J as default};
