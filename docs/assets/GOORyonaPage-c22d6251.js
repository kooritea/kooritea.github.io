import{P as I}from"./PageHeader-4a3be313.js";import{_ as M,L as U,Z as T,A as x,$ as k,a0 as E,M as L,a1 as F,a2 as O,a3 as B,a4 as N}from"./index-10604cd2.js";import{cg as f,aR as p,bw as w,c0 as A,bx as d,aT as y,bD as m,bA as b,bB as g,bC as D,aS as V,a_ as R,cY as q,cZ as H}from"./vendor-cce75f21.js";import"./element-plus-f8e054a6.js";import"./highlightjs-4914df6f.js";const z={components:{LoadingIcon:U},props:{modelValue:{type:[String,Array],default:void 0},checkMode:{type:String,default:()=>""}},emits:["update:modelValue"],data(){return{loading:!1,useFileFilter:!0,tableData:[],currentPath:"/"}},computed:{filterTableData(){return this.tableData.filter(e=>this.fileFilter&&this.useFileFilter&&e.type==="file"?this.fileFilter(e):!0)}},watch:{modelValue:{immediate:!0,handler(e){if(e){const t=e.slice(0,e.lastIndexOf("/"));this.currentPath!==t&&this.load(t)}}}},created(){this.load(this.currentPath)},methods:{onCellClick(e,t,r,s){t.property==="name"&&(e.type==="dir"?this.load(e.path):e.type==="file"&&this.$emit("update:modelValue",e.path))},onSelectionChange(){},load(e){this.loading=!0,this.loader(e).then(t=>{this.tableData=[...t].sort((r,s)=>{const i=r.type.localeCompare(s.type);return i!==0?i:r.name.localeCompare(s.name)}),e!=="/"&&this.tableData.unshift({type:"dir",name:"..",path:e.slice(0,e.slice(0,e.length-1).lastIndexOf("/"))||"/"}),this.currentPath=e}).finally(()=>{this.loading=!1})},loader(){throw new Error("loader需实现")}}};function j(e,t,r,s,i,o){const n=f("LoadingIcon"),l=f("el-table-column"),u=f("el-radio"),S=f("el-radio-group"),c=f("el-switch"),_=f("el-table");return p(),w(_,{border:"",data:o.filterTableData,style:{width:"100%"},onCellClick:o.onCellClick,onSelectionChange:o.onSelectionChange},A({default:d(()=>[r.checkMode==="multiple"?(p(),w(l,{key:0,type:"selection",selectable:h=>h.type==="file"},null,8,["selectable"])):b("",!0),r.checkMode==="single"?(p(),w(l,{key:1,width:"40px"},{default:d(h=>[h.row.path===r.modelValue?(p(),w(S,{key:0,"model-value":h.row.path},{default:d(()=>[m(u,{value:h.row.path},null,8,["value"])]),_:2},1032,["model-value"])):b("",!0)]),_:1})):b("",!0),m(l,{"class-name":"filename-cell","show-overflow-tooltip":"",prop:"name",label:"文件名"},{header:d(()=>[g(" 文件名 "),m(c,{modelValue:i.useFileFilter,"onUpdate:modelValue":t[0]||(t[0]=h=>i.useFileFilter=h),"active-text":"打开文件过滤"},null,8,["modelValue"])]),default:d(h=>[y("span",null,D(h.row.type==="dir"?"📁":"📄")+D(h.row.name),1)]),_:1})]),_:2},[i.loading?{name:"empty",fn:d(()=>[y("div",null,[m(n)])]),key:"0"}:void 0]),1032,["data","onCellClick","onSelectionChange"])}const G=M(z,[["render",j]]);const J={extends:G,methods:{loader(e){return T(e).then(t=>t.children)},fileFilter(e){return["mkv","mp4","mov"].includes(e.extname)}}},Z=M(J,[["__scopeId","data-v-fbd94c47"]]);function W(e){return Math.floor(e)===e}function C(e){var t={times:1,num:0};if(W(e))return t.num=e,t;var r=e+"",s=r.indexOf("."),i=r.substr(s+1).length,o=Math.pow(10,i),n=parseInt(e*o+.5,10);return t.times=o,t.num=n,t}function P(e,t,r){var s=C(e),i=C(t),o=s.num,n=i.num,l=s.times,u=i.times,S=l>u?l:u,c=null;switch(r){case"add":return l===u?c=o+n:l>u?c=o+n*(l/u):c=o*(u/l)+n,c/S;case"subtract":return l===u?c=o-n:l>u?c=o-n*(l/u):c=o*(u/l)-n,c/S;case"multiply":return c=o*n/(l*u),c;case"divide":return c=o/n*(u/l),c}}function Y(e,t){return P(e,t,"add")}function $(e,t){return P(e,t,"subtract")}function K(e,t){return P(e,t,"multiply")}function Q(e,t){return P(e,t,"divide")}const X={add:Y,subtract:$,multiply:K,divide:Q};const ee={components:{PageHeader:I,AsyncButtom:x,MediaBrowser:Z},data(){return{isInit:!0,screenshotsStore:{},previewVideoSrc:"",needUpdatePreviewVideoSrc:!1,canAutoUpdateEnd:!0,formConfig:{labelPosition:"top"},bangumiOptions:[],editTargetOptions:[],editingProps:[],formData:{},fields:[{type:"switch",label:"编辑模式",prop:"useEditMode",defaultValue:()=>!1,required:!0,dontCheckEdit:!0},{type:"select",label:"编辑目标",prop:"id",showInForm:e=>!!e.formData.useEditMode,required:!0,dontCheckEdit:!0,options:()=>this.editTargetOptions,onCreated:()=>{k().then(e=>{this.editTargetOptions=e.map(t=>({label:t.filepath.slice(1),value:t.id}))})},formProps:{remote:!0,filterable:!0,remoteMethod:e=>{k({keyword:e}).then(t=>{this.editTargetOptions=t.map(r=>({label:r.filepath.slice(1),value:r.id}))})}}},{type:"select",prop:"bid",label:"Bangumi Id",formProps:{remote:!0,filterable:!0,remoteMethod:e=>{e&&E(e).then(t=>{this.bangumiOptions=t.map(r=>({label:r.name||r.nname,subLabel:r.nname,value:r.subject}))})}},options:()=>this.bangumiOptions,required:e=>!e.formData.useEditMode||this.editingProps.includes("bid"),disabled:e=>e.formData.useEditMode&&!this.editingProps.includes("bid")},{type:"number",prop:"ep",label:"集数",formProps:{min:0},required:e=>!e.formData.useEditMode||this.editingProps.includes("ep"),disabled:e=>e.formData.useEditMode&&!this.editingProps.includes("ep")},{type:"slot",prop:"sourcePath",slotName:"fileBrowser",label:"文件",required:!0,onChange:(e,t,r)=>{this.needUpdatePreviewVideoSrc=!0},showInForm:e=>!e.formData.useEditMode},{type:"slot",slotName:"tsSelector",prop:"start",label:"开始时间",afterSlotName:"screenshots",buttons:[{type:"primary",label:"获取截图",handler:e=>this.getScreenshots(e.formData.sourcePath,e.field.prop)}],required:!0,defaultValue:()=>"00:00:00.0",onChange:(e,t,r)=>{this.needUpdatePreviewVideoSrc=!0,this.canAutoUpdateEnd&&(e.formData.end=e.formData.start),e.formData.thumbnail=e.formData.start},showInForm:e=>!e.formData.useEditMode},{type:"slot",slotName:"tsSelector",prop:"end",label:"结束时间",afterSlotName:"screenshots",buttons:[{type:"primary",label:"获取截图",handler:e=>this.getScreenshots(e.formData.sourcePath,e.field.prop)}],required:!0,defaultValue:()=>"00:00:00.0",onChange:(e,t,r)=>{this.needUpdatePreviewVideoSrc=!0,r&&(this.canAutoUpdateEnd=!1)},rules:e=>[{validator:(t,r,s)=>{const i=this.timeStringToSeconds(r),o=this.timeStringToSeconds(e.formData.start);i<o?s(`结束时间[${i}]不能小于开始时间[${o}]`):s()},trigger:"blur"}],showInForm:e=>!e.formData.useEditMode},{type:"slot",slotName:"previewVideo",hiddenLabel:!0,showInForm:e=>!!e.formData.sourcePath&&!!e.formData.start&&!!e.formData.end},{type:"select",prop:"tag",valueSplitChar:",",formProps:{multiple:!0,filterable:!0,allowCreate:!0},createOptionValidator:(e,t)=>{var r;return(r=t==null?void 0:t.startsWith)!=null&&r.call(t,"#")?!0:(this.$message({type:"warning",message:"tag必须为#开头",duration:5e3}),!1)},optionsBaseCode:"VIDEO_TAG",label:"标签",required:e=>e.formData.useEditMode&&this.editingProps.includes("tag"),disabled:e=>e.formData.useEditMode&&!this.editingProps.includes("tag")},{type:"slot",slotName:"tsSelector",prop:"thumbnail",afterSlotName:"screenshots",formProps:{multiple:!0},label:"封面",rules:e=>[{validator:(t,r,s)=>{const i=this.timeStringToSeconds(r),o=this.timeStringToSeconds(e.formData.start),n=this.timeStringToSeconds(e.formData.end);i===0?s():i<o?s(`封面时间[${i}]不能小于开始时间[${o}]`):i>n?s(`封面时间[${i}]不能大于结束时间[${n}]`):s()},trigger:"submit"}],buttons:[{type:"primary",label:"获取截图",handler:e=>this.getScreenshots(e.formData.sourcePath,e.field.prop)}],defaultValue:()=>"00:00:00.0",showInForm:e=>!e.formData.useEditMode},{type:"number",prop:"previews",formProps:{multiple:!0},label:"预览图",showInForm:e=>!e.formData.useEditMode}],buttons:[{type:"primary",label:"提交",handler:(e,t)=>e.formInstance.submitForm().then(r=>(r.useEditMode?this.editMaterial(e,r):this.createMaterial(e,r)).then(()=>{L.success("提交成功"),e.formInstance.resetFormData(),this.editingProps=[],this.screenshotsStore={},this.previewVideoSrc="",this.needUpdatePreviewVideoSrc=!1,this.canAutoUpdateEnd=!0}))},{label:"恢复上次数据",handler:(e,t)=>{const r=localStorage.getItem("ryona-last");r&&(this.isInit=!1,e.formInstance.resetFormData(JSON.parse(r)),this.$nextTick(()=>{this.isInit=!0}))}}]}},methods:{timeStringToSeconds(e){const[t,r="0"]=e.split("."),[s,i,o]=t.split(":").map(Number),n=r.padEnd(3,"0");return s*3600+i*60+o+Number(n)/1e3},secondsToTimeString(e){e=Math.max(0,e);const t=Math.floor(e%1*1e3),r=Math.floor(e),s=Math.floor(r/3600),i=Math.floor(r%3600/60),o=r%60,n=String(s).padStart(2,"0"),l=String(i).padStart(2,"0"),u=String(o).padStart(2,"0"),S=t>0?"."+String(t).padStart(3,"0"):"";return`${n}:${l}:${u}${S}`},setTimestring(e,t){this.formData[e]=`${this.secondsToTimeString(this.timeStringToSeconds(this.formData[e].split(".")[0])+t)}.${this.formData[e].split(".")[1]}`},getScreenshots(e,t){return F(e,this.formData[t]).then(r=>{this.screenshotsStore[t]&&URL.revokeObjectURL(this.screenshotsStore[t]),this.screenshotsStore[t]=URL.createObjectURL(r)})},previewVideo(){return this.needUpdatePreviewVideoSrc=!1,O({sourcePath:this.formData.sourcePath,start:this.formData.start,end:this.formData.end}).then(e=>{this.previewVideoSrc&&URL.revokeObjectURL(this.previewVideoSrc),this.previewVideoSrc=URL.createObjectURL(e)})},createMaterial(e,t){localStorage.setItem("ryona-last",JSON.stringify(t));const r=this.timeStringToSeconds(t.start);let s=this.timeStringToSeconds(t.thumbnail);s&&(s=Math.max(X.subtract(s,r),0));const i={...t,thumbnail:s};return i.tag||delete i.tag,delete i.useEditMode,B(i)},editMaterial(e,t){const r={};for(const s of this.editingProps)r[s]=t[s];return N(t.id,r)}}},te=e=>(q("data-v-a8a18faa"),e=e(),H(),e),re={class:"page"},ie={class:"label-style"},ae={key:0,class:"remarks"},oe={key:0,class:"remarks"},se=te(()=>y("span",null,".",-1)),ne={class:"screenshots-box"},le={class:"btn-box"},de=["src","onClick"],ue={class:"screenshots-video-box"},ce={class:"controls"},me={key:0,class:"tips"},pe=["src"];function fe(e,t,r,s,i,o){const n=f("PageHeader"),l=f("el-checkbox"),u=f("MediaBrowser"),S=f("el-time-picker"),c=f("el-input-number"),_=f("AsyncButtom"),h=f("EasyForm");return p(),V("div",re,[m(n),i.isInit?(p(),w(h,{key:0,modelValue:i.formData,"onUpdate:modelValue":t[0]||(t[0]=a=>i.formData=a),fields:i.fields,buttons:i.buttons,"form-config":i.formConfig},{label:d(a=>[y("div",ie,[a.formData.useEditMode&&!a.getPropValue(a.field.dontCheckEdit)?(p(),w(l,{key:0,"model-value":i.editingProps.includes(a.field.prop),"onUpdate:modelValue":v=>{v?i.editingProps.push(a.field.prop):i.editingProps.splice(i.editingProps.indexOf(a.field.prop),1)}},{default:d(()=>[a.getPropValue(a.field.required)?(p(),V("span",ae," * ")):b("",!0),g(" "+D(a.field.label),1)]),_:2},1032,["model-value","onUpdate:modelValue"])):(p(),V(R,{key:1},[a.getPropValue(a.field.required)?(p(),V("span",oe," * ")):b("",!0),g(" "+D(a.field.label),1)],64))])]),fileBrowser:d(a=>[m(u,{modelValue:a.formData[a.field.prop],"onUpdate:modelValue":v=>a.formData[a.field.prop]=v,checkMode:"single"},null,8,["modelValue","onUpdate:modelValue"])]),tsSelector:d(a=>[m(S,{"model-value":a.formData[a.field.prop].split(".")[0],"value-format":"HH:mm:ss",format:"HH:mm:ss",style:{width:"120px"},"onUpdate:modelValue":v=>{a.formData[a.field.prop]=`${v||"00:00:00"}.${a.formData[a.field.prop].split(".")[1]}`}},null,8,["model-value","onUpdate:modelValue"]),se,m(c,{"model-value":Number("0."+a.formData[a.field.prop].split(".")[1]),min:0,max:1,precision:3,step:.1,style:{width:"120px"},"onUpdate:modelValue":v=>{a.formData[a.field.prop]=`${a.formData[a.field.prop].split(".")[0]}.${String(v).split(".")[1]||0}`}},null,8,["model-value","step","onUpdate:modelValue"])]),screenshots:d(a=>[y("div",ne,[y("div",le,[m(_,{size:"mini",onLoadingClick:()=>o.setTimestring(a.field.prop,-60)},{default:d(()=>[g(" -1m ")]),_:2},1032,["onLoadingClick"]),m(_,{size:"mini",onLoadingClick:()=>o.setTimestring(a.field.prop,-10)},{default:d(()=>[g(" -10s ")]),_:2},1032,["onLoadingClick"]),m(_,{size:"mini",onLoadingClick:()=>o.setTimestring(a.field.prop,-1)},{default:d(()=>[g(" -1s ")]),_:2},1032,["onLoadingClick"]),m(_,{size:"mini",onLoadingClick:()=>o.setTimestring(a.field.prop,1)},{default:d(()=>[g(" +1s ")]),_:2},1032,["onLoadingClick"]),m(_,{size:"mini",onLoadingClick:()=>o.setTimestring(a.field.prop,10)},{default:d(()=>[g(" +10s ")]),_:2},1032,["onLoadingClick"]),m(_,{size:"mini",onLoadingClick:()=>o.setTimestring(a.field.prop,60)},{default:d(()=>[g(" +1m ")]),_:2},1032,["onLoadingClick"])]),i.screenshotsStore[a.field.prop]?(p(),V("img",{key:0,class:"image",src:i.screenshotsStore[a.field.prop],onClick:v=>e.$imagePreview(i.screenshotsStore[a.field.prop])},null,8,de)):b("",!0)])]),previewVideo:d(()=>[y("div",ue,[y("div",ce,[m(_,{type:"primary",onLoadingClick:()=>o.previewVideo()},{default:d(()=>[g(" 预览切片 ")]),_:1},8,["onLoadingClick"]),i.needUpdatePreviewVideoSrc?(p(),V("div",me," 需要更新预览 ")):b("",!0)]),i.previewVideoSrc?(p(),V("video",{key:0,class:"video",controls:"",preload:"none",src:i.previewVideoSrc},null,8,pe)):b("",!0)])]),_:1},8,["modelValue","fields","buttons","form-config"])):b("",!0)])}const ve=M(ee,[["render",fe],["__scopeId","data-v-a8a18faa"]]);export{ve as default};
