import{bB as L,aY as S,ch as x,aP as h,aQ as _,aR as m,bq as U,bT as O,bs as I,bt as P,bx as E,br as F,c8 as G,cs as K,b1 as Q,b5 as Y,b0 as J,aW as X,bn as Z,cF as ee,bw as te,bv as k,bp as T}from"./vendor-b440bceb.js";import{_ as W,S as z,a as ae,n as N,M as A,B as ne,u as oe,j as re,I as se}from"./index-f7418f35.js";import{M as le}from"./MarkDown-15a5cae4.js";import{I as ce}from"./ImageCon-a9e52930.js";import{x as ie,y as de,z as ue,A as me}from"./GreatOldOne-9d5782c0.js";import{j as he,b as fe}from"./element-plus-985aab11.js";const pe={components:{SvgIcon:z,ImageCon:ce},props:{init:{type:Boolean,default:!0},prefix:{type:[String,Array],default:"https://cdn.jsdelivr.net/gh/kooritea/kooritea.github.io/emoji/"}},emits:["select"],setup(o,{emit:r}){const{emoteHistory:d}=ae(),e=L({name:"history",emote:d.value}),t=L([]),p=S("history"),v=l=>{if(p.value=l.name,l.emote.length===0)return ie(l.name).then(c=>{p.value=l.name,l.emote=c.emote.map(H=>({...H,scope:l.name}))})},f=()=>{t.splice(0,t.length),t.push(e),de().then(l=>{t.push(...l.sort((c,H)=>{const M=d.value.findIndex(D=>D.scope===c.name),b=d.value.findIndex(D=>D.scope===H.name);return(M===-1?1/0:M)-(b===-1?1/0:b)})),t.push({name:"add",emote:[]})})};return f(),{onSelect:l=>{r("select",l),d.value=d.value.filter(c=>!(c.scope===l.scope&&c.name===l.name)),d.value=[l,...d.value].slice(0,30),e.emote=d.value},addEmotePackage:()=>{N({title:"导入表情包",message:"输入要添加的B站表情包ID",type:"info",confirmHandlerPromise:l=>ue(l.inputValue).then(()=>{A.success("添加成功"),f()}),inputValidator:l=>/^\d+$/.test(l),showInput:!0,inputErrorMessage:"请输入数字"})},currentScope:p,emotePackages:t,selectScope:v}}},ve={class:"emote-selector"},ge={class:"emotes"},ye={class:"scopes"},_e=["onClick"];function we(o,r,d,e,t,p){const v=x("ImageCon"),f=x("SvgIcon");return h(),_("div",ve,[m("div",ge,[(h(!0),_(U,null,O((e.emotePackages.find(a=>a.name===e.currentScope)||{}).emote||[],a=>(h(),I(v,{key:a.name,class:"emote",alt:a.name,src:`${a.scope}/${a.name}.png`,prefix:d.prefix,onClick:w=>e.onSelect(a)},{error:P(()=>[m("span",null,E(a.name),1)]),_:2},1032,["alt","src","prefix","onClick"]))),128))]),m("div",ye,[(h(!0),_(U,null,O(e.emotePackages,a=>(h(),_("div",{key:a.name,class:F(["scope",{"selected-scope":e.currentScope===a.name}]),onClick:()=>{a.name==="add"?e.addEmotePackage():e.selectScope(a)}},[a.name==="history"?(h(),I(f,{key:0,class:"emote history",name:"icon-time"})):a.name==="add"?(h(),I(f,{key:1,class:"emote history",name:"add"})):(h(),I(v,{key:2,class:"emote",src:`${a.name}/${a.name}.png`,prefix:d.prefix},{error:P(()=>[m("span",null,E(a.name),1)]),_:2},1032,["src","prefix"]))],10,_e))),128))])])}const be=W(pe,[["render",we],["__scopeId","data-v-db974307"]]);function xe(o){const r=S(null),d=G(he,{style:{width:"100%"},placeholder:"预约时间",type:"datetime",modelValue:r.value,"onUpdate:modelValue":e=>{var t;r.value=e,(t=d.component)!=null&&t.props&&(d.component.props.modelValue=e)}});N({title:"选择预约时间",message:d,confirmHandlerPromise:e=>o(r),inputValidator:e=>!!r.value,inputErrorMessage:"请选择预约时间"})}const V={},Se={components:{SvgIcon:z,Markdown:le,ButtonBox:ne,EmoteSelector:be,ElPopover:fe},props:{modelValue:{type:String,default:()=>""},title:{type:String,default:""},autoHeight:{type:Boolean,default:!0},cache:{type:[String,Boolean],default:""},onSubmit:{type:Function,default:()=>{}},showDefaultHandlers:{type:[Boolean,Array],default:()=>!0},exHandlers:{type:Array,default:()=>[]}},setup(o,{emit:r}){const{darkMode:d}=oe(),e=S(!0),{computedModelValue:t}=re(o,r),p=S(!1),v=S(null);if(o.cache){const n=K();if(V[n.fullPath]&&o.cache===!0)A.error("当前页面存在两个需要缓存的编辑器,需要为编辑器传入缓存唯一标识缓存功能才会工作！");else{const i="MDEditorCache."+(o.cache===!0?n.fullPath:`${n.fullPath}.${o.cache}`);t.value=localStorage.getItem(i);let s=null;Q(()=>{V[i]=!0,s=setInterval(()=>{p.value=!0,localStorage.setItem(i,t.value||"")},1e3)}),Y(()=>{V[i]=!1,clearInterval(s)}),J(t,()=>{p.value=!1})}}const f=n=>{const i=v.value.selectionStart,s=t.value.slice(0,i),g=t.value.slice(i);t.value=`${s}${n}${g}`},a=S(t.value),w=({reservationDate:n}={})=>{const i=o.onSubmit(t.value,n==null?void 0:n.value);return i instanceof Promise?i.then(()=>{t.value="",a.value=""}):(t.value="",a.value=""),i},l=()=>{t.value=""},c=()=>{t.value=a.value},H=[{name:"提交",type:"primary",handler:w,show:()=>Array.isArray(o.showDefaultHandlers)?o.showDefaultHandlers.includes("submit"):o.showDefaultHandlers,sort:10},{name:"预约",type:"primary",handler:()=>{xe(n=>{w({reservationDate:n})})},show:()=>Array.isArray(o.showDefaultHandlers)?o.showDefaultHandlers.includes("reservation"):o.showDefaultHandlers,sort:10},{name:"清除",type:"danger",handler:l,confirm:{message:"确认清空内容?"},show:()=>Array.isArray(o.showDefaultHandlers)?o.showDefaultHandlers.includes("clean"):o.showDefaultHandlers,sort:20},{name:"重置",type:"default",handler:c,show:()=>(Array.isArray(o.showDefaultHandlers)?o.showDefaultHandlers.includes("reset"):o.showDefaultHandlers)&&!!a.value,sort:30}],M=X(()=>[...H,...o.exHandlers]),b=n=>{const i=se(URL.createObjectURL(n),{handlers:[{name:"上传",type:"primary",handler:()=>{const s=new Date().valueOf().toString();f(`![${s}](--------------------)`),me(n,g=>{const y=Math.round(100*event.loaded/event.total)/10*2;t.value=t.value.replace(new RegExp(`\\!\\[${s}]\\((#*?)(-*?)\\)`),`![${s}](${"#".repeat(y)}${"-".repeat(20-y)})`)}).then(g=>{t.value=t.value.replace(new RegExp(`\\!\\[${s}]\\((#*?)(-*?)\\)`),`![${g.keyname}](${g.local})`)}).catch(()=>{t.value=t.value.replace(new RegExp(`\\!\\[${s}]\\((#*?)(-*?)\\)`),"")}),i.callClose()}},{name:"裁剪为16:9",type:"default",show:()=>{},handler:()=>{const s=document.createElement("canvas"),g=s.getContext("2d"),u=new Image;u.onload=async()=>{if(u.height*16===u.width*9)return;const y=u.height*16/9;if(y>u.width){const C=.5625*u.width;s.width=u.width,s.height=C,g.drawImage(u,0,(u.height-C)/2,u.width,C,0,0,u.width,C)}else s.width=y,s.height=u.height,g.drawImage(u,(u.width-y)/2,0,y,u.height,0,0,y,u.height);const R=s.toDataURL(n.type).split(","),q=R[0].match(/:(.*?);/)[1],$=atob(R[1]);let B=$.length;const j=new Uint8Array(B);for(;B--;)j[B]=$.charCodeAt(B);i.callClose(),b(new File([j],n.name,{type:q}))},u.src=URL.createObjectURL(n)}},{name:"取消",type:"default",handler:()=>{i.callClose()}}]})};return{darkMode:d,isEditMode:e,computedModelValue:t,resetCache:a,isSave:p,handlers:M,submitHandler:w,cleanHandler:l,resetHandler:c,previewImageBeforeUpload:b,pasteHandler:n=>{if(!(n.clipboardData&&n.clipboardData.items))return;const i=Array.from(n.clipboardData.items).filter(s=>s.kind==="file");if(i.length>0){n.preventDefault();for(const s of i)if(s.type.startsWith("image/")){b(s.getAsFile());return}else A.warning(`不支持的文件类型: ${s.type}`)}},dropHandler:n=>{for(const i of n.dataTransfer.files)if(n.preventDefault(),i.type.startsWith("image/")){b(i);return}else A.warning(`不支持的文件类型: ${i.type}`)},textarea:v,insertText:f}}},He={class:"md-editor"},ke={class:"fill"},Ie={key:1,class:"preview"},Ee={class:"bar"},Me={class:"bar-left"},De={class:"title"},Be={class:"uploader"},Ce={class:"bar-right"},Ae={key:0,class:"is-save info"};function Pe(o,r,d,e,t,p){const v=x("Markdown"),f=x("SvgIcon"),a=x("EmoteSelector"),w=x("el-popover"),l=x("ButtonBox");return h(),_(U,null,[m("div",He,[e.isEditMode?(h(),_("div",{key:0,class:F(["textarea-box",{"auto-height":d.autoHeight}])},[m("pre",ke,E(e.computedModelValue),1),Z(m("textarea",{ref:"textarea","onUpdate:modelValue":r[0]||(r[0]=c=>e.computedModelValue=c),class:"textarea",onPaste:r[1]||(r[1]=(...c)=>e.pasteHandler&&e.pasteHandler(...c)),onDragover:r[2]||(r[2]=te(()=>{},["prevent"])),onDrop:r[3]||(r[3]=(...c)=>e.dropHandler&&e.dropHandler(...c))},null,544),[[ee,e.computedModelValue]])],2)):(h(),_("div",Ie,[k(v,{"model-value":e.computedModelValue},null,8,["model-value"])])),m("div",Ee,[m("div",Me,[m("div",De,E(d.title),1),m("label",Be,[k(f,{class:"button",name:"14"}),m("input",{type:"file",accept:"image/*",onChange:r[4]||(r[4]=c=>{e.previewImageBeforeUpload(c.srcElement.files[0]),c.srcElement.value=""})},null,32)]),k(w,{width:"auto",trigger:"click",effect:e.darkMode?"dark":"light"},{reference:P(()=>[k(f,{class:"button",name:"biaoqing"})]),default:P(()=>[k(a,{onSelect:r[5]||(r[5]=c=>{e.insertText(`[emoji ${c.scope}/${c.name}]`)})})]),_:1},8,["effect"])]),m("div",Ce,[e.isSave?(h(),_("span",Ae,"已保存")):T("",!0),m("span",{class:"preview-switch button",onClick:r[6]||(r[6]=c=>e.isEditMode=!e.isEditMode)},E(e.isEditMode?"预览":"返回编辑"),1)])])]),e.handlers.length>0?(h(),I(l,{key:0,handlers:e.handlers},null,8,["handlers"])):T("",!0)],64)}const Ve=W(Se,[["render",Pe],["__scopeId","data-v-f18064c2"]]),Fe=Object.freeze(Object.defineProperty({__proto__:null,default:Ve},Symbol.toStringTag,{value:"Module"}));export{Ve as M,Fe as a,xe as u};
