import{P as V}from"./PageHeader-f5a76802.js";import{_ as y,L as k,Z as w,A as P,$ as L,a0 as D,M as T,a1 as M,a2 as U}from"./index-2b589533.js";import{cd as u,aR as m,bz as S,bY as B,bA as a,aT as h,bG as l,bD as g,bF as C,aS as b,bE as f}from"./vendor-5d98ec45.js";import"./element-plus-2fbd5573.js";import"./highlightjs-4914df6f.js";const x={components:{LoadingIcon:k},props:{modelValue:{type:[String,Array],default:void 0},checkMode:{type:String,default:()=>""}},emits:["update:modelValue"],data(){return{loading:!1,tableData:[],currentPath:"/"}},created(){this.load(this.currentPath)},methods:{onCellClick(e,o,t,s){o.property==="name"&&(e.type==="dir"?this.load(e.path):e.type==="file"&&this.$emit("update:modelValue",e.path))},onSelectionChange(){},load(e){this.loading=!0,this.loader(e).then(o=>{this.tableData=[...o].sort((t,s)=>{const r=t.type.localeCompare(s.type);return r!==0?r:t.name.localeCompare(s.name)}),e!=="/"&&this.tableData.unshift({type:"dir",name:"..",path:e.slice(0,e.slice(0,e.length-1).lastIndexOf("/"))||"/"}),this.currentPath=e}).finally(()=>{this.loading=!1})},loader(){throw new Error("loader需实现")}}};function I(e,o,t,s,r,i){const c=u("LoadingIcon"),p=u("el-table-column"),d=u("el-radio"),_=u("el-table");return m(),S(_,{border:"",data:r.tableData,style:{width:"100%"},onCellClick:i.onCellClick,onSelectionChange:i.onSelectionChange},B({default:a(()=>[t.checkMode==="multiple"?(m(),S(p,{key:0,type:"selection",selectable:n=>n.type==="file"},null,8,["selectable"])):g("",!0),t.checkMode==="single"?(m(),S(p,{key:1,width:"40px"},{default:a(n=>[n.row.path===t.modelValue?(m(),S(d,{key:0,value:n.row.path},null,8,["value"])):g("",!0)]),_:1})):g("",!0),l(p,{"class-name":"filename-cell","show-overflow-tooltip":"",prop:"name",label:"文件名"},{default:a(n=>[h("span",null,C(n.row.type==="dir"?"📁":"📄")+C(n.row.name),1)]),_:1})]),_:2},[r.loading?{name:"empty",fn:a(()=>[h("div",null,[l(c)])]),key:"0"}:void 0]),1032,["data","onCellClick","onSelectionChange"])}const O=y(x,[["render",I]]);const F={extends:O,props:{showAllFile:{type:Boolean,default(){return!1}}},methods:{loader(e){return w(e).then(o=>o.children.filter(t=>this.showAllFile||t.type==="dir"?!0:["mkv","mp4"].includes(t.extname)).map(t=>({name:t.name,type:t.type,path:t.path})))}}},R=y(F,[["__scopeId","data-v-ad7fef14"]]);const A={components:{PageHeader:V,AsyncButtom:P,MediaBrowser:R},data(){return{screenshotsStore:{},previewVideoSrc:"",needUpdatePreviewVideoSrc:!1,formConfig:{labelPosition:"top"},bangumiOptions:[],formData:{},fields:[{type:"select",prop:"bid",label:"Bangumi Id",formProps:{remote:!0,filterable:!0,remoteMethod:e=>{e&&L(e).then(o=>{this.bangumiOptions=o.map(t=>({label:t.name||t.nname,subLabel:t.nname,value:t.subject}))})}},options:()=>this.bangumiOptions,required:!0},{type:"number",prop:"ep",label:"集数",formProps:{min:1},defaultValue:()=>1,required:!0},{type:"slot",prop:"sourcePath",slotName:"fileBrowser",label:"文件",required:!0,onChange:(e,o,t)=>{this.needUpdatePreviewVideoSrc=!0}},{type:"time-picker",prop:"start",label:"开始时间",afterSlotName:"screenshots",buttons:[{type:"primary",label:"获取截图",handler:e=>this.getScreenshots(e.formData.sourcePath,e.field.prop)}],required:!0,defaultValue:()=>"00:00:00",onChange:(e,o,t)=>{this.needUpdatePreviewVideoSrc=!0}},{type:"time-picker",prop:"end",label:"结束时间",afterSlotName:"screenshots",buttons:[{type:"primary",label:"获取截图",handler:e=>this.getScreenshots(e.formData.sourcePath,e.field.prop)}],required:!0,defaultValue:()=>"00:00:00",onChange:(e,o,t)=>{this.needUpdatePreviewVideoSrc=!0},rules:e=>[{validator:(o,t,s)=>{const r=this.timeStringToSeconds(t),i=this.timeStringToSeconds(e.formData.start);r<i?s(`结束时间[${r}]不能小于开始时间[${i}]`):s()},trigger:"blur"}]},{type:"slot",slotName:"previewVideo",hiddenLabel:!0,showInForm:e=>!!e.formData.sourcePath&&!!e.formData.start&&!!e.formData.end},{type:"select",prop:"tag",valueSplitChar:",",formProps:{multiple:!0,filterable:!0,allowCreate:!0},optionsBaseCode:"VIDEO_TAG",label:"标签"},{type:"time-picker",prop:"thumbnail",afterSlotName:"screenshots",formProps:{multiple:!0},label:"封面",rules:e=>[{validator:(o,t,s)=>{const r=this.timeStringToSeconds(t),i=this.timeStringToSeconds(e.formData.start),c=this.timeStringToSeconds(e.formData.end);r===0?s():r<i?s(`封面时间[${r}]不能小于开始时间[${i}]`):r>c?s(`封面时间[${r}]不能大于结束时间[${c}]`):s()},trigger:"submit"}],buttons:[{type:"primary",label:"获取截图",handler:e=>this.getScreenshots(e.formData.sourcePath,e.field.prop)}],defaultValue:()=>"00:00:00"},{type:"number",prop:"previews",formProps:{multiple:!0},label:"预览图"}],buttons:[{type:"primary",label:"提交",handler:(e,o)=>e.formInstance.submitForm().then(t=>{const s=this.timeStringToSeconds(t.start);let r=this.timeStringToSeconds(t.thumbnail);return r&&(r=Math.max(r-s,0)),D({...t,thumbnail:r}).then(()=>{T.success("提交成功，等待渲染和批准"),e.formInstance.resetFormData(),this.screenshotsStore={}})})}]}},methods:{timeStringToSeconds(e){const o=e.split(":"),t=parseInt(o[0],10),s=parseInt(o[1],10),r=parseInt(o[2],10);return t*3600+s*60+r},secondsToTimeString(e){const o=Math.floor(e%1*1e3),t=Math.floor(e),s=Math.floor(t/3600),r=Math.floor(t%3600/60),i=t%60,c=String(s).padStart(2,"0"),p=String(r).padStart(2,"0"),d=String(i).padStart(2,"0"),_=o>0?"."+String(o).padStart(3,"0"):"";return`${c}:${p}:${d}${_}`},setTimestring(e,o){this.formData[e]=this.secondsToTimeString(this.timeStringToSeconds(this.formData[e])+o)},getScreenshots(e,o){return this.screenshotsStore[o]&&URL.revokeObjectURL(this.screenshotsStore[o]),M(e,this.formData[o]).then(t=>{this.screenshotsStore[o]=URL.createObjectURL(t)})},previewVideo(){return this.previewVideoSrc&&URL.revokeObjectURL(this.previewVideoSrc),this.needUpdatePreviewVideoSrc=!1,U({sourcePath:this.formData.sourcePath,start:this.formData.start,end:this.formData.end}).then(e=>{this.previewVideoSrc=URL.createObjectURL(e)})}}},N={class:"page"},z={class:"screenshots-box"},E=["src","onClick"],j={class:"screenshots-video-box"},q={class:"controls"},G={key:0,class:"tips"},H=["src"];function Y(e,o,t,s,r,i){const c=u("PageHeader"),p=u("MediaBrowser"),d=u("AsyncButtom"),_=u("EasyForm");return m(),b("div",N,[l(c),l(_,{modelValue:r.formData,"onUpdate:modelValue":o[0]||(o[0]=n=>r.formData=n),fields:r.fields,buttons:r.buttons,"form-config":r.formConfig},{fileBrowser:a(n=>[l(p,{modelValue:n.formData[n.field.prop],"onUpdate:modelValue":v=>n.formData[n.field.prop]=v,checkMode:"single"},null,8,["modelValue","onUpdate:modelValue"])]),screenshots:a(n=>[h("div",z,[h("div",null,[l(d,{size:"mini",onLoadingClick:()=>i.setTimestring(n.field.prop,-60)},{default:a(()=>[f(" -1m ")]),_:2},1032,["onLoadingClick"]),l(d,{size:"mini",onLoadingClick:()=>i.setTimestring(n.field.prop,-10)},{default:a(()=>[f(" -10s ")]),_:2},1032,["onLoadingClick"]),l(d,{size:"mini",onLoadingClick:()=>i.setTimestring(n.field.prop,-1)},{default:a(()=>[f(" -1s ")]),_:2},1032,["onLoadingClick"]),l(d,{size:"mini",onLoadingClick:()=>i.setTimestring(n.field.prop,1)},{default:a(()=>[f(" +1s ")]),_:2},1032,["onLoadingClick"]),l(d,{size:"mini",onLoadingClick:()=>i.setTimestring(n.field.prop,10)},{default:a(()=>[f(" +10s ")]),_:2},1032,["onLoadingClick"]),l(d,{size:"mini",onLoadingClick:()=>i.setTimestring(n.field.prop,60)},{default:a(()=>[f(" +1m ")]),_:2},1032,["onLoadingClick"])]),r.screenshotsStore[n.field.prop]?(m(),b("img",{key:0,class:"image",src:r.screenshotsStore[n.field.prop],onClick:v=>e.$imagePreview(r.screenshotsStore[n.field.prop])},null,8,E)):g("",!0)])]),previewVideo:a(()=>[h("div",j,[h("div",q,[l(d,{type:"primary",onLoadingClick:()=>i.previewVideo()},{default:a(()=>[f(" 预览切片 ")]),_:1},8,["onLoadingClick"]),r.needUpdatePreviewVideoSrc?(m(),b("div",G," 需要更新预览 ")):g("",!0)]),r.previewVideoSrc?(m(),b("video",{key:0,class:"video",controls:"",preload:"none",src:r.previewVideoSrc},null,8,H)):g("",!0)])]),_:1},8,["modelValue","fields","buttons","form-config"])])}const X=y(A,[["render",Y],["__scopeId","data-v-f7d14350"]]);export{X as default};
