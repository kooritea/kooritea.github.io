(function(){"use strict";function p(r){return Math.floor(r)===r}function m(r){var e={times:1,num:0};if(p(r))return e.num=r,e;var n=r+"",t=n.indexOf("."),a=n.substr(t+1).length,s=Math.pow(10,a),c=parseInt(r*s+.5,10);return e.times=s,e.num=c,e}function u(r,e,n){var t=m(r),a=m(e),s=t.num,c=a.num,o=t.times,f=a.times,g=o>f?o:f,i=null;switch(n){case"add":return o===f?i=s+c:o>f?i=s+c*(o/f):i=s*(f/o)+c,i/g;case"subtract":return o===f?i=s-c:o>f?i=s-c*(o/f):i=s*(f/o)-c,i/g;case"multiply":return i=s*c/(o*f),i;case"divide":return i=s/c*(f/o),i}}function v(r,e){if(typeof r!="number"||typeof e!="number")throw new Error("args error");return u(r,e,"add")}function y(r,e){if(typeof r!="number"||typeof e!="number")throw new Error("args error");return u(r,e,"subtract")}function b(r,e){if(typeof r!="number"||typeof e!="number")throw new Error("args error");return u(r,e,"multiply")}function P(r,e){if(typeof r!="number"||typeof e!="number")throw new Error("args error");return u(r,e,"divide")}var l={add:v,subtract:y,multiply:b,divide:P};function w(r,e,n={}){let t;for(let a=Math.max(1,n.startSearchSize??1);a<=(n.maxSearchSize||r.height);a++){const s=M(r,e,a,n);if(t)t.matchPerc<s.matchPerc&&(t={...s,offset:a});else{t={...s,offset:a};continue}}return t}function M(r,e,n,t={}){const a=[];for(let c=0;c<n;c++)if(t.sort==="desc"){const o=r.colorData[e.colorData.length-n+c],f=e.colorData[c];a.push(d(o,f,t))}else{const o=r.colorData[c],f=e.colorData[e.colorData.length-n+c];a.push(d(o,f,t))}const{matchPerc:s}=h(a);return self.postMessage({code:"progress",data:Number((t._progressCompleteLine/t._progressAllLine*100).toFixed(2))}),{areaDiffResult:a,matchPerc:s}}function d(r,e,n={}){const t=r.map((s,c)=>D(r[c],e[c],n)),{matchPerc:a}=h(t);return n._progressCompleteLine++,{lineDiffResult:t,matchPerc:a}}function D(r,e,n={pointDiffType:"gray"}){if(n.pointDiffType==="rgb"){const t=(r[0]+e[0])/2,a=r[0]-e[0],s=r[1]-e[1],c=r[2]-e[2],o=Math.sqrt((2+t/256)*a**2+4*s**2+(2+(255-t)/256)*c**2);return{colorDistance:o,matchPerc:l.subtract(100,Number((o/764*100).toFixed(2)))}}if(n.pointDiffType==="gray")return{matchPerc:l.subtract(100,Number((Math.abs(r[4]-e[4])/255*100).toFixed()))};if(n.pointDiffType==="otsu")return{point1:r,point2:e,matchPerc:r[5]===e[5]?100:0}}function h(r){const e=r.reduce((n,t)=>l.add(n,t.matchPerc),0);return{matchPerc:Number((e/(100*r.length)*100).toFixed(2))}}self.addEventListener("message",function(r){const e=r.data;switch(e.cmd){case"getMaxMatchOffset":{const n=e.data.options;n._progressCompleteLine=0;const t=e.data.image1[n.direction==="vertical"?"height":"width"],a=t*(1+t)/2;n._progressAllLine=a,self.postMessage({code:"result",data:w(e.data.image1,e.data.image2,n)});break}default:self.postMessage({code:"Unknow Cmd: "+e.cmd})}},!1)})();
