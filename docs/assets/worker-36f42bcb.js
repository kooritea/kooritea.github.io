(function(){"use strict";function y(e){return Math.floor(e)===e}function m(e){var t={times:1,num:0};if(y(e))return t.num=e,t;var r=e+"",c=r.indexOf("."),f=r.substr(c+1).length,s=Math.pow(10,f),a=parseInt(e*s+.5,10);return t.times=s,t.num=a,t}function d(e,t,r){var c=m(e),f=m(t),s=c.num,a=f.num,n=c.times,i=f.times,l=n>i?n:i,o=null;switch(r){case"add":return n===i?o=s+a:n>i?o=s+a*(n/i):o=s*(i/n)+a,o/l;case"subtract":return n===i?o=s-a:n>i?o=s-a*(n/i):o=s*(i/n)-a,o/l;case"multiply":return o=s*a/(n*i),o;case"divide":return o=s/a*(i/n),o}}function w(e,t){if(typeof e!="number"||typeof t!="number")throw new Error("args error");return d(e,t,"add")}function D(e,t){if(typeof e!="number"||typeof t!="number")throw new Error("args error");return d(e,t,"subtract")}function P(e,t){if(typeof e!="number"||typeof t!="number")throw new Error("args error");return d(e,t,"multiply")}function b(e,t){if(typeof e!="number"||typeof t!="number")throw new Error("args error");return d(e,t,"divide")}var h={add:w,subtract:D,multiply:P,divide:b};let g=0;function M(e,t,r={}){let c;const f=r.direction==="vertical"?"height":"width";for(let s=Math.max(1,r.startSearchSize??1);s<=(r.maxSearchSize||Math.min(e[f],t[f]));s++){const a=x(e,t,s,r);if(c)c.matchPerc<a.matchPerc&&(c={...a,offset:s});else{c={...a,offset:s};continue}const n=Date.now();n>g+1e3&&(g=n,self.postMessage({code:"progress",data:r._progressCompleteLine}),r._progressCompleteLine=0)}return c}function x(e,t,r,c={}){const f=[];for(let a=0;a<r;a++)if(c.direction==="vertical"){let n=0,i=0;c.sort==="desc"?(n=e.width*(e.height-r+a),i=t.width*a):(n=e.width*a,i=t.width*(t.height-r+a));const l=[],o=[];for(let u=0;u<e.width;u++)l.push([e.imageData[(n+u)*4],e.imageData[(n+u)*4+1],e.imageData[(n+u)*4+2],e.imageData[(n+u)*4+3]]),o.push([t.imageData[(i+u)*4],t.imageData[(i+u)*4+1],t.imageData[(i+u)*4+2],t.imageData[(i+u)*4+3]]);f.push(S(l,o,c))}const{matchPerc:s}=v(f);return{matchPerc:s}}function S(e,t,r={}){const c=e.map((s,a)=>L(e[a],t[a],r)),{matchPerc:f}=v(c);return r._progressCompleteLine++,{matchPerc:f}}function p(e,t,r){return e*6966+t*23436+r*2366>>15}function L(e,t,r={pointDiffType:"gray"}){if(r.pointDiffType==="rgb"){const c=(e[0]+t[0])/2,f=e[0]-t[0],s=e[1]-t[1],a=e[2]-t[2],n=Math.sqrt((2+c/256)*f**2+4*s**2+(2+(255-c)/256)*a**2);return{colorDistance:n,matchPerc:h.subtract(100,Number((n/764*100).toFixed(2)))}}if(r.pointDiffType==="gray"){const c=p(...e),f=p(...t);return{matchPerc:h.subtract(100,Number((Math.abs(c-f)/255*100).toFixed()))}}if(r.pointDiffType==="otsu")return{matchPerc:e[4]===t[4]?100:0}}function v(e){const t=e.reduce((r,c)=>h.add(r,c.matchPerc),0);return{matchPerc:Number((t/(100*e.length)*100).toFixed(2))}}self.addEventListener("message",function(e){const t=e.data;switch(t.cmd){case"getMaxMatchOffset":{const r=t.data.options;r._progressCompleteLine=0,self.postMessage({code:"result",data:M(t.data.image1,t.data.image2,r)});break}default:self.postMessage({code:"Unknow Cmd: "+t.cmd})}},!1)})();
