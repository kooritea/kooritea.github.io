import{P as L}from"./PageHeader-1cb740de.js";import{I as C}from"./ImageCon-2a7f08d7.js";import{f as b}from"./float-54846448.js";import{_ as F,a8 as M}from"./index-31ec5523.js";import{cg as d,aR as $,aS as k,bD as m,bx as R,aT as _,cY as A,cZ as O}from"./vendor-cce75f21.js";import"./element-plus-40a28a03.js";import"./highlightjs-4914df6f.js";const B=(n,t)=>n.reduce((e,s)=>(e[t.indexOf(s)]+=1,e),[...Array(t.length)].fill(0)),D=(n,t,e)=>{let s=0;for(let c=t;c<e;c+=1)s+=n[c];return s},q=n=>Array.from(new Set(n)).sort((t,e)=>t-e),x=(n,t,e,s)=>{let c=0;for(let a=t;a<e;a+=1)c+=n[a];return c/s},P=(n,t,e,s,c)=>{let a=0;for(let r=e;r<s;r+=1)a+=n[r]*t[r];return a*c},I=(n,t,e,s,c,a)=>{let r=0;for(let o=e;o<s;o+=1){const l=t[o]-c;r+=l*l*n[o]}return r*a},E=(n,t,e,s)=>n*t+e*s;function U(n){const t=n.map(r=>r.map(o=>o[4]).flat(1)).flat(1),e=q(t),s=B(t,e),{length:c}=t,a=[...Array(e.length)].map((r,o)=>{const i=o,u=o,h=s.length,g=1/D(s,0,i),f=1/D(s,u,h),v=x(s,0,i,c),y=I(s,e,0,i,P(s,e,0,i,g),g),N=x(s,u,h,c),V=I(s,e,u,h,P(s,e,u,h,f),f),w=E(v,y,N,V);return isNaN(w)?Number.POSITIVE_INFINITY:w});return e[a.indexOf(Math.min(...a))]}function z(n,t,e){return n*6966+t*23436+e*2366>>15}async function G(n,t="vertical"){return new Promise((e,s)=>{const c=document.createElement("canvas"),a=c.getContext("2d"),r=new Image;r.onload=async()=>{c.width=r.width,c.height=r.height,a.drawImage(r,0,0,r.width,r.height,0,0,r.width,r.height);const o=t==="vertical",l=a.getImageData(0,0,r.width,r.height),i=[];let u=-1,h=-1;for(let f=0;f<l.data.length;){u++,(i.length===0||i[i.length-1].length===r[o?"width":"height"])&&(i.push([]),h++,u=-1);const v=i[i.length-1],y=z(l.data[f],l.data[f+1],l.data[f+2]);v.push([l.data[f],l.data[f+1],l.data[f+2],l.data[f+3],y,"",[u,h]]),f+=4}const g=U(i);for(const f in i)for(u in i[f])i[f][u][5]=g>i[f][u][4]?"rgba(0,0,0,255)":"rgba(255,255,255,255)";e({height:r.height,width:r.width,otsuThresholdValue:g,colorData:i})},r.src=n instanceof File?URL.createObjectURL(n):n})}function T(n){const t=n.reduce((e,s)=>b.add(e,s.matchPerc),0);return{matchPerc:Number((t/(100*n.length)*100).toFixed(2))}}function H(n,t,e={pointDiffType:"gray"}){if(e.pointDiffType==="rgb"){const s=(n[0]+t[0])/2,c=n[0]-t[0],a=n[1]-t[1],r=n[2]-t[2],o=Math.sqrt((2+s/256)*c**2+4*a**2+(2+(255-s)/256)*r**2);return{colorDistance:o,matchPerc:b.subtract(100,Number((o/764*100).toFixed(2)))}}if(e.pointDiffType==="gray")return{matchPerc:b.subtract(100,Number((Math.abs(n[4]-t[4])/255*100).toFixed()))};if(e.pointDiffType==="otsu")return{point1:n,point2:t,matchPerc:n[5]===t[5]?100:0}}function S(n,t,e={}){const s=n.map((a,r)=>H(n[r],t[r],e)),{matchPerc:c}=T(s);return e._progressCompleteLine++,{lineDiffResult:s,matchPerc:c}}async function j(n,t,e,s={}){return new Promise(c=>{setTimeout(()=>{const a=[];for(let o=0;o<e;o++)if(s.sort==="desc"){const l=n.colorData[t.colorData.length-e+o],i=t.colorData[o];a.push(S(l,i,s))}else{const l=n.colorData[o],i=t.colorData[t.colorData.length-e+o];a.push(S(l,i,s))}const{matchPerc:r}=T(a);s.progress&&s.progress(s._progressCompleteLine,s._progressAllLine),c({areaDiffResult:a,matchPerc:r})})})}async function Y(n,t,e={}){let s;for(let c=Math.max(1,e.startSearchSize??1);c<=(e.maxSearchSize||n.height);c++){const a=await j(n,t,c,e);if(s)s.matchPerc<a.matchPerc&&(s={...a,offset:c});else{s={...a,offset:c};continue}}return s}function p(n,t,e,s={}){for(const c in t){const a=t[c];for(const r in a){const o=a[r];s.thresholdValue!==void 0?n.fillStyle=s.thresholdValue>o[4]?"rgba(0,0,0,255)":"rgba(255,255,255,255)":n.fillStyle=`rgba(${o[0]},${o[1]},${o[2]},${o[3]})`,n.fillRect(r,e+Number(c),1,1)}}}async function Z(n,t={}){t={...t,direction:t.direction??"vertical",pointDiffType:t.pointDiffType??"gray",sort:t.sort??"desc",skipLine:t.skipLine??10};const e=await Promise.all(n.map(c=>G(c,t.direction)));t._progressCompleteLine=0,t._progressAllLine=(()=>{const c=e[0][t.direction==="vertical"?"height":"width"];return c*(1+c)/2*(e.length-1)})();const s=(await Promise.all(e.slice(0,e.length-1).map((c,a)=>Y(e[a],e[a+1],t)))).map(c=>c.offset);if(t.canvas){const c=t.canvas.getContext("2d");if(t.direction==="vertical"?(t.canvas.width=e[0].width,t.canvas.height=e.reduce((a,r)=>a+r.height,0)-s.reduce((a,r)=>a+r,0)):(t.canvas.width=e.reduce((a,r)=>a+r.width,0)-s.reduce((a,r)=>a+r,0),t.canvas.height=e[0].height),t.sort==="desc"){let a=0;for(let r=0;r<s.length;r++){const o=s[r];r===0&&(p(c,e[r].colorData,a),a=a+e[r].height),p(c,e[r+1].colorData.slice(o-t.skipLine),a-t.skipLine),a=a+e[r+1].height-o}}else{let a=t.canvas.height;for(let r=0;r<s.length;r++){const o=s[r];r===0&&(a=a-e[r].height,p(c,e[r].colorData,a)),a=a-e[r+1].height+o,p(c,e[r+1].colorData.slice(0,e[r+1].colorData.length-o+t.skipLine),a)}}}}const J={components:{PageHeader:L,ImageCon:C},data(){return{progress:0,progressStatus:"",formConfig:{labelPosition:"top"},formData:{},fields:[{type:"radio",prop:"pointDiffType",label:"对比方法",required:!0,defaultValue:()=>"gray",options:()=>[{label:"灰度值(推荐，兼顾速度和准确性)",value:"gray"},{label:"色差(速度较慢)",value:"rgb"}]},{type:"radio",prop:"direction",label:"截图方向",afterSlotName:"direction-example",required:!0,defaultValue:()=>"vertical-desc",options:[{label:"从上到下",value:"vertical-desc"},{label:"从下到上",value:"vertical-asc"},{label:"从左到右(开发中)",value:"horizontal-desc",disabled:!0},{label:"从右到左(开发中)",value:"horizontal-asc",disabled:!0}]},{type:"upload",prop:"images",label:"截图",required:!0,formProps:{listType:"picture-card"},defaultValue:()=>[],rules:[{required:!0,trigger:"submit",validator:(n,t,e)=>{t.length>1?e():e("最少需要两张截图")}}]}],buttons:[{type:"primary",label:"合成",handler:(n,t)=>n.formInstance.submitForm().then(e=>{const[s,c]=e.direction.split("-");return this.progress=0,this.progressStatus="",this.$refs.result.width=0,this.$refs.result.height=0,Z(e.images.map(a=>a.raw),{direction:s,pointDiffType:e.pointDiffType,sort:c,canvas:this.$refs.result,progress:(a,r)=>{this.progress=Number((a/r*100).toFixed(2))}}).then(()=>{this.progressStatus="success"}).catch(a=>{throw this.progressStatus="exception",a})})},{type:"success",label:"下载",show:()=>this.progressStatus==="success",handler:(n,t)=>new Promise(e=>{this.$refs.result.toBlob(c=>{M(c,`${this.getMergeFileName(this.formData.images.map(a=>a.raw))}.png`),e()})})}]}},methods:{getMergeFileName(n){let t="";for(let e=0;e<n[0].name.length&&!n.some(s=>s.name[e]!==n[0].name[e]);e++)t+=n[0].name[e];return`${t}${["-","_"].includes(t[t.length-1])?"":"-"}merge`}}},K=n=>(A("data-v-0ac3ca27"),n=n(),O(),n),Q={class:"page"},W={class:"direction-example"},X=K(()=>_("span",null,"示例：",-1)),ee={style:{"margin-top":"24px"}},te={ref:"result",style:{width:"100%","margin-top":"24px"}};function re(n,t,e,s,c,a){const r=d("PageHeader"),o=d("ImageCon"),l=d("EasyForm"),i=d("el-progress");return $(),k("div",Q,[m(r),m(l,{modelValue:c.formData,"onUpdate:modelValue":t[0]||(t[0]=u=>c.formData=u),fields:c.fields,buttons:c.buttons,"form-config":c.formConfig},{"direction-example":R(u=>[_("div",W,[X,m(o,{src:`/assets/image-merge-${u.formData[u.field.prop]}-example.png`},null,8,["src"])])]),_:1},8,["modelValue","fields","buttons","form-config"]),_("div",ee,[m(i,{percentage:c.progress,"text-inside":!0,"stroke-width":24,status:c.progressStatus},null,8,["percentage","status"]),_("canvas",te,null,512)])])}const ue=F(J,[["render",re],["__scopeId","data-v-0ac3ca27"]]);export{ue as default};
